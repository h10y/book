<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Containerizing Shiny Apps | Hosting Shiny Applications for R and Python</title>
  <meta name="description" content="Everything you wanted to know about hosting Shiny apps." />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Containerizing Shiny Apps | Hosting Shiny Applications for R and Python" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="https://hostingshiny.com//images/logos/book_cover.jpg" />
  <meta property="og:description" content="Everything you wanted to know about hosting Shiny apps." />
  <meta name="github-repo" content="analythium/hosting-shiny-book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Containerizing Shiny Apps | Hosting Shiny Applications for R and Python" />
  <meta name="twitter:site" content="@analythium" />
  <meta name="twitter:description" content="Everything you wanted to know about hosting Shiny apps." />
  <meta name="twitter:image" content="https://hostingshiny.com//images/logos/book_cover.jpg" />

<meta name="author" content="Péter Sólymos and Kalvin Eng" />


<meta name="date" content="2024-07-31" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="images/logos/favicons/apple-touch-icon.png" />
  <link rel="shortcut icon" href="images/logos/favicons/favicon.ico" type="image/x-icon" />
<link rel="prev" href="5-part2-developing-shiny-apps.html"/>
<link rel="next" href="references.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/core-js-2.5.3/shim.min.js"></script>
<script src="libs/react-18.2.0/react.min.js"></script>
<script src="libs/react-18.2.0/react-dom.min.js"></script>
<script src="libs/reactwidget-2.0.0/react-tools.umd.cjs"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/reactable-0.4.4/reactable.css" rel="stylesheet" />
<script src="libs/reactable-binding-0.4.4/reactable.js"></script>
<script src="https://cdn.usefathom.com/script.js" data-site="PASYTARS" defer></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="foreword.html"><a href="foreword.html"><i class="fa fa-check"></i>Foreword</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#motivation"><i class="fa fa-check"></i>Motivation</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#who-is-this-book-for"><i class="fa fa-check"></i>Who Is This Book For?</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#what-will-you-learn"><i class="fa fa-check"></i>What Will You Learn?</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#what-will-you-not-learn"><i class="fa fa-check"></i>What Will You Not Learn?</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#conventions"><i class="fa fa-check"></i>Conventions</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#about-the-authors"><i class="fa fa-check"></i>About the Authors</a></li>
<li class="chapter" data-level="" data-path="preface.html"><a href="preface.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
</ul></li>
<li class="part"><span><b>I Getting Started</b></span></li>
<li class="chapter" data-level="1" data-path="1-part1-background.html"><a href="1-part1-background.html"><i class="fa fa-check"></i><b>1</b> Background</a>
<ul>
<li class="chapter" data-level="1.1" data-path="1-part1-background.html"><a href="1-part1-background.html#part1-data-intensive-apps"><i class="fa fa-check"></i><b>1.1</b> Data-intensive Apps</a></li>
<li class="chapter" data-level="1.2" data-path="1-part1-background.html"><a href="1-part1-background.html#part1-enter-shiny"><i class="fa fa-check"></i><b>1.2</b> Enter Shiny</a></li>
<li class="chapter" data-level="1.3" data-path="1-part1-background.html"><a href="1-part1-background.html#part1-application-development"><i class="fa fa-check"></i><b>1.3</b> Application Development</a></li>
<li class="chapter" data-level="1.4" data-path="1-part1-background.html"><a href="1-part1-background.html#part1-application-hosting"><i class="fa fa-check"></i><b>1.4</b> Application Hosting</a></li>
<li class="chapter" data-level="1.5" data-path="1-part1-background.html"><a href="1-part1-background.html#part1-devops-cycle"><i class="fa fa-check"></i><b>1.5</b> The DevOps Cycle</a></li>
<li class="chapter" data-level="1.6" data-path="1-part1-background.html"><a href="1-part1-background.html#part1-hosting-cycle"><i class="fa fa-check"></i><b>1.6</b> The Hosting Cycle</a></li>
<li class="chapter" data-level="1.7" data-path="1-part1-background.html"><a href="1-part1-background.html#summary"><i class="fa fa-check"></i><b>1.7</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="2-part1-hosting-concepts.html"><a href="2-part1-hosting-concepts.html"><i class="fa fa-check"></i><b>2</b> Hosting Concepts</a>
<ul>
<li class="chapter" data-level="2.1" data-path="2-part1-hosting-concepts.html"><a href="2-part1-hosting-concepts.html#part1-domains-and-networking"><i class="fa fa-check"></i><b>2.1</b> Domains and Networking</a></li>
<li class="chapter" data-level="2.2" data-path="2-part1-hosting-concepts.html"><a href="2-part1-hosting-concepts.html#part1-web-technologies"><i class="fa fa-check"></i><b>2.2</b> Website Technologies</a></li>
<li class="chapter" data-level="2.3" data-path="2-part1-hosting-concepts.html"><a href="2-part1-hosting-concepts.html#part1-servers"><i class="fa fa-check"></i><b>2.3</b> Servers</a></li>
<li class="chapter" data-level="2.4" data-path="2-part1-hosting-concepts.html"><a href="2-part1-hosting-concepts.html#part1-hosting-environments"><i class="fa fa-check"></i><b>2.4</b> Hosting Environments</a></li>
<li class="chapter" data-level="2.5" data-path="2-part1-hosting-concepts.html"><a href="2-part1-hosting-concepts.html#summary-1"><i class="fa fa-check"></i><b>2.5</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html"><i class="fa fa-check"></i><b>3</b> Local Setup</a>
<ul>
<li class="chapter" data-level="3.1" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#installing-your-developer-tools"><i class="fa fa-check"></i><b>3.1</b> Installing Your Developer Tools</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#part1-installing-r"><i class="fa fa-check"></i><b>3.1.1</b> R</a></li>
<li class="chapter" data-level="3.1.2" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#part1-installing-python"><i class="fa fa-check"></i><b>3.1.2</b> Python</a></li>
<li class="chapter" data-level="3.1.3" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#part1-web-browser"><i class="fa fa-check"></i><b>3.1.3</b> Web Browser</a></li>
<li class="chapter" data-level="3.1.4" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#part1-installing-quarto"><i class="fa fa-check"></i><b>3.1.4</b> Quarto</a></li>
<li class="chapter" data-level="3.1.5" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#part1-installing-docker"><i class="fa fa-check"></i><b>3.1.5</b> Docker Desktop</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#part1-command-line"><i class="fa fa-check"></i><b>3.2</b> The Command Line</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#navigation"><i class="fa fa-check"></i><b>3.2.1</b> Navigation</a></li>
<li class="chapter" data-level="3.2.2" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#editing-files"><i class="fa fa-check"></i><b>3.2.2</b> Editing Files</a></li>
<li class="chapter" data-level="3.2.3" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#file-and-directory-operations"><i class="fa fa-check"></i><b>3.2.3</b> File and Directory Operations</a></li>
<li class="chapter" data-level="3.2.4" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#part1-super-user"><i class="fa fa-check"></i><b>3.2.4</b> Super User Access</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#part1-scm-git"><i class="fa fa-check"></i><b>3.3</b> Source Code Management with Git</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#git-services"><i class="fa fa-check"></i><b>3.3.1</b> Git Services</a></li>
<li class="chapter" data-level="3.3.2" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#git-commands"><i class="fa fa-check"></i><b>3.3.2</b> Git Commands</a></li>
<li class="chapter" data-level="3.3.3" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#gitignore"><i class="fa fa-check"></i><b>3.3.3</b> .gitignore</a></li>
<li class="chapter" data-level="3.3.4" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#branching"><i class="fa fa-check"></i><b>3.3.4</b> Branching</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#part1-working-with-servers"><i class="fa fa-check"></i><b>3.4</b> Working with Servers</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#part1-ssh"><i class="fa fa-check"></i><b>3.4.1</b> Secure Shell (SSH)</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#readability-on-the-command-line"><i class="fa fa-check"></i><b>3.5</b> Readability on the Command Line</a></li>
<li class="chapter" data-level="3.6" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#other-useful-tools"><i class="fa fa-check"></i><b>3.6</b> Other Useful Tools</a></li>
<li class="chapter" data-level="3.7" data-path="3-part1-local-setup.html"><a href="3-part1-local-setup.html#summary-2"><i class="fa fa-check"></i><b>3.7</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="4-part1-examples.html"><a href="4-part1-examples.html"><i class="fa fa-check"></i><b>4</b> Examples</a>
<ul>
<li class="chapter" data-level="4.1" data-path="4-part1-examples.html"><a href="4-part1-examples.html#part1-example-faithful"><i class="fa fa-check"></i><b>4.1</b> Old Faithful</a></li>
<li class="chapter" data-level="4.2" data-path="4-part1-examples.html"><a href="4-part1-examples.html#part1-example-bananas"><i class="fa fa-check"></i><b>4.2</b> Bananas</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="4-part1-examples.html"><a href="4-part1-examples.html#part1-example-bananas-data"><i class="fa fa-check"></i><b>4.2.1</b> The Bananas Data Set</a></li>
<li class="chapter" data-level="4.2.2" data-path="4-part1-examples.html"><a href="4-part1-examples.html#part1-example-bananas-model"><i class="fa fa-check"></i><b>4.2.2</b> Model Training</a></li>
<li class="chapter" data-level="4.2.3" data-path="4-part1-examples.html"><a href="4-part1-examples.html#part1-example-bananas-app"><i class="fa fa-check"></i><b>4.2.3</b> The Shiny App</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="4-part1-examples.html"><a href="4-part1-examples.html#part1-example-lbtest"><i class="fa fa-check"></i><b>4.3</b> Load Balancing Test</a></li>
<li class="chapter" data-level="4.4" data-path="4-part1-examples.html"><a href="4-part1-examples.html#summary-3"><i class="fa fa-check"></i><b>4.4</b> Summary</a></li>
</ul></li>
<li class="part"><span><b>II Shiny Apps</b></span></li>
<li class="chapter" data-level="5" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html"><i class="fa fa-check"></i><b>5</b> Developing Shiny Apps</a>
<ul>
<li class="chapter" data-level="5.1" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-creating-a-shiny-app"><i class="fa fa-check"></i><b>5.1</b> Creating a Shiny App</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-ui"><i class="fa fa-check"></i><b>5.1.1</b> The User Interface</a></li>
<li class="chapter" data-level="5.1.2" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-server-function"><i class="fa fa-check"></i><b>5.1.2</b> The Server Function</a></li>
<li class="chapter" data-level="5.1.3" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-shiny-express"><i class="fa fa-check"></i><b>5.1.3</b> Shiny Express</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-organizing-shiny-apps"><i class="fa fa-check"></i><b>5.2</b> Organizing Shiny Apps</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-organizing-shiny-single-file"><i class="fa fa-check"></i><b>5.2.1</b> Single file</a></li>
<li class="chapter" data-level="5.2.2" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-organizing-shiny-multiple-files"><i class="fa fa-check"></i><b>5.2.2</b> Multiple Files</a></li>
<li class="chapter" data-level="5.2.3" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-organizing-shiny-rhino"><i class="fa fa-check"></i><b>5.2.3</b> Shiny App with Nested File Structure</a></li>
<li class="chapter" data-level="5.2.4" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-organizing-shiny-programmatic-cases"><i class="fa fa-check"></i><b>5.2.4</b> Programmatic Cases</a></li>
<li class="chapter" data-level="5.2.5" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-organizing-shiny-r-package"><i class="fa fa-check"></i><b>5.2.5</b> Shiny App as an R Package</a></li>
<li class="chapter" data-level="5.2.6" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-dynamic-documents"><i class="fa fa-check"></i><b>5.2.6</b> Dynamic Documents</a></li>
<li class="chapter" data-level="5.2.7" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-shinylive"><i class="fa fa-check"></i><b>5.2.7</b> Shinylive</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-run-shiny-locally"><i class="fa fa-check"></i><b>5.3</b> Running Shiny Apps Locally</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#r"><i class="fa fa-check"></i><b>5.3.1</b> R</a></li>
<li class="chapter" data-level="5.3.2" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#python"><i class="fa fa-check"></i><b>5.3.2</b> Python</a></li>
<li class="chapter" data-level="5.3.3" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-shiny-lifecycle"><i class="fa fa-check"></i><b>5.3.3</b> The Shiny App Lifecycle</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#part2-sharing-shiny-code"><i class="fa fa-check"></i><b>5.4</b> Sharing the Shiny App Code</a></li>
<li class="chapter" data-level="5.5" data-path="5-part2-developing-shiny-apps.html"><a href="5-part2-developing-shiny-apps.html#summary-4"><i class="fa fa-check"></i><b>5.5</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html"><i class="fa fa-check"></i><b>6</b> Containerizing Shiny Apps</a>
<ul>
<li class="chapter" data-level="6.1" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-concepts"><i class="fa fa-check"></i><b>6.1</b> Docker Concepts</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-engine"><i class="fa fa-check"></i><b>6.1.1</b> Docker Engine</a></li>
<li class="chapter" data-level="6.1.2" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-container-registries"><i class="fa fa-check"></i><b>6.1.2</b> Container Registries</a></li>
<li class="chapter" data-level="6.1.3" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-images"><i class="fa fa-check"></i><b>6.1.3</b> Images</a></li>
<li class="chapter" data-level="6.1.4" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-the-dockerfile"><i class="fa fa-check"></i><b>6.1.4</b> The Dockerfile</a></li>
<li class="chapter" data-level="6.1.5" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-containers"><i class="fa fa-check"></i><b>6.1.5</b> Containers</a></li>
<li class="chapter" data-level="6.1.6" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-cli"><i class="fa fa-check"></i><b>6.1.6</b> The Docker Command Line</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-existing-images"><i class="fa fa-check"></i><b>6.2</b> Working with Existing Images</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-image-names-tags"><i class="fa fa-check"></i><b>6.2.1</b> Image Names and Tags</a></li>
<li class="chapter" data-level="6.2.2" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-pull"><i class="fa fa-check"></i><b>6.2.2</b> Pulling an Image</a></li>
<li class="chapter" data-level="6.2.3" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-login"><i class="fa fa-check"></i><b>6.2.3</b> Docker Login</a></li>
<li class="chapter" data-level="6.2.4" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-run"><i class="fa fa-check"></i><b>6.2.4</b> Running a Container</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-build"><i class="fa fa-check"></i><b>6.3</b> Building a New Image</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-r-shiny"><i class="fa fa-check"></i><b>6.3.1</b> R for Shiny</a></li>
<li class="chapter" data-level="6.3.2" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-buildx-buildkit"><i class="fa fa-check"></i><b>6.3.2</b> Buildx and BuildKit</a></li>
<li class="chapter" data-level="6.3.3" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-inspect"><i class="fa fa-check"></i><b>6.3.3</b> Inspecting the Image</a></li>
<li class="chapter" data-level="6.3.4" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-python-shiny"><i class="fa fa-check"></i><b>6.3.4</b> Python for Shiny</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-managing-images"><i class="fa fa-check"></i><b>6.4</b> Managing Images</a></li>
<li class="chapter" data-level="6.5" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-sharing-images"><i class="fa fa-check"></i><b>6.5</b> Sharing Images</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-push"><i class="fa fa-check"></i><b>6.5.1</b> Pushing Images</a></li>
<li class="chapter" data-level="6.5.2" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-registries"><i class="fa fa-check"></i><b>6.5.2</b> Docker Registries</a></li>
<li class="chapter" data-level="6.5.3" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-registry-login"><i class="fa fa-check"></i><b>6.5.3</b> Log In to a Registry</a></li>
<li class="chapter" data-level="6.5.4" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-registry-local"><i class="fa fa-check"></i><b>6.5.4</b> Local Registry</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile"><i class="fa fa-check"></i><b>6.6</b> The Dockerfile</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-parent-image"><i class="fa fa-check"></i><b>6.6.1</b> The Parent Image</a></li>
<li class="chapter" data-level="6.6.2" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-metadata"><i class="fa fa-check"></i><b>6.6.2</b> Metadata</a></li>
<li class="chapter" data-level="6.6.3" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-dependencies"><i class="fa fa-check"></i><b>6.6.3</b> Dependencies</a></li>
<li class="chapter" data-level="6.6.4" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-files-and-dirs"><i class="fa fa-check"></i><b>6.6.4</b> Directories and Files</a></li>
<li class="chapter" data-level="6.6.5" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-user"><i class="fa fa-check"></i><b>6.6.5</b> Switching User</a></li>
<li class="chapter" data-level="6.6.6" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-port"><i class="fa fa-check"></i><b>6.6.6</b> Expose a Port</a></li>
<li class="chapter" data-level="6.6.7" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-env-and-arg"><i class="fa fa-check"></i><b>6.6.7</b> Variables</a></li>
<li class="chapter" data-level="6.6.8" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-cmd"><i class="fa fa-check"></i><b>6.6.8</b> Executable and Command</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-parent-images"><i class="fa fa-check"></i><b>6.7</b> Parent Images</a>
<ul>
<li class="chapter" data-level="6.7.1" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-parent-images-r"><i class="fa fa-check"></i><b>6.7.1</b> Popular Parent Images for R</a></li>
<li class="chapter" data-level="6.7.2" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-parent-images-python"><i class="fa fa-check"></i><b>6.7.2</b> Popular Parent Images for Python</a></li>
</ul></li>
<li class="chapter" data-level="6.8" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-install-system-libraries"><i class="fa fa-check"></i><b>6.8</b> Installing System Libraries</a>
<ul>
<li class="chapter" data-level="6.8.1" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-install-system-libraries-manual"><i class="fa fa-check"></i><b>6.8.1</b> Manually Installation</a></li>
<li class="chapter" data-level="6.8.2" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-install-system-libraries-r2u"><i class="fa fa-check"></i><b>6.8.2</b> Automated Dependency Resolution with r2u</a></li>
<li class="chapter" data-level="6.8.3" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-install-system-libraries-alpine"><i class="fa fa-check"></i><b>6.8.3</b> Dependencies on Alpine Linux</a></li>
</ul></li>
<li class="chapter" data-level="6.9" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-install-r-pkg"><i class="fa fa-check"></i><b>6.9</b> Installing R Packages</a>
<ul>
<li class="chapter" data-level="6.9.1" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-install-r-pkg-explicit"><i class="fa fa-check"></i><b>6.9.1</b> Explicitly Stating Dependencies</a></li>
<li class="chapter" data-level="6.9.2" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-install-r-pkg-description"><i class="fa fa-check"></i><b>6.9.2</b> Using the DESCRIPTION File</a></li>
<li class="chapter" data-level="6.9.3" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-install-r-pkg-renv"><i class="fa fa-check"></i><b>6.9.3</b> Using renv</a></li>
<li class="chapter" data-level="6.9.4" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-install-r-pkg-deps"><i class="fa fa-check"></i><b>6.9.4</b> Using deps</a></li>
</ul></li>
<li class="chapter" data-level="6.10" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-install-python"><i class="fa fa-check"></i><b>6.10</b> Python Requirements</a></li>
<li class="chapter" data-level="6.11" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dynamic-shiny-apps"><i class="fa fa-check"></i><b>6.11</b> Dynamic Shiny Apps</a>
<ul>
<li class="chapter" data-level="6.11.1" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dynamic-shiny-apps-r"><i class="fa fa-check"></i><b>6.11.1</b> R</a></li>
<li class="chapter" data-level="6.11.2" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dynamic-shiny-apps-python"><i class="fa fa-check"></i><b>6.11.2</b> Python</a></li>
<li class="chapter" data-level="6.11.3" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dynamic-shiny-apps-rmd"><i class="fa fa-check"></i><b>6.11.3</b> R Markdown</a></li>
<li class="chapter" data-level="6.11.4" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dynamic-shiny-apps-quarto-r"><i class="fa fa-check"></i><b>6.11.4</b> Quarto with R</a></li>
<li class="chapter" data-level="6.11.5" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dynamic-shiny-apps-quarto-python"><i class="fa fa-check"></i><b>6.11.5</b> Quarto with Python</a></li>
<li class="chapter" data-level="6.11.6" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-dynamic-shiny-apps-shiny-server"><i class="fa fa-check"></i><b>6.11.6</b> Shiny Server</a></li>
</ul></li>
<li class="chapter" data-level="6.12" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-static-shiny-apps"><i class="fa fa-check"></i><b>6.12</b> Static Shiny Apps</a>
<ul>
<li class="chapter" data-level="6.12.1" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-multi-stage-builds"><i class="fa fa-check"></i><b>6.12.1</b> Multi-stage Builds</a></li>
</ul></li>
<li class="chapter" data-level="6.13" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-image-analysis"><i class="fa fa-check"></i><b>6.13</b> Image Analysis</a>
<ul>
<li class="chapter" data-level="6.13.1" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-image-analysis-attestations"><i class="fa fa-check"></i><b>6.13.1</b> Attestations</a></li>
<li class="chapter" data-level="6.13.2" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-image-analysis-scanning"><i class="fa fa-check"></i><b>6.13.2</b> Vulnerability Scanning</a></li>
</ul></li>
<li class="chapter" data-level="6.14" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-containers"><i class="fa fa-check"></i><b>6.14</b> Containers</a>
<ul>
<li class="chapter" data-level="6.14.1" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-containers-run"><i class="fa fa-check"></i><b>6.14.1</b> Docker Run</a></li>
<li class="chapter" data-level="6.14.2" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-health-check"><i class="fa fa-check"></i><b>6.14.2</b> Health Check</a></li>
<li class="chapter" data-level="6.14.3" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-container-life-cycle"><i class="fa fa-check"></i><b>6.14.3</b> Container Life Cycle</a></li>
<li class="chapter" data-level="6.14.4" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-containers-managing"><i class="fa fa-check"></i><b>6.14.4</b> Managing Containers</a></li>
<li class="chapter" data-level="6.14.5" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-docker-compose"><i class="fa fa-check"></i><b>6.14.5</b> Docker Compose</a></li>
<li class="chapter" data-level="6.14.6" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-compose-file"><i class="fa fa-check"></i><b>6.14.6</b> The Compose File</a></li>
<li class="chapter" data-level="6.14.7" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-compose-cli"><i class="fa fa-check"></i><b>6.14.7</b> Compose Command Line</a></li>
<li class="chapter" data-level="6.14.8" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-container-orchestration"><i class="fa fa-check"></i><b>6.14.8</b> Container Orchestration</a></li>
</ul></li>
<li class="chapter" data-level="6.15" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-best-practices"><i class="fa fa-check"></i><b>6.15</b> Best Practices</a>
<ul>
<li class="chapter" data-level="6.15.1" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-parent-images"><i class="fa fa-check"></i><b>6.15.1</b> Parent Images</a></li>
<li class="chapter" data-level="6.15.2" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-minimize-deps"><i class="fa fa-check"></i><b>6.15.2</b> Minimize Dependencies</a></li>
<li class="chapter" data-level="6.15.3" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-cache"><i class="fa fa-check"></i><b>6.15.3</b> Cache and Order Layers</a></li>
<li class="chapter" data-level="6.15.4" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-user"><i class="fa fa-check"></i><b>6.15.4</b> Switch to Non-root User</a></li>
<li class="chapter" data-level="6.15.5" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-secrets"><i class="fa fa-check"></i><b>6.15.5</b> No Secrets</a></li>
<li class="chapter" data-level="6.15.6" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-syntax"><i class="fa fa-check"></i><b>6.15.6</b> Shell vs. Exec Syntax</a></li>
<li class="chapter" data-level="6.15.7" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-log"><i class="fa fa-check"></i><b>6.15.7</b> Log to STDOUT and STDERR</a></li>
<li class="chapter" data-level="6.15.8" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-healthcheck"><i class="fa fa-check"></i><b>6.15.8</b> Include HEALTHCHECK</a></li>
<li class="chapter" data-level="6.15.9" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-version"><i class="fa fa-check"></i><b>6.15.9</b> Version Your Images</a></li>
<li class="chapter" data-level="6.15.10" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-readability"><i class="fa fa-check"></i><b>6.15.10</b> Readability</a></li>
<li class="chapter" data-level="6.15.11" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-tips"><i class="fa fa-check"></i><b>6.15.11</b> More Tips</a></li>
</ul></li>
<li class="chapter" data-level="6.16" data-path="6-part2-containerizing-shiny-apps.html"><a href="6-part2-containerizing-shiny-apps.html#summary-5"><i class="fa fa-check"></i><b>6.16</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Hosting Shiny Applications for R and Python</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<html>
<img width='200px' src='images/logos/banner.png' alt="Hosting Shiny">
</html>
<div id="part2-containerizing-shiny-apps" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">Chapter 6</span> Containerizing Shiny Apps<a href="6-part2-containerizing-shiny-apps.html#part2-containerizing-shiny-apps" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Containerization is a topic that is of increasing interest to data
scientists and is a key feature for being able to cover the R and Python
aspects of Shiny hosting in parallel. Once the container image is built,
deployment and hosting become independent of the language that the app was
written in. Tooling around this task has made huge advances over the past two
years, and thanks to this, the topic is now accessible to a wider audience.</p>
<p>Containerization enables you to separate your applications from
your infrastructure so you can deliver software faster.
Containerization help makes an application platform independent by creating
virtual environments in a container. To run a specific application, you will
need to develop an <strong>image</strong> for that platform which is then published on a
<strong>container registry</strong>. The developed image can be pulled from the registry to
run a virtualized container environment for the application.</p>
<p>Docker is one of the most popular tools for creating and managing containers
for Shiny apps. This chapter will outline the needed concepts for containerizing
your shiny application.</p>
<p>Learning Docker seems daunting at first, but it is an incredibly
powerful piece of technology once you get the hang of it. It is also the
building block of the modern web.</p>
<p>Docker is not the only tooling for containerizing applications.
Docker’s licensing model has recently changed and can require a paid license for
commercial use. Therefore, there are alternatives of the Docker Engine such as
using <a href="https://podman.io/">Podman</a>.
However, Podman is much more technical to use than Docker.</p>
<p>All the general advantages of containerized applications apply to Shiny
apps. Docker provides isolation to applications. Images are immutable:
once build they cannot be changed, and if the app is working, it will
work the same in the future. Another important consideration is scaling.
Shiny apps are single-threaded, but running multiple instances of the
same image can serve many users at the same time. Let’s dive into the
details of how to achieve these.</p>
<div id="part2-docker-concepts" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> Docker Concepts<a href="6-part2-containerizing-shiny-apps.html#part2-docker-concepts" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Containers provide portability, consistency, and are used for packaging,
deploying, and running cloud-native data science applications.
<a href="https://www.docker.com/">Docker</a> is the most
popular virtualization environment to deliver software in containers.
Docker is also well supported for Python and R.
Among the many use cases, Docker is most commonly used to deploy
reproducible workflows and to provide isolation for Shiny apps.</p>
<p>Containers bundle their own software, libraries and configuration
files and are isolated from one another. Containers are the
run-time environments or instances defined by container
images. Let’s review the most important concepts.
Figure <a href="6-part2-containerizing-shiny-apps.html#fig:part2-docker-architecture">6.1</a> illustrates
how all the Docker-related concepts all fit together.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:part2-docker-architecture"></span>
<img src="images/02/docker-architecture.png" alt="Docker architecture. Follow the solid, scattered and dotted lines to see how the Docker command line interface (CLI) interacts with the the Docker daemon and the container registry for various commands." width="100%" />
<p class="caption">
Figure 6.1: Docker architecture. Follow the solid, scattered and dotted lines to see how the Docker command line interface (CLI) interacts with the the Docker daemon and the container registry for various commands.
</p>
</div>
<p>You as the user, will use the command line as the <strong>client</strong> to the Docker Engine
which exists on a <strong>host</strong> machine. The Docker Engine interfaces with the
<strong>container registry</strong> to pull the necessary <strong>images</strong> for building a local copy of
an image on the host for running an instance of a <strong>container</strong>.</p>
<div id="part2-docker-engine" class="section level3 hasAnchor" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> Docker Engine<a href="6-part2-containerizing-shiny-apps.html#part2-docker-engine" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The Docker Engine is a client-server application that includes a
<strong>server</strong> (a long-running daemon process called <code>dockerd</code> that listens to API
requests), an <strong>application programming interface</strong>
(REST API) that specifies the interface that programs can use to talk to the
daemon process, and a <strong>command-line interface</strong> (CLI) that is the client-side
of Docker.</p>
<p>The CLI uses the REST API to control or interact with the Docker daemon.
The daemon creates and manages Docker objects, such as images,
containers, volumes, networks, etc.</p>
</div>
<div id="part2-container-registries" class="section level3 hasAnchor" number="6.1.2">
<h3><span class="header-section-number">6.1.2</span> Container Registries<a href="6-part2-containerizing-shiny-apps.html#part2-container-registries" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A Docker registry stores Docker images. <a href="https://hub.docker.com/">Docker Hub</a>
is a public registry and Docker is configured to look for images on Docker Hub by
default. There are many other registries, or users can have their own
private registries. You will see some examples later.
Strictly speaking, container registries are for images and not containers.</p>
</div>
<div id="part2-docker-images" class="section level3 hasAnchor" number="6.1.3">
<h3><span class="header-section-number">6.1.3</span> Images<a href="6-part2-containerizing-shiny-apps.html#part2-docker-images" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>An image is a read-only template with instructions for creating a
Docker container. You can view an image as a set of compressed files and
metadata describing how these files – also called image layers – fit together.</p>
<p>An image can be based on another image with additional customization on top of
this so-called <strong>base* or a </strong>parent** image. A base images is an image created
from “scratch”, whereas a parent image is just another image that serves as the
foundation for a new image. You might see the term base image used for both situations
when reading tutorials. Don’t get confused, the Docker lingo has a few
inconsistencies that we just have to accept and move on.</p>
</div>
<div id="part2-the-dockerfile" class="section level3 hasAnchor" number="6.1.4">
<h3><span class="header-section-number">6.1.4</span> The Dockerfile<a href="6-part2-containerizing-shiny-apps.html#part2-the-dockerfile" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Docker builds images by reading the instructions from a file called
<code>Dockerfile</code>. A Dockerfile is a text document that contains all the
commands to assemble an image using the <code>docker build</code> CLI command. You
will learn more about the <code>Dockerfile</code> as part of the worked Shiny
examples later.</p>
</div>
<div id="part2-docker-containers" class="section level3 hasAnchor" number="6.1.5">
<h3><span class="header-section-number">6.1.5</span> Containers<a href="6-part2-containerizing-shiny-apps.html#part2-docker-containers" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A container is a runnable instance of an image. Users can create,
start, stop a container using the Docker API or CLI. It is also possible
to connect a container to networks or attach storage to it.</p>
<p>By default, a container is isolated from other containers and the
host machine. The degree of isolation can be controlled by the user and
depends on whether it is connected to networks, storage, other
containers, or the host machine.</p>
</div>
<div id="part2-docker-cli" class="section level3 hasAnchor" number="6.1.6">
<h3><span class="header-section-number">6.1.6</span> The Docker Command Line<a href="6-part2-containerizing-shiny-apps.html#part2-docker-cli" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The most common Docker CLI commands are:</p>
<ul>
<li><code>docker login</code>: log into a Docker registry,</li>
<li><code>docker pull</code>: pull an image from a registry,</li>
<li><code>docker build</code>: build a Docker image based on a <code>Dockerfile</code>,</li>
<li><code>docker push</code>: push a locally built image to a Docker registry,</li>
<li><code>docker run</code>: run a command in a new container based on an image.</li>
</ul>
<p>You will learn more about these commands in the subsequent sections.</p>
</div>
</div>
<div id="part2-existing-images" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Working with Existing Images<a href="6-part2-containerizing-shiny-apps.html#part2-existing-images" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s learn how to work with an existing image. Such an image is stored
in a container registry where we can pull it from if we know its name.</p>
<div id="part2-docker-image-names-tags" class="section level3 hasAnchor" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Image Names and Tags<a href="6-part2-containerizing-shiny-apps.html#part2-docker-image-names-tags" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Image names follow the pattern <code>&lt;host&gt;/&lt;path&gt;:&lt;tag&gt;</code>.
The optional <code>&lt;host&gt;</code> name specifies where the image is located.
If you don’t specify a host name, the commands will use Docker’s public registry
<code>docker.io</code>, aka the Docker Hub.</p>
<p>The <code>&lt;path&gt;</code> can be an “official” image, like <code>ubuntu</code>.
The <code>&lt;tag&gt;</code> is a human-readable identifier that is often a specific version of
an image. If not specified, the <code>latest</code> tag will be used.
So <code>ubuntu</code> as an image name will be identical to <code>docker.io/ubuntu:latest</code>.</p>
<p>It is important to note that the <code>latest</code> tag only means “latest” in the sense
of the last image that was tagged as <code>latest</code> or was untagged. If you use
a different tag, like <code>v1</code>, the image with the <code>latest</code> tag will not get
updated as well. So don’t let this tag fool you. It is strongly recommended
in production to always explicitly use a tag that is not <code>latest</code> but
a specific version.</p>
<p>The path is usually more structured and consists of slash-separated components.
It often looks like <code>&lt;namespace&gt;/&lt;repository&gt;</code> where the namespace
specifies the user account or organization to which the image belongs to.
The base R image maintained by the <a href="https://rocker-project.org/">Rocker</a> project
is named as <code>rocker/r-base</code> where <code>rocker</code> is the organization namespace,
<code>r-base</code> is the repository.</p>
<p>Another example is the R version of the Old Faithful
example which has the image name <code>ghcr.io/h10y/faithful/r-shiny:latest</code>.
This means:</p>
<ul>
<li><code>ghcr.io</code> is the GitHub Container Registry host name,</li>
<li><code>h10y</code> is the GitHub organization,</li>
<li><code>faithful</code> is the GitHub repository,</li>
<li><code>r-shiny</code> is the Shiny app build,</li>
<li><code>latest</code> is the version tag.</li>
</ul>
</div>
<div id="part2-docker-pull" class="section level3 hasAnchor" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Pulling an Image<a href="6-part2-containerizing-shiny-apps.html#part2-docker-pull" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>You can use the <code>docker pull &lt;image-name&gt;</code> command to pull an image from
a public registry. For example <code>docker pull ubuntu:24.04</code> will pull the
24.04 version of the “official” Ubuntu image from the Docker Hub.
<code>docker pull rocker/r-base:4.4.1</code> will pull the image with R version 4.1.1.
Pull the R Shiny version of the Old Faithful as:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb65-1"><a href="6-part2-containerizing-shiny-apps.html#cb65-1" tabindex="-1"></a><span class="ex">docker</span> pull ghcr.io/h10y/faithful/r-shiny</span>
<span id="cb65-2"><a href="6-part2-containerizing-shiny-apps.html#cb65-2" tabindex="-1"></a></span>
<span id="cb65-3"><a href="6-part2-containerizing-shiny-apps.html#cb65-3" tabindex="-1"></a><span class="co"># Using default tag: latest</span></span>
<span id="cb65-4"><a href="6-part2-containerizing-shiny-apps.html#cb65-4" tabindex="-1"></a><span class="co"># latest: Pulling from h10y/faithful/r-shiny</span></span>
<span id="cb65-5"><a href="6-part2-containerizing-shiny-apps.html#cb65-5" tabindex="-1"></a><span class="co"># Digest: sha256:12e[...]4ea</span></span></code></pre></div>
<p>You can see from the messages that the <code>latest</code> tag was applied because
we did not specify the tag. We can also see the SHA256 digest, that is
a unique and immutable identifier. The name can change, or multiple names can
refer to the same image (i.e. a set of layers and their manifest). But the
image digest will be the same. To “pin” the exact version, you can use the
<code>&lt;image-name&gt;@sha256:12e[...]4ea</code> pattern (use the actual digest copied from
your screen without the <code>[...]</code>):</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb66-1"><a href="6-part2-containerizing-shiny-apps.html#cb66-1" tabindex="-1"></a><span class="ex">docker</span> pull ghcr.io/h10y/faithful/r-shiny@sha256:12e<span class="pp">[</span><span class="ss">...</span><span class="pp">]</span>4ea</span></code></pre></div>
<p>To pull all images from a repository, you can use the <code>--all-tags</code> flag:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb67-1"><a href="6-part2-containerizing-shiny-apps.html#cb67-1" tabindex="-1"></a><span class="ex">docker</span> image pull <span class="at">--all-tags</span> ghcr.io/h10y/faithful/r-shiny</span></code></pre></div>
<p>This will pull not only the <code>latest</code>, but also the image tagged as <code>main</code>
named after the Git branch. Use the <code>docker images</code> command to list the
images.</p>
</div>
<div id="part2-docker-login" class="section level3 hasAnchor" number="6.2.3">
<h3><span class="header-section-number">6.2.3</span> Docker Login<a href="6-part2-containerizing-shiny-apps.html#part2-docker-login" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>You don’t need to authenticate for public images, but in
case you are trying to pull a private image from a private repository, you
need to log into the container registry. Such private repositories are common
and are available on Docker Hub, the GitHub or GitLab container registries.
More on the different container registries later.</p>
<p>To log in to the GitHub container registry, use:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb68-1"><a href="6-part2-containerizing-shiny-apps.html#cb68-1" tabindex="-1"></a><span class="ex">docker</span> login ghcr.io</span></code></pre></div>
<p>This command will ask for our credentials interactively. If you want,
you can provide your username and password. But it is usually
recommended to use an access token instead of your
password because the token can have more restricted scopes, i.e. only used to
(read) access the container registry which is a lot more secure.
You can also set expiry dates and can revoke these tokens any time without
having to change login passwords elsewhere.</p>
<p>Let’s say that you saved your GitHub token value in a file <code>~/my_token.txt</code> in
the root of your home folder (<code>~</code>). You can pass the PAT value to the
<code>docker login</code> command via the standard input as:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb69-1"><a href="6-part2-containerizing-shiny-apps.html#cb69-1" tabindex="-1"></a><span class="fu">cat</span> ~/my_token.txt <span class="kw">|</span> <span class="ex">docker</span> login <span class="dt">\</span></span>
<span id="cb69-2"><a href="6-part2-containerizing-shiny-apps.html#cb69-2" tabindex="-1"></a>    <span class="at">--username</span> <span class="op">&lt;</span>username<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb69-3"><a href="6-part2-containerizing-shiny-apps.html#cb69-3" tabindex="-1"></a>    <span class="at">--password-stdin</span></span></code></pre></div>
<p>where <code>&lt;username&gt;</code> is your GitHub username.</p>
</div>
<div id="part2-docker-run" class="section level3 hasAnchor" number="6.2.4">
<h3><span class="header-section-number">6.2.4</span> Running a Container<a href="6-part2-containerizing-shiny-apps.html#part2-docker-run" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The next command is <code>docker run</code> which runs a command in a new container.
It pulls the image if needed before starting the container.</p>
<p>Try the following command. It will pull the latest image for the Python build
of the Old Faithful example app, then it will start a new container:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb70-1"><a href="6-part2-containerizing-shiny-apps.html#cb70-1" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-p</span> 8080:3838 ghcr.io/h10y/faithful/py-shiny</span></code></pre></div>
<p>The <code>-p</code> is a shorthand for <code>--publish</code> that instructs Docker to
publish a container’s port to the host port. In our example, 3838 is the
container’s port which is mapped to port 8080 of the host machine. As a
result, you can visit <code>http://127.0.0.1:8080</code> in your browser to see the
Python Shiny app. Hit CTRL+C in the terminal to stop the container. We will
learn about container ports in a bit, but in essence it is just a channel that
is used to send information back and forth.</p>
</div>
</div>
<div id="part2-docker-build" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> Building a New Image<a href="6-part2-containerizing-shiny-apps.html#part2-docker-build" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>So far you saw how to use the basic Docker commands to
pull and run images. Now you’ll build a Docker image by recreating the
Old Faithful Shiny app that we worked with before.</p>
<p>In our examples, we will use the following setup: a file named <code>Dockerfile</code>
sits next to a folder named <code>app</code>, and the Shiny app files like
<code>app.R</code> or <code>app.py</code> are in this folder. This setup is convenient
because we can copy all the files from the <code>app</code> folder without
having to worry about copying files that should not be there.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb71-1"><a href="6-part2-containerizing-shiny-apps.html#cb71-1" tabindex="-1"></a><span class="ex">├──</span> Dockerfile</span>
<span id="cb71-2"><a href="6-part2-containerizing-shiny-apps.html#cb71-2" tabindex="-1"></a><span class="ex">└──</span> app</span>
<span id="cb71-3"><a href="6-part2-containerizing-shiny-apps.html#cb71-3" tabindex="-1"></a>    <span class="ex">└──</span> ...</span></code></pre></div>
<p>You can follow along the examples by downloading or cloning the GitHub repository
with <code>git clone https://github.com/h10y/faithful.git</code>. All the different builds
of the Old Faithful app from Chapter <a href="5-part2-developing-shiny-apps.html#part2-developing-shiny-apps">5</a>
will have a <code>Dockerfile</code> and instructions in the <code>README.md</code> files within each
folder.</p>
<div id="part2-docker-r-shiny" class="section level3 hasAnchor" number="6.3.1">
<h3><span class="header-section-number">6.3.1</span> R for Shiny<a href="6-part2-containerizing-shiny-apps.html#part2-docker-r-shiny" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For our R Shiny example within the <code>r-shiny</code> folder,
this is what is inside the <code>Dockerfile</code>:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb72-1"><a href="6-part2-containerizing-shiny-apps.html#cb72-1" tabindex="-1"></a><span class="kw">FROM</span> rocker/r2u:24.04</span>
<span id="cb72-2"><a href="6-part2-containerizing-shiny-apps.html#cb72-2" tabindex="-1"></a></span>
<span id="cb72-3"><a href="6-part2-containerizing-shiny-apps.html#cb72-3" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;install.packages(&#39;shiny&#39;)&quot;</span></span>
<span id="cb72-4"><a href="6-part2-containerizing-shiny-apps.html#cb72-4" tabindex="-1"></a></span>
<span id="cb72-5"><a href="6-part2-containerizing-shiny-apps.html#cb72-5" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">groupadd</span> app <span class="kw">&amp;&amp;</span> <span class="ex">useradd</span> <span class="at">-g</span> app app</span>
<span id="cb72-6"><a href="6-part2-containerizing-shiny-apps.html#cb72-6" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/app</span>
<span id="cb72-7"><a href="6-part2-containerizing-shiny-apps.html#cb72-7" tabindex="-1"></a></span>
<span id="cb72-8"><a href="6-part2-containerizing-shiny-apps.html#cb72-8" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb72-9"><a href="6-part2-containerizing-shiny-apps.html#cb72-9" tabindex="-1"></a></span>
<span id="cb72-10"><a href="6-part2-containerizing-shiny-apps.html#cb72-10" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">chown</span> app:app <span class="at">-R</span> /home/app</span>
<span id="cb72-11"><a href="6-part2-containerizing-shiny-apps.html#cb72-11" tabindex="-1"></a><span class="kw">USER</span> app</span>
<span id="cb72-12"><a href="6-part2-containerizing-shiny-apps.html#cb72-12" tabindex="-1"></a><span class="kw">EXPOSE</span> 3838</span>
<span id="cb72-13"><a href="6-part2-containerizing-shiny-apps.html#cb72-13" tabindex="-1"></a></span>
<span id="cb72-14"><a href="6-part2-containerizing-shiny-apps.html#cb72-14" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;R&quot;</span>, <span class="st">&quot;-e&quot;</span>, <span class="st">&quot;shiny::runApp(host=&#39;0.0.0.0&#39;, port=3838)&quot;</span>]</span></code></pre></div>
<p>We will explain the <code>Dockerfile</code> instructions in the next section.
For now, you can use the <code>docker build</code> command to build the image from the
<code>Dockerfile</code>. You will have to be in the same directory as the <code>Dockerfile</code>,
this place is what we’ll call as the <strong>build context</strong>.
This is what the <code>.</code> at the end of the command stands for:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb73-1"><a href="6-part2-containerizing-shiny-apps.html#cb73-1" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> r-shiny:v1 .</span></code></pre></div>
<p>The context here specifies the current directory (<code>.</code>), but it can be
any relative or absolute filepath. Files and directories inside the
context directory are available to the builder, so it can load them when needed.
You can use a <code>.dockerignore</code> file to list files and directories that should
be ignored within the build context. It is similar to the <code>.gitignore</code> file.</p>
<p>The instructions are taken from the <code>Dockerfile</code> at the root of the build
context. If you want to specify a different file, do so by providing the
path to the file using the <code>-f</code> (or <code>--file</code>) option as <code>docker build -f Dockerfile2 .</code>.</p>
<p>The <code>-t</code> argument (same as <code>--tag</code>) is followed by the image name
(<code>r-shiny-test</code>) and the tag (<code>v1</code>). If you do not specify the image
name/tag at image build (i.e. <code>docker build .</code>), Docker will not tag the image
but it will have an image ID that you can use later to tag the image with
<code>docker tag &lt;image-id&gt; r-shiny-test:v1</code>.</p>
<p>You can apply multiple tags as:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb74-1"><a href="6-part2-containerizing-shiny-apps.html#cb74-1" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> r-shiny:v1 <span class="at">-t</span> r-shiny:latest .</span></code></pre></div>
</div>
<div id="part2-docker-buildx-buildkit" class="section level3 hasAnchor" number="6.3.2">
<h3><span class="header-section-number">6.3.2</span> Buildx and BuildKit<a href="6-part2-containerizing-shiny-apps.html#part2-docker-buildx-buildkit" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>While the builder is running, you’ll see lots of messages printed
as Docker goes through the instructions from the <code>Dockerfile</code>.
As of Docker Engine 23.0 and Docker Desktop 4.19, Buildx is the default build
client and user interface. Buildx brings extended build capabilities with
BuildKit. BuildKit is the server that handles the build execution, e.g.
it communicates with registries, instructs the Docker Engine and accesses
the local file system. You can enable the use of BuildKit on older Docker
systems by setting the environment variable <code>DOCKER_BUILDKIT=1</code>.</p>
<p>The Buildx output is nicer and it provides you with timings for every step
of your <code>Dockerfile</code>:</p>
<p></p>
<pre><code>[+] Building 32.4s (12/12) FINISHED
 =&gt; [internal] load build definition from Dockerfile                    0.0s
 =&gt; =&gt; transferring dockerfile: 282B                                    0.0s
 =&gt; [internal] load metadata for docker.io/rocker/r2u:24.04             1.2s
 =&gt; [auth] rocker/r2u:pull token for registry-1.docker.io               0.0s
 =&gt; [internal] load .dockerignore                                       0.0s
 =&gt; =&gt; transferring context: 2B                                         0.0s
 =&gt; [1/6] FROM docker.io/rocker/r2u:24.04@sha256:f327[...]dd73          9.2s
 =&gt; =&gt; resolve docker.io/rocker/r2u:24.04@sha256:f327[...]dd73          0.0s
[...]
 =&gt; [internal] load build context                                       0.0s
 =&gt; =&gt; transferring context: 845B                                       0.0s
 =&gt; [2/6] RUN groupadd app &amp;&amp; useradd -g app app                        0.7s
 =&gt; [3/6] RUN R -q -e &quot;install.packages(&#39;shiny&#39;)&quot;                      20.9s
 =&gt; [4/6] WORKDIR /home/app                                             0.0s
 =&gt; [5/6] COPY app .                                                    0.0s
 =&gt; [6/6] RUN chown app:app -R /home/app                                0.1s
 =&gt; exporting to image                                                  0.3s
 =&gt; =&gt; exporting layers                                                 0.3s
 =&gt; =&gt; writing image sha256:4d10[...]bab7                               0.0s
 =&gt; =&gt; naming to docker.io/library/r-shiny:v1                           0.0s</code></pre>
<p></p>
<p>Sometimes you want to inspect the output and do not only want the collapsed
output. Add the <code>--progress=plain</code> to the build command to see all the
output. This comes handy when troubleshooting the build.</p>
<p>BuildKit also offers other nice features, for example setting the target
platform(s) for the build via the <code>--platform</code> option.
The default value is the platform of the BuildKit daemon where the build runs,
i.e. your laptop or a server. This can be important for Mac OS X users
on Apple Silicone (M1 and above), because the default ARM64 build will
have poor performance or might fail on other platforms on AMD64 machines.
Use the <code>--platform=linux/arm64</code> to build the image for AMD64 architecture.
You can also build for multiple architectures at once with
<code>docker build --platform linux/amd64,linux/arm64 .</code>.
See <a href="3-part1-local-setup.html#part1-installing-docker">3.1.5</a> for enabling virtualization on Mac OS X
to enable builds for multiple platforms.</p>
</div>
<div id="part2-docker-inspect" class="section level3 hasAnchor" number="6.3.3">
<h3><span class="header-section-number">6.3.3</span> Inspecting the Image<a href="6-part2-containerizing-shiny-apps.html#part2-docker-inspect" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The output of the build is an image that has a SHA256 hash that can be used
as a unique identifier. The image is made up of image layers. These layers are
created by the instructions from the <code>Dockerfile</code>. If you run the build command
again you will notice that instead of 32 seconds, it will take almost no time
to build the image. This is because the layers are cached by default and Docker
smartly evaluates which instructions and files have changed since the last
build. Sometimes the cache gets tangled, or you just want to make sure that
the error is not a caching issue. In this case use the <code>--no-cache</code> flag
with <code>docker build</code>.</p>
<p>You can use the <code>docker history r-shiny:v1</code> command to see how the image was
built and you can see the sizes for every layer. Intermediate layers
have a size of 0B and these do not contribute to the overall image size.
The layers created 2 hours ago are the layers we created, the layers
created 2 weeks ago are the layers from the parent image <code>rocker/r2u:24.04</code>,
whereas the layers created 2 months ago are the official <code>ubuntu:24.04</code> image
layers that form the parent image of the <code>rocker/r2u:24.04</code> one:</p>
<p></p>
<pre><code>IMAGE          CREATED        CREATED BY                                  SIZE
4d[...]52   2 hours ago    CMD [&quot;R&quot; &quot;-e&quot; &quot;shiny::runApp(host=&#39;0.0.0.0&#39;,   0B
&lt;missing&gt;   2 hours ago    EXPOSE map[3838/tcp:{}]                        0B
&lt;missing&gt;   2 hours ago    USER app                                       0B
&lt;missing&gt;   2 hours ago    RUN /bin/sh -c chown app:app -R /home/app #    780B
&lt;missing&gt;   2 hours ago    COPY app . # buildkit                          780B
&lt;missing&gt;   2 hours ago    WORKDIR /home/app                              0B
&lt;missing&gt;   2 hours ago    RUN /bin/sh -c R -q -e &quot;install.packages(&#39;sh   109MB
&lt;missing&gt;   2 hours ago    RUN /bin/sh -c groupadd app &amp;&amp; useradd -g ap   5.14kB
&lt;missing&gt;   2 weeks ago    RUN /bin/sh -c apt-get update         &amp;&amp; apt   642MB
&lt;missing&gt;   2 weeks ago    ENV TZ=UTC                                     0B
&lt;missing&gt;   2 weeks ago    ENV DEBIAN_FRONTEND=noninteractive             0B
&lt;missing&gt;   2 weeks ago    ENV LANG=en_US.UTF-8                           0B
&lt;missing&gt;   2 weeks ago    ENV LC_ALL=en_US.UTF-8                         0B
&lt;missing&gt;   2 weeks ago    RUN /bin/sh -c useradd -s /bin/bash -m docke   81.6MB
&lt;missing&gt;   2 weeks ago    LABEL org.label-schema.license=GPL-2.0 org.l   0B
&lt;missing&gt;   2 months ago   /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]           0B
&lt;missing&gt;   2 months ago   /bin/sh -c #(nop)  ADD file:ac9d5a9d5b9b1217   76.2MB
&lt;missing&gt;   2 months ago   /bin/sh -c #(nop)  LABEL org.opencontainers.   0B
&lt;missing&gt;   2 months ago   /bin/sh -c #(nop)  LABEL org.opencontainers.   0B
&lt;missing&gt;   2 months ago   /bin/sh -c #(nop)  ARG LAUNCHPAD_BUILD_ARCH    0B
&lt;missing&gt;   2 months ago   /bin/sh -c #(nop)  ARG RELEASE                 0B</code></pre>
<p></p>
<p>The <code>docker inspect r-shiny:v1</code> returns a long JSON output that is the
metadata of the image. It also has the SHA256 hash of the image.
Here is the greatly simplified output:</p>
<p></p>
<pre><code>[
    {
        &quot;Id&quot;: &quot;sha256:4d10[...]bab7&quot;,
        &quot;RepoTags&quot;: [&quot;r-shiny:v1&quot;],
        &quot;Created&quot;: &quot;2024-07-05T04:59:01.123398172Z&quot;,
        &quot;Config&quot;: {
            &quot;User&quot;: &quot;app&quot;,
            &quot;ExposedPorts&quot;: {&quot;3838/tcp&quot;: {}},
            &quot;Cmd&quot;: [&quot;R&quot;,&quot;-e&quot;,
                &quot;shiny::runApp(host=&#39;0.0.0.0&#39;, port=3838)&quot;],
            &quot;Volumes&quot;: null,
            &quot;WorkingDir&quot;: &quot;/home/app&quot;,
            &quot;Entrypoint&quot;: null,
        },
        &quot;Architecture&quot;: &quot;amd64&quot;,
        &quot;Os&quot;: &quot;linux&quot;,
        &quot;Size&quot;: 909132976,
        &quot;Metadata&quot;: {
            &quot;LastTagTime&quot;: &quot;2024-07-05T06:20:22.2764725Z&quot;
        }
    }
]</code></pre>
<p></p>
<p>Once the docker image is built, you can run the container to
make sure the app is working as expected:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb78-1"><a href="6-part2-containerizing-shiny-apps.html#cb78-1" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-p</span> 8080:3838 r-shiny:v1</span></code></pre></div>
</div>
<div id="part2-docker-python-shiny" class="section level3 hasAnchor" number="6.3.4">
<h3><span class="header-section-number">6.3.4</span> Python for Shiny<a href="6-part2-containerizing-shiny-apps.html#part2-docker-python-shiny" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>You can find the Python for Shiny example in the <code>py-shiny</code> folder of the
Old Faithful example repository. The <code>Dockerfile</code> for the Python version looks
like this:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb79-1"><a href="6-part2-containerizing-shiny-apps.html#cb79-1" tabindex="-1"></a><span class="kw">FROM</span> python:3.9</span>
<span id="cb79-2"><a href="6-part2-containerizing-shiny-apps.html#cb79-2" tabindex="-1"></a></span>
<span id="cb79-3"><a href="6-part2-containerizing-shiny-apps.html#cb79-3" tabindex="-1"></a><span class="kw">COPY</span> app/requirements.txt .</span>
<span id="cb79-4"><a href="6-part2-containerizing-shiny-apps.html#cb79-4" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">--no-cache-dir</span> <span class="at">--upgrade</span> <span class="at">-r</span> requirements.txt</span>
<span id="cb79-5"><a href="6-part2-containerizing-shiny-apps.html#cb79-5" tabindex="-1"></a></span>
<span id="cb79-6"><a href="6-part2-containerizing-shiny-apps.html#cb79-6" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">groupadd</span> app <span class="kw">&amp;&amp;</span> <span class="ex">useradd</span> <span class="at">-g</span> app app</span>
<span id="cb79-7"><a href="6-part2-containerizing-shiny-apps.html#cb79-7" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/app</span>
<span id="cb79-8"><a href="6-part2-containerizing-shiny-apps.html#cb79-8" tabindex="-1"></a></span>
<span id="cb79-9"><a href="6-part2-containerizing-shiny-apps.html#cb79-9" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb79-10"><a href="6-part2-containerizing-shiny-apps.html#cb79-10" tabindex="-1"></a></span>
<span id="cb79-11"><a href="6-part2-containerizing-shiny-apps.html#cb79-11" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">chown</span> app:app <span class="at">-R</span> /home/app</span>
<span id="cb79-12"><a href="6-part2-containerizing-shiny-apps.html#cb79-12" tabindex="-1"></a><span class="kw">USER</span> app</span>
<span id="cb79-13"><a href="6-part2-containerizing-shiny-apps.html#cb79-13" tabindex="-1"></a><span class="kw">EXPOSE</span> 3838</span>
<span id="cb79-14"><a href="6-part2-containerizing-shiny-apps.html#cb79-14" tabindex="-1"></a></span>
<span id="cb79-15"><a href="6-part2-containerizing-shiny-apps.html#cb79-15" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">mkdir</span> .config</span>
<span id="cb79-16"><a href="6-part2-containerizing-shiny-apps.html#cb79-16" tabindex="-1"></a><span class="kw">ENV</span> MPLCONFIGDIR=/home/app/.config</span>
<span id="cb79-17"><a href="6-part2-containerizing-shiny-apps.html#cb79-17" tabindex="-1"></a><span class="kw">ENV</span> HOME=/home/app</span>
<span id="cb79-18"><a href="6-part2-containerizing-shiny-apps.html#cb79-18" tabindex="-1"></a></span>
<span id="cb79-19"><a href="6-part2-containerizing-shiny-apps.html#cb79-19" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;uvicorn&quot;</span>, <span class="st">&quot;app:app&quot;</span>, <span class="st">&quot;--host&quot;</span>, <span class="st">&quot;0.0.0.0&quot;</span>, <span class="st">&quot;--port&quot;</span>, <span class="st">&quot;3838&quot;</span>]</span></code></pre></div>
<p>We’ll explain each line shortly. To build and check the Docker image,
use the following commands:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb80-1"><a href="6-part2-containerizing-shiny-apps.html#cb80-1" tabindex="-1"></a><span class="bu">export</span> <span class="va">DOCKER_DEFAULT_PLATFORM</span><span class="op">=</span>linux/amd64</span>
<span id="cb80-2"><a href="6-part2-containerizing-shiny-apps.html#cb80-2" tabindex="-1"></a></span>
<span id="cb80-3"><a href="6-part2-containerizing-shiny-apps.html#cb80-3" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> py-shiny:v1 .</span>
<span id="cb80-4"><a href="6-part2-containerizing-shiny-apps.html#cb80-4" tabindex="-1"></a></span>
<span id="cb80-5"><a href="6-part2-containerizing-shiny-apps.html#cb80-5" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-p</span> 8080:3838 py-shiny:v1</span></code></pre></div>
<p>The <code>DOCKER_DEFAULT_PLATFORM</code> environment variable is not strictly necessary,
but it can save you some headaches on Mac OS X when the platform for the parent
image is not matching the local ARM64 architecture of your Apple Silicone.</p>
</div>
</div>
<div id="part2-docker-managing-images" class="section level2 hasAnchor" number="6.4">
<h2><span class="header-section-number">6.4</span> Managing Images<a href="6-part2-containerizing-shiny-apps.html#part2-docker-managing-images" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>There are a few commands that you need to know to manage your Docker images
in the absence of the Docker Desktop graphical user interface.
This will pay off later when you have no such luxuries on a server.</p>
<p>To list the Docker images, use the <code>docker images</code> command. It will give you
a quick summary of the images:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb81-1"><a href="6-part2-containerizing-shiny-apps.html#cb81-1" tabindex="-1"></a><span class="ex">REPOSITORY</span>   TAG       IMAGE ID       CREATED             SIZE</span>
<span id="cb81-2"><a href="6-part2-containerizing-shiny-apps.html#cb81-2" tabindex="-1"></a><span class="ex">py-shiny</span>     v1        ed11a2980c07   5 seconds ago       1.24GB</span>
<span id="cb81-3"><a href="6-part2-containerizing-shiny-apps.html#cb81-3" tabindex="-1"></a><span class="ex">r-shiny</span>      v1        4d10f42d6a52   About an hour ago   909MB</span></code></pre></div>
<p>Size is the space taken up by the image and all its parent images.</p>
<p>You can filter the output, for example <code>docker images --filter=reference="py-*"</code>
will give you images whose name starts with <code>py-</code>, whereas
<code>docker images --filter=reference="*:v1"</code> will list images that are tagged with
<code>v1</code>.</p>
<p>Use the <code>docker rmi &lt;image-name-or-id&gt;</code> to remove an image based on its name or
the image ID.</p>
<p>The <code>docker system df</code> command will give you a concise summary of disk usage
by the Docker daemon including images, containers, and volumes:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb82-1"><a href="6-part2-containerizing-shiny-apps.html#cb82-1" tabindex="-1"></a><span class="ex">TYPE</span>            TOTAL     ACTIVE    SIZE      RECLAIMABLE</span>
<span id="cb82-2"><a href="6-part2-containerizing-shiny-apps.html#cb82-2" tabindex="-1"></a><span class="ex">Images</span>          2         1         1.457GB   1.355GB <span class="er">(</span><span class="ex">98%</span><span class="kw">)</span></span>
<span id="cb82-3"><a href="6-part2-containerizing-shiny-apps.html#cb82-3" tabindex="-1"></a><span class="ex">Containers</span>      1         1         0B        0B</span>
<span id="cb82-4"><a href="6-part2-containerizing-shiny-apps.html#cb82-4" tabindex="-1"></a><span class="ex">Local</span> Volumes   0         0         0B        0B</span>
<span id="cb82-5"><a href="6-part2-containerizing-shiny-apps.html#cb82-5" tabindex="-1"></a><span class="ex">Build</span> Cache     117       0         3.005GB   3.005GB</span></code></pre></div>
<p>If you build images during development while keeping the image name and tag the
same you will end up with “dangling” images that are untagged and are not used
any longer. Dangling images can accumulate over time and can fill up the
available space that Docker Desktop is allocating for images.
Use <code>docker system prune</code> to clean up these dangling images.
The command <code>docker system prune --all</code> will remove all unused images and containers.</p>
<p>The Docker Desktop uses a finite amount of disk space that can fill up.
Do the cleanup or go to the Docker Desktop settings and under Resources you
should be able to change the virtual disk limit.
You can check the RAM, CPU, and disk usage by looking at the bottom of the
Docker Desktop window.</p>
</div>
<div id="part2-docker-sharing-images" class="section level2 hasAnchor" number="6.5">
<h2><span class="header-section-number">6.5</span> Sharing Images<a href="6-part2-containerizing-shiny-apps.html#part2-docker-sharing-images" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As we saw, Docker images are just compressed files linked by metadata.
You should be able to copy these files and move them around.
The <code>docker save</code> command lets you save an image to a compressed tar file:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb83-1"><a href="6-part2-containerizing-shiny-apps.html#cb83-1" tabindex="-1"></a><span class="ex">docker</span> save <span class="at">-o</span> r-shiny-v1.tar r-shiny:v1</span></code></pre></div>
<p>Next, you take this tar file, copy it to another server and load it with:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb84-1"><a href="6-part2-containerizing-shiny-apps.html#cb84-1" tabindex="-1"></a><span class="ex">docker</span> load <span class="at">--input</span> r-shiny-v1.tar</span></code></pre></div>
<p>This restores both the image and the tags.</p>
<p>Now imagine that you are managing more than two machines, or you want to share
the Docker image with others so that they can use it or to serve as a parent image.
The save/copy/load workflow becomes cumbersome quickly.
In this case, using a registry might be a much better idea. There are
many options to choose from, and you can even host your own registry.</p>
<div id="part2-docker-push" class="section level3 hasAnchor" number="6.5.1">
<h3><span class="header-section-number">6.5.1</span> Pushing Images<a href="6-part2-containerizing-shiny-apps.html#part2-docker-push" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Let’s tag the <code>r-shiny</code> image so that it has a host defined:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb85-1"><a href="6-part2-containerizing-shiny-apps.html#cb85-1" tabindex="-1"></a><span class="ex">docker</span> tag r-shiny:v1 ghcr.io/h10y/faithful/r-shiny:latest</span></code></pre></div>
<p>Now we can push the locally built Docker image to a container registry:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb86-1"><a href="6-part2-containerizing-shiny-apps.html#cb86-1" tabindex="-1"></a><span class="ex">docker</span> push ghcr.io/h10y/faithful/r-shiny:latest</span></code></pre></div>
<p>Note that this command will not work on your machine because you do not
have write access to the <code>ghcr.io/h10y/faithful</code> repository.
You need to create an image name that would let you push to your own personal
Docker Hub account as an example.</p>
<p>The image tag should start with the registry name unless you are pushing
to Docker Hub. When the image tag is not specified, Docker will treat
the new image as <code>:latest</code> automatically.</p>
</div>
<div id="part2-docker-registries" class="section level3 hasAnchor" number="6.5.2">
<h3><span class="header-section-number">6.5.2</span> Docker Registries<a href="6-part2-containerizing-shiny-apps.html#part2-docker-registries" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A Docker registry stores Docker images. This is where we push images to and pull
images from. <a href="https://hub.docker.com/">Docker Hub</a>
is a public registry and Docker is configured to look for images on Docker Hub by
default. <strong>Docker Hub</strong> is a service provided by Docker for finding and sharing
container images. The canonical host name for Docker Hub is <code>docker.io</code>. This
is the default registry when you don’t specify a registry host as part of the
image name.</p>
<p>There are many other registries out there besides Docker Hub. Here is a
non-exhaustive list of options.</p>
<p>The <strong>GitHub Container Registry</strong> (GHCR) is available as part of GitHub Packages
for free and paid plans, even for private repositories under the free
plan. This registry requires no authentication for public images, otherwise
you have to authenticate using your GitHub token. The visibility of the
images inherits the repository visibility but can be changed by the owner.
The host name for GHCR is <code>ghcr.io</code>.</p>
<p>An alternative to GitHub is GitLab (host name <code>registry.gitlab.com</code>),
that has provided registry support for its free (public and private) repositories
long before GitHub. The registry is tightly integrated with GitLab’s CI/CD
pipelines. This registry also needs login with a token for private images.</p>
<p>Heroku is a platform provider and it also comes with a Docker
registry (host name is <code>registry.heroku.com</code>) where the Docker-based deployments
push the images to.</p>
<p>Every major cloud provider offers a Docker container registry
that is integrated with their other offerings. Latency should be
minimal due to network proximity to the servers:</p>
<ul>
<li>Amazon Elastic Container Registry</li>
<li>Azure Container Registry</li>
<li>Google Container Registry</li>
<li>DigitalOcean Container Registry</li>
</ul>
<p>Other common alternatives for container registries include the JFrog Container
Registry, Harbor, and Scaleway.</p>
<p>Although these services are called “container registry”, but strictly
speaking they store container images.</p>
</div>
<div id="part2-docker-registry-login" class="section level3 hasAnchor" number="6.5.3">
<h3><span class="header-section-number">6.5.3</span> Log In to a Registry<a href="6-part2-containerizing-shiny-apps.html#part2-docker-registry-login" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When you work with private registries or private images, you need to log
in with the <code>docker login</code> command. For Docker Hub, just type
<code>docker login</code>. For all other registries, type in the registry URL as
well, e.g. <code>docker login ghcr.io</code>.</p>
<p>The Docker CLI then will prompt you for your username and password (or
access token).</p>
<p>You can log in programmatically by providing your username and the
password through standard input from a file:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb87-1"><a href="6-part2-containerizing-shiny-apps.html#cb87-1" tabindex="-1"></a><span class="fu">cat</span> ~/my_password.txt <span class="kw">|</span> <span class="ex">docker</span> login <span class="at">-u</span> USER <span class="at">--password-stdin</span></span></code></pre></div>
<p>The <code>my_password.txt</code> in this example is is a simple text file with the token
inside and it can be found in the root of your home folder (<code>~</code>). Change the
file path and file name as needed.</p>
<p>You can also use an environment variable to store your token value
that you can pass to the login command as:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb88-1"><a href="6-part2-containerizing-shiny-apps.html#cb88-1" tabindex="-1"></a>  <span class="bu">export</span> <span class="va">TOKEN</span><span class="op">=&lt;</span>your-token-value<span class="op">&gt;</span></span>
<span id="cb88-2"><a href="6-part2-containerizing-shiny-apps.html#cb88-2" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$TOKEN</span> <span class="kw">|</span> <span class="ex">docker</span> login ghcr.io <span class="at">-u</span> USER <span class="at">--password-stdin</span></span></code></pre></div>
<p>Notice the white space before the <code>export</code> statement, use double spaces so that
the command after the spaces will not be saved in your shell history.
The history allows you to recall previous commands by pushing the up arrow
key. The shell history is really just a text file, so copy pasting secrets
into the terminal will leave a trace. Use this trick for sensitive information.</p>
<p>With one of these approaches you can log into any public or private repository
for which you have credentials. The credentials will be stored
locally in <code>$HOME/.docker/config.json</code> on Linux and Mac or in
<code>%USERPROFILE%/.docker/config.json</code> on Windows. After login, there is no
need to re-authenticate until you log out with <code>docker logout</code>.</p>
<p>It is always a good idea to use a token instead of your password. Tokens
can have limited scope (i.e. only for pulling images), and can be
revoked at any time without it impacting other areas of your life.</p>
<p>Note that <code>docker login</code> requires users to use <code>sudo</code> or be the <code>root</code> user.</p>
</div>
<div id="part2-docker-registry-local" class="section level3 hasAnchor" number="6.5.4">
<h3><span class="header-section-number">6.5.4</span> Local Registry<a href="6-part2-containerizing-shiny-apps.html#part2-docker-registry-local" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>You might not want the Docker images to leave your computer because you need an
air gapped environment, or you are setting up a registry within your
virtual private network (VPN). In these situations, you can host your own
container registry.</p>
<p>If you want a registry hosted on your machine, just pull the registry image.
The next command will pull the registry image, and run the similarly named
container in the background on port 5000:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb89-1"><a href="6-part2-containerizing-shiny-apps.html#cb89-1" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-d</span> <span class="dt">\</span></span>
<span id="cb89-2"><a href="6-part2-containerizing-shiny-apps.html#cb89-2" tabindex="-1"></a>  <span class="at">-p</span> 5000:5000 <span class="dt">\</span></span>
<span id="cb89-3"><a href="6-part2-containerizing-shiny-apps.html#cb89-3" tabindex="-1"></a>  <span class="at">--restart</span><span class="op">=</span>always <span class="dt">\</span></span>
<span id="cb89-4"><a href="6-part2-containerizing-shiny-apps.html#cb89-4" tabindex="-1"></a>  <span class="at">--name</span> registry <span class="dt">\</span></span>
<span id="cb89-5"><a href="6-part2-containerizing-shiny-apps.html#cb89-5" tabindex="-1"></a>  registry:2</span></code></pre></div>
<p>Giving a container a name makes it easier to remove the container later, this
way you don’t have to find the container ID. The restart policy always restarts
the container if it stops, but not when it is manually stopped.
The <code>-d</code> flag will start the container in a background process, so you get back
the shell prompt, and you will not see the container log messages.</p>
<p>Tag an image with the host name of your local registry, <code>localhost:5000</code>, and
push the image:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb90-1"><a href="6-part2-containerizing-shiny-apps.html#cb90-1" tabindex="-1"></a><span class="ex">docker</span> tag r-shiny:v1 localhost:5000/r-shiny:v1</span>
<span id="cb90-2"><a href="6-part2-containerizing-shiny-apps.html#cb90-2" tabindex="-1"></a></span>
<span id="cb90-3"><a href="6-part2-containerizing-shiny-apps.html#cb90-3" tabindex="-1"></a><span class="ex">docker</span> push localhost:5000/r-shiny:v1</span></code></pre></div>
<p>To test if it worked, remove the images from your local Docker system.
If you use the <code>-f</code> flag and specify the image ID then the <code>docker rmi</code>
command untags and removes all images that match that ID (get the image ID
from <code>docker images</code>):</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb91-1"><a href="6-part2-containerizing-shiny-apps.html#cb91-1" tabindex="-1"></a><span class="ex">docker</span> rmi <span class="at">-f</span> <span class="op">&lt;</span>image_id<span class="op">&gt;</span></span></code></pre></div>
<p>Now you can pull the image from your local registry:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb92-1"><a href="6-part2-containerizing-shiny-apps.html#cb92-1" tabindex="-1"></a><span class="ex">docker</span> pull localhost:5000/r-shiny:v1</span></code></pre></div>
<p>The next command stops and removes the registry container. It is a daemonized
(background) process, so CTRL+C won’t work. The <code>-v</code> option makes sure to remove
anonymous volumes associated with the container which is often used to mount a
volume from your hard drive into the container where the images are stored:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb93-1"><a href="6-part2-containerizing-shiny-apps.html#cb93-1" tabindex="-1"></a><span class="ex">docker</span> container stop registry <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb93-2"><a href="6-part2-containerizing-shiny-apps.html#cb93-2" tabindex="-1"></a>  <span class="ex">docker</span> container rm <span class="at">-v</span> registry</span></code></pre></div>
<p>If you want your registry to be accessed over a public network, then you need to
think about security and access control. You’ll have to set up transport
layer security (TLS) for HTTPS and user authentication, which are advanced topics
and we recommend using a commercial container registry that we listed above
and use private repositories to control access to your images.</p>
</div>
</div>
<div id="part2-dockerfile" class="section level2 hasAnchor" number="6.6">
<h2><span class="header-section-number">6.6</span> The Dockerfile<a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>It is time to review the Dockerfiles line by line and learn about each of the
different types of instructions and their uses.
We organize the sections according to functional steps based on the Dockerfiles
for our R and Python apps. The full Dockerfile reference can be found at
<a href="https://docs.docker.com/reference/dockerfile/" class="uri">https://docs.docker.com/reference/dockerfile/</a>.</p>
<div id="part2-dockerfile-parent-image" class="section level3 hasAnchor" number="6.6.1">
<h3><span class="header-section-number">6.6.1</span> The Parent Image<a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-parent-image" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>FROM</code> instruction initializes a new build stage and sets the base
(<code>FROM SCRATCH</code>) or parent image (e.g. <code>FROM ubuntu:24.04</code>).
For the R version we used the <code>FROM rocker/r2u:24.04</code> and for the Python version
we used <code>FROM python:3.9</code>. We will review the different parent images and
how to use multiple parent images in the same Dockerfile as part of a
multi-stage build later.</p>
</div>
<div id="part2-dockerfile-metadata" class="section level3 hasAnchor" number="6.6.2">
<h3><span class="header-section-number">6.6.2</span> Metadata<a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-metadata" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>LABEL</code> instruction is optional, it adds metadata to an image, e.g.
who to contact in case of issues or questions:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb94-1"><a href="6-part2-containerizing-shiny-apps.html#cb94-1" tabindex="-1"></a><span class="kw">LABEL</span> maintainer=<span class="st">&quot;USER &lt;user@example.com&gt;&quot;</span></span></code></pre></div>
<p>We’ll talk more about labels as part of continuous integration and continuous
delivery (CI/CD) /FIXME: add ref here/.</p>
</div>
<div id="part2-dockerfile-dependencies" class="section level3 hasAnchor" number="6.6.3">
<h3><span class="header-section-number">6.6.3</span> Dependencies<a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-dependencies" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We often use the <code>RUN</code> instruction to install dependencies and use other
shell commands to set permissions to files, etc.
<code>RUN</code> executes a command in a new layer on top of the current
image. We used the <code>RUN R -q -e "install.packages('shiny')"</code> to install
the <code>shiny</code> R package, whereas the Python version used the
<code>requirements.txt</code> alongside the <code>pip</code> command as:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb95-1"><a href="6-part2-containerizing-shiny-apps.html#cb95-1" tabindex="-1"></a><span class="kw">COPY</span> app/requirements.txt .</span>
<span id="cb95-2"><a href="6-part2-containerizing-shiny-apps.html#cb95-2" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">--no-cache-dir</span> <span class="at">--upgrade</span> <span class="at">-r</span> requirements.txt</span></code></pre></div>
<p>We also used <code>RUN</code> to add a user called <code>app</code> to a Linux user group called <code>app</code>.
This is needed because you do not want to run containers as the <code>root</code> user in
production. Running the container with root privileges allows unrestricted
use which is to be avoided. Although you can find lots of examples on the
Internet where the container is run as root, this is generally considered bad
practice. This is how we created the non-root user:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb96-1"><a href="6-part2-containerizing-shiny-apps.html#cb96-1" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">groupadd</span> app <span class="kw">&amp;&amp;</span> <span class="ex">useradd</span> <span class="at">-g</span> app app</span></code></pre></div>
</div>
<div id="part2-dockerfile-files-and-dirs" class="section level3 hasAnchor" number="6.6.4">
<h3><span class="header-section-number">6.6.4</span> Directories and Files<a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-files-and-dirs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Next we changed the working directory to <code>/home/app</code> that is he home folder
of the non-privileged <code>app</code> user:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb97-1"><a href="6-part2-containerizing-shiny-apps.html#cb97-1" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/app</span></code></pre></div>
<p>The <code>WORKDIR</code> instruction sets the working directory for any
<code>RUN</code>, <code>CMD</code>, <code>ENTRYPOINT</code>, <code>COPY</code> and <code>ADD</code> instructions that follow it in the
<code>Dockerfile</code>.</p>
<p>The <code>COPY</code> instruction copies new files or directories from the source
and adds them to the file system of the container at the destination path.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb98-1"><a href="6-part2-containerizing-shiny-apps.html#cb98-1" tabindex="-1"></a><span class="kw">COPY</span> app .</span></code></pre></div>
<p>The source here is the <code>app</code> folder inside the Docker build context.
The contents of the folder, including the Shiny app files, are copied.
The destination path <code>.</code> refers to the current work directory defined previously,
in this case, the <code>/home/app</code> folder.</p>
<p>Use an alternative format if the paths contain whitespace:
<code>COPY ["dir with space", "."]</code>.</p>
<p>You would almost always use <code>COPY</code> in your Dockerfile, but a very similar
instruction is <code>ADD</code>. <code>ADD</code> allows the source to be a URL, a Git
repository, or a compressed file.</p>
<p>Wildcards, such as <code>*</code> for multiple characters and <code>?</code> for single character,
are supported in <code>COPY</code> and <code>ADD</code> instructions. For example
<code>COPY app/*.py .</code> will copy only the Python scripts and nothing else.</p>
<p>Normally when the source does not exist <code>docker build</code> exits with an error.
An interesting feature of wildcards is that the build does not error
if there are no matching results. For example <code>COPY *renv.lock .</code> will copy
the <code>renv.lock</code> file if it exists, but the build won’t stop if it does not.</p>
<p>The owner of the files and directories at the destination is the root user.
If you want to set the user and the group so that the non-root user will
be able to access these resources you can use the optional <code>--chown</code> flag
that stands for change owner:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb99-1"><a href="6-part2-containerizing-shiny-apps.html#cb99-1" tabindex="-1"></a><span class="kw">COPY</span> <span class="op">--chown</span> app:app app .</span></code></pre></div>
<p>Here the <code>--chown app:app</code> sets the user and the group values to <code>app</code>.
This is equivalent to the following combination of <code>COPY</code> and <code>RUN</code>:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb100-1"><a href="6-part2-containerizing-shiny-apps.html#cb100-1" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb100-2"><a href="6-part2-containerizing-shiny-apps.html#cb100-2" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">chown</span> app:app <span class="at">-R</span> /home/app</span></code></pre></div>
<p>Similarly, use the <code>--chmod</code> flag to define read/write/execute permissions.</p>
</div>
<div id="part2-dockerfile-user" class="section level3 hasAnchor" number="6.6.5">
<h3><span class="header-section-number">6.6.5</span> Switching User<a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-user" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>USER</code> instruction sets the user name to use as the default user for
the <code>ENTRYPOINT</code> and <code>CMD</code> commands. We used <code>USER app</code> to switch to the
non-root <code>app</code> user.</p>
</div>
<div id="part2-dockerfile-port" class="section level3 hasAnchor" number="6.6.6">
<h3><span class="header-section-number">6.6.6</span> Expose a Port<a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-port" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>EXPOSE</code> instruction defines the port that Docker container listens on
at runtime. We chose port 3838 with the <code>EXPOSE 3838</code> instruction.
This is the container port that we connect to using the
<code>docker run -p 8080:3838 &lt;image-name&gt;</code> command.</p>
<p>You can pick any port, but remember that exposing a lower port number, like
80 (the standard HTTP port) will require elevated privileges.
In general, we recommend using port numbers 1024 and above. Using lower
ports will result in failures with a non-root user, such as our <code>app</code> user.</p>
</div>
<div id="part2-dockerfile-env-and-arg" class="section level3 hasAnchor" number="6.6.7">
<h3><span class="header-section-number">6.6.7</span> Variables<a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-env-and-arg" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>ENV</code> instruction sets the default values for environment variables.
We set two variables for the Python app to allow configs to be written
for <code>matplotlib</code> by the <code>app</code> user:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb101-1"><a href="6-part2-containerizing-shiny-apps.html#cb101-1" tabindex="-1"></a><span class="kw">ENV</span> MPLCONFIGDIR=/home/app/.config</span>
<span id="cb101-2"><a href="6-part2-containerizing-shiny-apps.html#cb101-2" tabindex="-1"></a><span class="kw">ENV</span> HOME=/home/app</span></code></pre></div>
<p>These environment variables will be part of the final image, so do not use <code>ENV</code>
to add secrets to the image at build time. Such environment variables should be
added at runtime, e.g. with <code>docker run --env TOKEN=&lt;token-value&gt; &lt;image-name&gt;</code>
or using a file as <code>docker run --env-file .env &lt;image-name&gt;</code> which will
read the variables from the <code>.env</code> file.</p>
<p>The <code>ARG</code> instruction defines a variable that users can pass at build-time.
For example, adding <code>ARG GITHUB_PAT</code> to the Dockerfile
would allow you to use the <code>remotes::install_github()</code> function to install
an R package from a private GitHub repository. You can provide the token
value to <code>docker build</code> as:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb102-1"><a href="6-part2-containerizing-shiny-apps.html#cb102-1" tabindex="-1"></a>  <span class="bu">export</span> <span class="va">GITHUB_PAT</span><span class="op">=&lt;</span>your-token<span class="op">&gt;</span></span>
<span id="cb102-2"><a href="6-part2-containerizing-shiny-apps.html#cb102-2" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> <span class="op">&lt;</span>image-tag<span class="op">&gt;</span> --build-arg=<span class="st">&quot;GITHUB_PAT=</span><span class="va">${GITHUB_PAT}</span><span class="st">&quot;</span> .</span></code></pre></div>
<p>The token value will not be available in the container at runtime.</p>
</div>
<div id="part2-dockerfile-cmd" class="section level3 hasAnchor" number="6.6.8">
<h3><span class="header-section-number">6.6.8</span> Executable and Command<a href="6-part2-containerizing-shiny-apps.html#part2-dockerfile-cmd" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We got to the end of the Dockerfile. This is where we define the
<strong>process</strong> that is executed inside the container at run time via the
<code>ENTRYPOINT</code> instruction. This is often omitted. In that case, the default
executable is set to <code>/bin/sh -c</code> that is the shell executable.
Shell is a basic command-line interpreter and the <code>-c</code>
flag indicates that the shell will read the commands to execute from a string.
This string is provided through the <code>CMD</code> instruction.
For example we can add <code>CMD uvicorn app:app --host 0.0.0.0 --port 3838</code>
as the default set of arguments supplied to the <code>ENTRYPOINT</code> process
to start the Python Shiny app.</p>
<p>The <code>RUN</code>, <code>CMD</code>, and <code>ENTRYPOINT</code> instructions have two possible forms.
The shell form is used mostly with the <code>RUN</code> instruction because it allows
useful shell features like piping the output and chaining commands.
The shell form is written without square brackets and it would look like this
for the R Shiny app:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb103-1"><a href="6-part2-containerizing-shiny-apps.html#cb103-1" tabindex="-1"></a><span class="kw">CMD</span> <span class="ex">R</span> <span class="at">-e</span> <span class="st">&quot;shiny::runApp(host=&#39;0.0.0.0&#39;, port=3838)&quot;</span></span></code></pre></div>
<p>This command will execute as a child processes of the shell, and as such,
signals like CTRL+C will not be forwarded to the child process by the shell.
This is why it is recommended to use the so called “exec” form for the <code>CMD</code> and
<code>ENTRYPOINT</code> instructions. The “exec” form is written between square
brackets. Here it is for the R version:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb104-1"><a href="6-part2-containerizing-shiny-apps.html#cb104-1" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;R&quot;</span>, <span class="st">&quot;-e&quot;</span>, <span class="st">&quot;shiny::runApp(host=&#39;0.0.0.0&#39;, port=3838)&quot;</span>]</span></code></pre></div>
<p>And for the Python version:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb105-1"><a href="6-part2-containerizing-shiny-apps.html#cb105-1" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;uvicorn&quot;</span>, <span class="st">&quot;app:app&quot;</span>, <span class="st">&quot;--host&quot;</span>, <span class="st">&quot;0.0.0.0&quot;</span>, <span class="st">&quot;--port&quot;</span>, <span class="st">&quot;3838&quot;</span>]</span></code></pre></div>
<p>When we discussed local hosting of the Shiny apps we did not review all the
possible arguments for the R and Python commands. Two options here beg for introduction.
The <code>host</code> defines the IP address that the app listens on. The default host
value is <code>127.0.0.1</code> (also known as <code>localhost</code> or loopback address).
If we leave the host at its default value, we will not be able to access the
container from outside because localhost can only be accessed from the same
address. This is the reason why we need to set it to <code>0.0.0.0</code> which can be
accessed from outside of the container.</p>
<p>The other important argument is the TCP port that the application is listening
on. If the prot is not provided for the R Shiny command, Shiny will pick a
random port number. We obviously do not want to guess this port, so we need to
set it. The 3838 port number is the same as the number we exposed via the
<code>EXPOSE 3838</code> instruction.</p>
<p>It is possible to use an environment variable for the port number
and substitute it in the <code>CMD</code> command:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb106-1"><a href="6-part2-containerizing-shiny-apps.html#cb106-1" tabindex="-1"></a><span class="kw">ENV</span> PORT=3838</span>
<span id="cb106-2"><a href="6-part2-containerizing-shiny-apps.html#cb106-2" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;R&quot;</span>, <span class="st">&quot;-e&quot;</span>, <span class="st">&quot;shiny::runApp(host=&#39;0.0.0.0&#39;, port=$PORT)&quot;</span>]</span></code></pre></div>
<p>This way the default value is set to 3838, but you can override it at runtime
as <code>docker run --env PORT=5000 &lt;image-name&gt;</code>.</p>

</div>
</div>
<div id="part2-parent-images" class="section level2 hasAnchor" number="6.7">
<h2><span class="header-section-number">6.7</span> Parent Images<a href="6-part2-containerizing-shiny-apps.html#part2-parent-images" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We have reviewed Docker basics and how to dockerize a very simple Shiny app.
For anything that is a little bit more complex, you will have to manage
dependencies. Dependency management is one of the most important aspects
of app development with Docker. And it begins with finding the right parent
image as the basis of the rest of your Dockerfile.</p>
<p>The ground zero for Docker images is the reserved and explicitly empty
image called <code>scratch</code>. <code>FROM scratch</code> is used for hosting super minimal images
containing a single binary executable or as the foundation of common base images
such as <code>debian</code>, <code>ubuntu</code> or <code>alpine</code>.</p>
<p>Debian is a Linux distribution that’s composed entirely of free and open-source
software and is a community project. Ubuntu is derived from Debian and is
commercially backed by Canonical. Ubuntu uses the same APT packaging system as
Debian and many packages and libraries from Debian repositories.
Both of these Linux distributions are loved for their versatility and
reliability, and the huge user base ensures first class community support.</p>
<p>Alpine Linux is a minimal distribution independent of Debian and other
distributions. It was designed with a focus on simplicity, security, and
efficiency. This distribution has a very compact size, and therefore is
a popular choice for embedded systems and IoT devices. This distribution
is also community maintained.</p>
<p>Here are the sizes for these three images. Debian is the largest, Ubuntu in
the middle, and the Alpine being more than 10 times smaller:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb107-1"><a href="6-part2-containerizing-shiny-apps.html#cb107-1" tabindex="-1"></a><span class="ex">REPOSITORY</span>    TAG       IMAGE ID       CREATED       SIZE</span>
<span id="cb107-2"><a href="6-part2-containerizing-shiny-apps.html#cb107-2" tabindex="-1"></a><span class="ex">debian</span>        12.6      7b34f2fc561c   7 days ago    117MB</span>
<span id="cb107-3"><a href="6-part2-containerizing-shiny-apps.html#cb107-3" tabindex="-1"></a><span class="ex">ubuntu</span>        24.04     35a88802559d   4 weeks ago   78.1MB</span>
<span id="cb107-4"><a href="6-part2-containerizing-shiny-apps.html#cb107-4" tabindex="-1"></a><span class="ex">alpine</span>        3.20      a606584aa9aa   2 weeks ago   7.8MB</span></code></pre></div>
<p>Many of the commonly used R and Python parent images use Debian/Ubuntu or Alpine
as the starting point. The general trade-off between these two lineages
comes down to convenience vs. minimalism. Ubuntu and its derivatives tend to be
much larger in size, but build times can be considerably faster due to very
mature package management system and the availability of pre-built binaries.</p>
<p>Alpine-based images, however, tend to be much smaller, almost bare bones.
Alpine uses different compilers that Ubuntu so you’ll often have to build and
compile your packages from source. This can be tedious and
time consuming. However, its small size reduces the surface area for
potential attackers and as a result the images tend to be less vulnerable.</p>
<p>The final image size is important to consider, but images based on the same
parent image share lots of their layers anyways, so the images can pack
much tighter on your hard drive than you might think based on their size without
subtracting common layers. Also,the size advantage of the Alpine
distribution evaporates quickly as you start adding R and Python libraries.
Some packages will take up more space than the parent image itself.</p>
<div id="part2-parent-images-r" class="section level3 hasAnchor" number="6.7.1">
<h3><span class="header-section-number">6.7.1</span> Popular Parent Images for R<a href="6-part2-containerizing-shiny-apps.html#part2-parent-images-r" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Let’s see some of the most popular base R images based. Here is the
output from <code>docker images</code> after pulling each of these Docker images:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb108-1"><a href="6-part2-containerizing-shiny-apps.html#cb108-1" tabindex="-1"></a><span class="ex">REPOSITORY</span>       TAG       IMAGE ID       CREATED         SIZE</span>
<span id="cb108-2"><a href="6-part2-containerizing-shiny-apps.html#cb108-2" tabindex="-1"></a><span class="ex">r-base</span>           4.4.1     16511f39cdb4   3 weeks ago     833MB</span>
<span id="cb108-3"><a href="6-part2-containerizing-shiny-apps.html#cb108-3" tabindex="-1"></a><span class="ex">rocker/r-base</span>    4.4.1     22b431698084   3 weeks ago     878MB</span>
<span id="cb108-4"><a href="6-part2-containerizing-shiny-apps.html#cb108-4" tabindex="-1"></a><span class="ex">rocker/r-ver</span>     4.4.1     9bb36eff1caa   3 weeks ago     843MB</span>
<span id="cb108-5"><a href="6-part2-containerizing-shiny-apps.html#cb108-5" tabindex="-1"></a><span class="ex">rocker/shiny</span>     4.4.1     a90ccd5c09b9   3 weeks ago     1.58GB</span>
<span id="cb108-6"><a href="6-part2-containerizing-shiny-apps.html#cb108-6" tabindex="-1"></a><span class="ex">rocker/r2u</span>       24.04     1441545ed6df   2 weeks ago     800MB</span>
<span id="cb108-7"><a href="6-part2-containerizing-shiny-apps.html#cb108-7" tabindex="-1"></a><span class="ex">rhub/r-minimal</span>   4.4.1     1e280d0205b7   3 weeks ago     44.9MB</span></code></pre></div>
<p>The official <code>r-base</code> image is an R installation built on top of Debian. It is
maintained by the Rocker community (<a href="https://rocker-project.org/" class="uri">https://rocker-project.org/</a>, <span class="citation">Boettiger and Eddelbuettel (<a href="#ref-rocker">2017</a>)</span>).
This <code>r-base</code> image is like the <code>rocker/r-base</code>, these two images are built
from the same Dockerfile, but with different build tools.
The Debian Linux distribution is more cutting edge than Ubuntu.
This means it has unstable repos added and it receives updates faster.
It is for those who like to live on the cutting edge of development.</p>
<p>For those who value stability more, the Ubuntu based images could be better
suited. Such as the Rocker versioned stack, <code>rocker/r-ver</code>, which emphasizes
reproducibility. This stack has both AMD64 and experimental ARM64 support
for R version 4.1.0 and later. For the AMD64 platform, it serves compiled
binaries of R packages that makes package installs speedy.</p>
<p>The default CRAN mirror for <code>rocker/r-ver</code> is set to the Posit Public Package Manager
(P3M, <a href="https://p3m.dev/" class="uri">https://p3m.dev/</a>, previously called RStudio Package Manager or RSPM).
To ensure reproducibility, the non-latest R version images
install R packages from a fixed snapshot of the CRAN mirror at a given date.
So you’ll end up with the same package versions no matter when you build your image.</p>
<p>The <code>rocker/shiny</code> image is based on the <code>rocker/r-ver</code> stack and comes with
Shiny related packages and Shiny Server Open Source installed. This makes it the
beefiest of all the images presented. It has 68 packages available instead of
the 31 within the <code>r-base</code> and <code>r-ver</code> stacks (14 base and 15 recommended packages).
The images so far have been tagged by the R version that is inside the image,
e.g. <code>4.4.1</code>.</p>
<p>The <code>rocker/r2u</code> is based on Ubuntu as well, and it brings Ubuntu binaries for
CRAN packages fully integrated with the system package manager (<code>apt</code>).
When you use <code>install.packages()</code> it will call <code>apt</code> in the background.
This has the advantage that system dependencies are fully resolved, i.e. no need
to guess and manually install them. Installations are also reversible.
It uses the CRAN mirror at <a href="https://r2u.stat.illinois.edu" class="uri">https://r2u.stat.illinois.edu</a>.
Keep in mind that packages and R itself are generally the highest available version.
Therefore, the image tag is not based on the R version but based on the
Ubuntu LTS (Long Term Support) version, like <code>24.04</code>.</p>
<p>All the Rocker images pack utilities that help with command line tasks,
such as installing packages via <code>install.r</code> and <code>installGithub.r</code>,
all part of the <code>littler</code> project <span class="citation">(<a href="#ref-R-littler">Eddelbuettel and Horner 2024</a>)</span>. There is even a command line
tool for Shiny, so instead of
<code>CMD ["R", "-e", "shiny::runApp(host='0.0.0.0', port=3838)"]</code>
you can use <code>CMD ["shiny.r", "-o", "0.0.0.0", "-p", "3838"]</code> in your Dockerfile.</p>
<p>Finally, the <code>rhub/r-minimal</code> image is based on Alpine Linux and is the tiniest
available image for R. This feat is achieved by not having recommended R packages
installed (it has a total of 14 required packages), it does not have any
documentation or translations, no X11 window support.
It does not even have C, C++ or Fortran compilers. So if an R package relies on
compiled code, first you have to install a compiler, then later uninstall it
to keep the image size minimal. The <code>installr</code> script provided as part of the
image helps with the installation and clean-up of build time dependencies,
see <code>installr -h</code> for the available options.</p>
<p>If you are looking for Linux distributions other than what we listed so far
(Debian, Ubuntu, Alpine), take a look at the
<a href="https://github.com/rstudio/r-docker"><code>rstudio/r-base</code></a> images
that bring versioned base R to many Linux distributions, e.g. CentOS,
Rocky Linux, and OpenSUSE.</p>
</div>
<div id="part2-parent-images-python" class="section level3 hasAnchor" number="6.7.2">
<h3><span class="header-section-number">6.7.2</span> Popular Parent Images for Python<a href="6-part2-containerizing-shiny-apps.html#part2-parent-images-python" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The official Python images are maintained by the Python community
and are either based on Debian or Alpine Linux. Here are the most commonly used
variants:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb109-1"><a href="6-part2-containerizing-shiny-apps.html#cb109-1" tabindex="-1"></a><span class="ex">REPOSITORY</span>   TAG          IMAGE ID       CREATED       SIZE</span>
<span id="cb109-2"><a href="6-part2-containerizing-shiny-apps.html#cb109-2" tabindex="-1"></a><span class="ex">python</span>       3.9          8912c37cec43   12 days ago   996MB</span>
<span id="cb109-3"><a href="6-part2-containerizing-shiny-apps.html#cb109-3" tabindex="-1"></a><span class="ex">python</span>       3.9-slim     b4045d7da52e   12 days ago   125MB</span>
<span id="cb109-4"><a href="6-part2-containerizing-shiny-apps.html#cb109-4" tabindex="-1"></a><span class="ex">python</span>       3.9-alpine   893ee28ab004   12 days ago   53.4MB</span></code></pre></div>
<p>The <code>python:&lt;version&gt;</code> image is the largest and is the most general supporting
all kinds of use cases and is recommended as a parent image. It contains the
common Debian packages and compilers.</p>
<p>The <code>python:&lt;version&gt;-slim</code> version contains only the minimal Debian packages
needed to run Python itself. It does not contain the compilers for modules
written in other languages. This is the reason for the image’s reduced size.</p>
<p>The <code>python:&lt;version&gt;-alpine</code> is based on Alpine and therefore is the smallest.
It is similarly bare bones as the minimal R image.</p>
</div>
</div>
<div id="part2-install-system-libraries" class="section level2 hasAnchor" number="6.8">
<h2><span class="header-section-number">6.8</span> Installing System Libraries<a href="6-part2-containerizing-shiny-apps.html#part2-install-system-libraries" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>System libraries are required for different purposes. Some libraries are needed
during build time. While others are needed at run time.
Say your R or Python package requires compilation or needs
to dynamically link to other system libraries. In these cases you have to
build your package using compilers (C, C++, Fortran, Rust) and other build
time dependencies. System libraries used at build time includes header files and
tend to have extra dependencies. These build time system libraries are
named with a <code>*-dev</code> or <code>*-devel</code> postfix.</p>
<p>Once your R or Python package has been compiled, you don’t need the build time
libraries any more. However, you need the run time libraries. For example
if your package needs to be built with <code>libcurl4-openssl-dev</code>, the run time
dependency becomes <code>libcurl4</code>. The run time dependencies tend to be much smaller
and have fewer dependencies. These will have no conflict with other run time
libraries because of the lack of headers included.</p>
<div id="part2-install-system-libraries-manual" class="section level3 hasAnchor" number="6.8.1">
<h3><span class="header-section-number">6.8.1</span> Manually Installation<a href="6-part2-containerizing-shiny-apps.html#part2-install-system-libraries-manual" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>FIXME: Review the Python specific parts.</p>
<p>The <a href="https://pythonwheels.com/">Python Wheels</a>
project offers binary Python packages. R binaries can be found on
CRAN for Windows and Mac OS X. But CRAN does not offer binaries for various
Linux distributions for the obvious complexity involved in that.
The <a href="P3M,%20%3Chttps://p3m.dev/%3E">Posit Public Package Manager</a> provides pre-built binary
packages for R and Python. It supports various Linux distributions, including
Debian and Ubuntu. The <a href="https://r-universe.dev/search/">R Universe</a>
project provide binaries for CRAN and GitHub packages for Windows, Mac OS X,
and in most cases for WebAssembly that is suitable for Shinylive applications.
The R Universe project only provides binaries for R packages on Ubuntu
using the latest R version.</p>
<p>R and Python packages, once compiled into a binary file, provide metadata about
the run time dependencies. You can find the required system libraries on the
website of a given repository or package manager. Alternatively, you can try
installing the package without its requirements and follow the string of
error messages to see what is it that you need to install as a prerequisite.</p>
<p>This GitHub repository lists system requirements for R packages:
<a href="https://github.com/rstudio/r-system-requirements">rstudio/r-system-requirements</a>.
The primary purpose of this database is to support the Posit Public Package Manager.
To get programmatic access to the database, you can call the
Posit Public Package Manager’s API to request the system requirements.
For example, for the <code>curl</code> R package <span class="citation">(<a href="#ref-R-curl">Ooms 2024</a>)</span>, you can query the API as
<code>https://p3m.dev/__api__/repos/1/packages/curl/sysreqs?distribution=ubuntu</code>.
Replace the <code>curl</code> and <code>ubuntu</code> parts to get results for other R packages and
Linux distributions. The HTTP <code>GET</code> request will result in a JSON response listing
the libraries with the install script needed on Ubuntu (try pasting the
link into the browser address line):</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb110-1"><a href="6-part2-containerizing-shiny-apps.html#cb110-1" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb110-2"><a href="6-part2-containerizing-shiny-apps.html#cb110-2" tabindex="-1"></a>  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;curl&quot;</span><span class="fu">,</span></span>
<span id="cb110-3"><a href="6-part2-containerizing-shiny-apps.html#cb110-3" tabindex="-1"></a>  <span class="dt">&quot;install_scripts&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb110-4"><a href="6-part2-containerizing-shiny-apps.html#cb110-4" tabindex="-1"></a>    <span class="st">&quot;apt-get install -y libcurl4-openssl-dev&quot;</span><span class="ot">,</span></span>
<span id="cb110-5"><a href="6-part2-containerizing-shiny-apps.html#cb110-5" tabindex="-1"></a>    <span class="st">&quot;apt-get install -y libssl-dev&quot;</span></span>
<span id="cb110-6"><a href="6-part2-containerizing-shiny-apps.html#cb110-6" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb110-7"><a href="6-part2-containerizing-shiny-apps.html#cb110-7" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>You can also utilize the <code>pak</code> R package <span class="citation">(<a href="#ref-R-pak">Csárdi and Hester 2024</a>)</span> to query system requirements:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="6-part2-containerizing-shiny-apps.html#cb111-1" tabindex="-1"></a>pak<span class="sc">::</span><span class="fu">pkg_sysreqs</span>(<span class="st">&quot;curl&quot;</span>, <span class="at">sysreqs_platform=</span><span class="st">&quot;ubuntu&quot;</span>)</span>
<span id="cb111-2"><a href="6-part2-containerizing-shiny-apps.html#cb111-2" tabindex="-1"></a><span class="co"># -- Install scripts ---------------------------- Ubuntu NA --</span></span>
<span id="cb111-3"><a href="6-part2-containerizing-shiny-apps.html#cb111-3" tabindex="-1"></a><span class="co"># apt-get -y update</span></span>
<span id="cb111-4"><a href="6-part2-containerizing-shiny-apps.html#cb111-4" tabindex="-1"></a><span class="co"># apt-get -y install libcurl4-openssl-dev libssl-dev</span></span>
<span id="cb111-5"><a href="6-part2-containerizing-shiny-apps.html#cb111-5" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb111-6"><a href="6-part2-containerizing-shiny-apps.html#cb111-6" tabindex="-1"></a><span class="co"># -- Packages and their system dependencies ------------------</span></span>
<span id="cb111-7"><a href="6-part2-containerizing-shiny-apps.html#cb111-7" tabindex="-1"></a><span class="co"># curl - libcurl4-openssl-dev, libssl-dev</span></span></code></pre></div>
<p>Include these libraries in your Dockerfile as:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb112-1"><a href="6-part2-containerizing-shiny-apps.html#cb112-1" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb112-2"><a href="6-part2-containerizing-shiny-apps.html#cb112-2" tabindex="-1"></a>    <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="at">--no-install-recommends</span> <span class="dt">\</span></span>
<span id="cb112-3"><a href="6-part2-containerizing-shiny-apps.html#cb112-3" tabindex="-1"></a>        libcurl4-openssl-dev <span class="dt">\</span></span>
<span id="cb112-4"><a href="6-part2-containerizing-shiny-apps.html#cb112-4" tabindex="-1"></a>        libssl-dev <span class="dt">\</span></span>
<span id="cb112-5"><a href="6-part2-containerizing-shiny-apps.html#cb112-5" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> <span class="at">-rf</span> /var/lib/apt/lists/<span class="pp">*</span></span></code></pre></div>
<p>When using <code>apt-get</code> (the older and stable version of <code>apt</code>) the first command is
always <code>apt-get update</code> which look for updates in the the package lists of
the package repositories. This way the system will know if an update is necessary
and where to find the individual packages. Next <code>apt-get install &lt;package-name&gt;</code>
is called with a few flags: <code>-y</code> means that we answer yes to all the prompts,
whereas <code>--no-install-recommends</code> will prevent unnecessary recommended packages
from being installed. The last bit cleans up the package lists downloaded by
<code>apt-get update</code> which are stored in the <code>/var/lib/apt/lists</code> folder.
All these three commands are chained together with <code>&amp;&amp;</code> and we used <code>\</code> for
breaking up single line commands to multiple lines for better readability
(the backslash escapes a newline character). This arrangement helps organize
the packages and you can also comment them out as needed.</p>
<p>You could put all of these chained commands in a separate <code>RUN</code>
line, but that is not recommended. Having a single <code>RUN</code> instruction will
lead to a single image layer. But what is most important is that the update and
install steps should not be separated. Imagine that you update the package lists
and now the resulting layer is added to the Docker cache.
The next time you add another package to install and rebuild your image.
The update command is cached and will not be rerun by default. As a result,
you might end up with an outdated version of the package.</p>
</div>
<div id="part2-install-system-libraries-r2u" class="section level3 hasAnchor" number="6.8.2">
<h3><span class="header-section-number">6.8.2</span> Automated Dependency Resolution with r2u<a href="6-part2-containerizing-shiny-apps.html#part2-install-system-libraries-r2u" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If you are using R on Ubuntu, the <a href="https://eddelbuettel.github.io/r2u/">r2u</a>
project greatly facilitate dependency management.
It uses the Debian package format for R packages for latest R version on
various Ubuntu LTS platforms. This resolves all the system dependencies through
using the <code>.deb</code> binary package format that combines together the pre-built binary
package with the metadata about the dependencies. Then the Debian/Ubuntu package
manager (<code>apt</code>) can do the rest.</p>
<p>The binary packages are base on P3M where available or built natively.
Selected BioConductor packages are also built natively on the project servers.
The server hosting the <code>.deb</code> files is set up as a proper <code>apt</code> repository
with a signed Release file containing metadata that can be used to
cryptographically validate every package in the repository. This file guarantees
that the packages you receive are the one you expected and there has been no
tampering with it during download.</p>
<p>Because the R packages now live as first class
citizens on Ubuntu, uninstalling packages would not unnecessarily remove the
shared dependencies that other packages depend on. With the r2u setup and
using the <code>rocker/r2u</code> images, you can simply call <code>install.packages("curl")</code>
and <code>apt</code> will sort out the dependencies for you in the background.</p>
</div>
<div id="part2-install-system-libraries-alpine" class="section level3 hasAnchor" number="6.8.3">
<h3><span class="header-section-number">6.8.3</span> Dependencies on Alpine Linux<a href="6-part2-containerizing-shiny-apps.html#part2-install-system-libraries-alpine" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The Alpine Linux has a package manager called <code>apk</code> that is different from
Debian’s and Ubuntu’s <code>apt</code>. This likely means that you might have to work
harder to find all the Alpine-specific dependencies. You can still use the
tools previously mentioned, but will have to find the library for Alpine.
You can also follow the breadcrumbs of the error messages of missing dependencies.
However, the general idea is similar when it comes to working with the Dockerfile:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb113-1"><a href="6-part2-containerizing-shiny-apps.html#cb113-1" tabindex="-1"></a><span class="kw">FROM</span> rhub/r-minimal:4.4.1</span>
<span id="cb113-2"><a href="6-part2-containerizing-shiny-apps.html#cb113-2" tabindex="-1"></a></span>
<span id="cb113-3"><a href="6-part2-containerizing-shiny-apps.html#cb113-3" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apk</span> add <span class="at">--no-cache</span> <span class="at">--update-cache</span> <span class="dt">\</span></span>
<span id="cb113-4"><a href="6-part2-containerizing-shiny-apps.html#cb113-4" tabindex="-1"></a>     <span class="at">--repository</span> http://nl.alpinelinux.org/alpine/v3.11/main <span class="dt">\</span></span>
<span id="cb113-5"><a href="6-part2-containerizing-shiny-apps.html#cb113-5" tabindex="-1"></a>    autoconf=2.69-r2 <span class="dt">\</span></span>
<span id="cb113-6"><a href="6-part2-containerizing-shiny-apps.html#cb113-6" tabindex="-1"></a>    automake=1.16.1-r0 <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb113-7"><a href="6-part2-containerizing-shiny-apps.html#cb113-7" tabindex="-1"></a>    <span class="ex">installr</span> <span class="at">-d</span> <span class="dt">\</span></span>
<span id="cb113-8"><a href="6-part2-containerizing-shiny-apps.html#cb113-8" tabindex="-1"></a>    <span class="at">-t</span> <span class="st">&quot;libsodium-dev curl-dev linux-headers gfortran autoconf automake&quot;</span> <span class="dt">\</span></span>
<span id="cb113-9"><a href="6-part2-containerizing-shiny-apps.html#cb113-9" tabindex="-1"></a>    <span class="at">-a</span> libsodium <span class="dt">\</span></span>
<span id="cb113-10"><a href="6-part2-containerizing-shiny-apps.html#cb113-10" tabindex="-1"></a>    shiny plotly e1071</span>
<span id="cb113-11"><a href="6-part2-containerizing-shiny-apps.html#cb113-11" tabindex="-1"></a>[...]</span></code></pre></div>
<p>First we declare the minimal parent image, then use a <code>RUN</code> instruction to add
libraries from the Alpine repository. <code>autoconf</code> and <code>automake</code> is required for
building the R packages (<code>shiny</code>, <code>plotly</code>, and <code>e1071</code>). This example is
taken from the minimal Dockerfile for the <a href="https://github.com/h10y/bananas">Bananas example app</a>.</p>
<p>The next pieces uses the <code>istallr</code> utility that comes with the <code>rhub/r-minimal</code>
image and it’s usage is explained on the GitHub site: <a href="https://github.com/r-hub/r-minimal" class="uri">https://github.com/r-hub/r-minimal</a>.
The <code>-d</code> flag will install C and C++ compilers (<code>gcc</code>, <code>musl-dev</code>,<code>g++</code>)
temporarily, i.e. those will be removed after the successful
compilation and installation of the R packages.</p>
<p>The <code>-t</code> option lists Alpine packages to be installed temporarily (a.k.a.
build time dependencies), and the <code>-a</code> option lists Alpine packages to keep
(a.k.a. run time dependencies). The built in cleanup feature keeps the image
sizes small in line with the goal of the parent image’s purpose.</p>
<p>You can also list not only CRAN packages but different “remotes”, like
<code>tidyverse/ggplot2</code> for development version of <code>ggplot2</code> from GitHub,
or <code>local::.</code> to install from a local directory.</p>
<p>The rest of the Dockerfile follow the same patterns as what we saw before. Adding
a non-root user, defining the work directory, copying the Shiny app files
from the build context to the image’s file system, setting owners for the files,
switching to the non-root user, exposing port 3838 and defining the default
command to run that calls <code>shiny::runApp()</code>:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb114-1"><a href="6-part2-containerizing-shiny-apps.html#cb114-1" tabindex="-1"></a>[...]</span>
<span id="cb114-2"><a href="6-part2-containerizing-shiny-apps.html#cb114-2" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">addgroup</span> <span class="at">--system</span> app <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb114-3"><a href="6-part2-containerizing-shiny-apps.html#cb114-3" tabindex="-1"></a>    <span class="ex">adduser</span> <span class="at">--system</span> <span class="at">--ingroup</span> app app</span>
<span id="cb114-4"><a href="6-part2-containerizing-shiny-apps.html#cb114-4" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/app</span>
<span id="cb114-5"><a href="6-part2-containerizing-shiny-apps.html#cb114-5" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb114-6"><a href="6-part2-containerizing-shiny-apps.html#cb114-6" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">chown</span> app:app <span class="at">-R</span> /home/app</span>
<span id="cb114-7"><a href="6-part2-containerizing-shiny-apps.html#cb114-7" tabindex="-1"></a><span class="kw">USER</span> app</span>
<span id="cb114-8"><a href="6-part2-containerizing-shiny-apps.html#cb114-8" tabindex="-1"></a><span class="kw">EXPOSE</span> 3838</span>
<span id="cb114-9"><a href="6-part2-containerizing-shiny-apps.html#cb114-9" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;R&quot;</span>, <span class="st">&quot;-e&quot;</span>, <span class="st">&quot;shiny::runApp(host=&#39;0.0.0.0&#39;, port=3838)&quot;</span>]</span></code></pre></div>
<p>The Dockerfile for the Faithful Shiny app (<a href="https://github.com/h10y/faithful" class="uri">https://github.com/h10y/faithful</a>)
is somewhat simpler:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb115-1"><a href="6-part2-containerizing-shiny-apps.html#cb115-1" tabindex="-1"></a><span class="kw">FROM</span> rhub/r-minimal:4.4.1</span>
<span id="cb115-2"><a href="6-part2-containerizing-shiny-apps.html#cb115-2" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">installr</span> <span class="at">-d</span> <span class="dt">\</span></span>
<span id="cb115-3"><a href="6-part2-containerizing-shiny-apps.html#cb115-3" tabindex="-1"></a>    <span class="at">-t</span> <span class="st">&quot;zlib-dev cairo-dev&quot;</span> <span class="dt">\</span></span>
<span id="cb115-4"><a href="6-part2-containerizing-shiny-apps.html#cb115-4" tabindex="-1"></a>    <span class="at">-a</span> <span class="st">&quot;cairo font-liberation&quot;</span> <span class="dt">\</span></span>
<span id="cb115-5"><a href="6-part2-containerizing-shiny-apps.html#cb115-5" tabindex="-1"></a>    Cairo <span class="dt">\</span></span>
<span id="cb115-6"><a href="6-part2-containerizing-shiny-apps.html#cb115-6" tabindex="-1"></a>    shiny</span>
<span id="cb115-7"><a href="6-part2-containerizing-shiny-apps.html#cb115-7" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">addgroup</span> <span class="at">--system</span> app <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb115-8"><a href="6-part2-containerizing-shiny-apps.html#cb115-8" tabindex="-1"></a>    <span class="ex">adduser</span> <span class="at">--system</span> <span class="at">--ingroup</span> app app</span>
<span id="cb115-9"><a href="6-part2-containerizing-shiny-apps.html#cb115-9" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/app</span>
<span id="cb115-10"><a href="6-part2-containerizing-shiny-apps.html#cb115-10" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb115-11"><a href="6-part2-containerizing-shiny-apps.html#cb115-11" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">chown</span> app:app <span class="at">-R</span> /home/app</span>
<span id="cb115-12"><a href="6-part2-containerizing-shiny-apps.html#cb115-12" tabindex="-1"></a><span class="kw">USER</span> app</span>
<span id="cb115-13"><a href="6-part2-containerizing-shiny-apps.html#cb115-13" tabindex="-1"></a><span class="kw">EXPOSE</span> 3838</span>
<span id="cb115-14"><a href="6-part2-containerizing-shiny-apps.html#cb115-14" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;R&quot;</span>, <span class="st">&quot;-e&quot;</span>, <span class="st">&quot;shiny::runApp(host=&#39;0.0.0.0&#39;, port=3838)&quot;</span>]</span></code></pre></div>
<p>The reason why we need the <code>Cairo</code> package <span class="citation">(<a href="#ref-R-Cairo">Urbanek and Horner 2023</a>)</span> besides <code>shiny</code> is because the minimal
image has no X11 graphic device support which is used to display base R plots, like histograms.
Instead of X11, we can use the Cairo Graphics Library. You can see how we list
the build time <code>cairo-dev</code> library and the run time <code>cairo</code> for the R package.</p>
<p>The installation of the system packages and the general lack of available
binary packages contributes to the longer build times. The Faithful example
took 5 minutes to build with <code>rhub/r-minimal</code> compared to 16 seconds with
<code>rocker/r2u</code> and the final image size was 230 MB compared to 975 MB.
The Bananas app took 10.4 minutes vs. 28 seconds and resulted in an image of
size 113 MB as opposed to 909 MB.</p>
<p>As you can see, the image build time is significantly longer, while the minimal
image size is multiplying relative to the parent image’s 45 MB size. The absolute
increase in the Ubuntu based image’s size is similar but it is less noticeable
in relative terms.</p>
<p>Your Shiny apps are likely to have more dependencies that the examples we are
using in this book. You will have to decide if the benefits that a minimal
image provides will overweight the increased complexity and development time
required to maintain minimalist Shiny images.</p>
</div>
</div>
<div id="part2-install-r-pkg" class="section level2 hasAnchor" number="6.9">
<h2><span class="header-section-number">6.9</span> Installing R Packages<a href="6-part2-containerizing-shiny-apps.html#part2-install-r-pkg" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The wealth of contributed R packages can supercharge Shiny app
development. This also means that you have to manage these dependencies.
In the previous sections, we have already hinted at installing these packages.
We will now see the different ways of installing R packages.</p>
<div id="part2-install-r-pkg-explicit" class="section level3 hasAnchor" number="6.9.1">
<h3><span class="header-section-number">6.9.1</span> Explicitly Stating Dependencies<a href="6-part2-containerizing-shiny-apps.html#part2-install-r-pkg-explicit" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The first approach is to use <code>RUN</code> instructions in the Dockerfile to
install the required packages. You can use the <code>R -q -e "&lt;expression&gt;"</code>
pattern to use any R expression you would normally use in your R sessions
to install packages. The <code>-q</code> flag stands for quiet and means to not print out
the startup message. The <code>-e</code> option means to execute the R expression that
follows it and then exit. The <code>Rscript -e "&lt;expression&gt;"</code> is another way to
evaluate the expressions without echoing the expression itself.
Most often we use the built in <code>install.packages()</code>
function and the different options from the <code>remotes</code> package <span class="citation">(<a href="#ref-R-remotes">Csárdi et al. 2024</a>)</span>.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb116-1"><a href="6-part2-containerizing-shiny-apps.html#cb116-1" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;install.packages(c(&#39;shiny&#39;, &#39;remotes&#39;))&quot;</span></span>
<span id="cb116-2"><a href="6-part2-containerizing-shiny-apps.html#cb116-2" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;remotes::install_github(&#39;tidyverse/ggplot2&#39;)&quot;</span></span>
<span id="cb116-3"><a href="6-part2-containerizing-shiny-apps.html#cb116-3" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;remotes::install_local(&#39;.&#39;)&quot;</span></span></code></pre></div>
<p>The Rocker images have the <code>littler</code> command line utility installed.
The previous code piece can be written as:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb117-1"><a href="6-part2-containerizing-shiny-apps.html#cb117-1" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">install2.r</span> <span class="at">--error</span> <span class="at">--skipinstalled</span> shiny remotes</span>
<span id="cb117-2"><a href="6-part2-containerizing-shiny-apps.html#cb117-2" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">installGithub</span> tidyverse/ggplot2</span>
<span id="cb117-3"><a href="6-part2-containerizing-shiny-apps.html#cb117-3" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">install2.r</span> <span class="st">&quot;.&quot;</span></span></code></pre></div>
<p>The <code>--error</code> flag will throw an error when installation is unsuccessful
instead of a warning, <code>--skipinstalled</code> will skip installing already installed
packages.</p>
<p>If installing from a private GitHub repository, <code>remotes</code> is going to use
the <code>GITHUB_PAT</code> environment variable to authenticate with GitHub to be able to
download and install the package. You have to add the following line to your
<code>Dockerfile</code> before the <code>RUN</code> instructions that define the install from GitHub:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb118-1"><a href="6-part2-containerizing-shiny-apps.html#cb118-1" tabindex="-1"></a><span class="kw">ARG</span> GITHUB_PAT</span></code></pre></div>
<p>To pass the <code>GITHUB_PAT</code> at image build, use the following commands:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb119-1"><a href="6-part2-containerizing-shiny-apps.html#cb119-1" tabindex="-1"></a>  <span class="bu">export</span> <span class="va">GITHUB_PAT</span><span class="op">=</span>ghp_xxxxxxxxxx</span>
<span id="cb119-2"><a href="6-part2-containerizing-shiny-apps.html#cb119-2" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> <span class="op">&lt;</span>image-name<span class="op">&gt;</span> --build-arg=<span class="st">&quot;GITHUB_PAT=</span><span class="va">${GITHUB_PAT}</span><span class="st">&quot;</span> .</span></code></pre></div>
<p>The <code>pak</code> R package <span class="citation">(<a href="#ref-R-pak">Csárdi and Hester 2024</a>)</span> is planned to replace <code>remotes</code> in the future.
It provides very similar functionality and improvements, like parallel downloads,
caching, safe dependency solver for packages and system dependencies using
the P3M database by creating an installation plan before downloading any packages.
Not relevant for Linux containers, but <code>pak</code> can even handle locked package DLLs
on Windows. Let’s see how these common install statements would look using <code>pak</code>
(you don’t need <code>remotes</code> because of using <code>pak</code>):</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb120-1"><a href="6-part2-containerizing-shiny-apps.html#cb120-1" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;install.packages(&#39;pak&#39;)&quot;</span></span>
<span id="cb120-2"><a href="6-part2-containerizing-shiny-apps.html#cb120-2" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;pak::pkg_install(&#39;shiny&#39;))&quot;</span></span>
<span id="cb120-3"><a href="6-part2-containerizing-shiny-apps.html#cb120-3" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;pak::pkg_install(&#39;tidyverse/ggplot2&#39;)&quot;</span></span>
<span id="cb120-4"><a href="6-part2-containerizing-shiny-apps.html#cb120-4" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;pak::pkg_install(&#39;.&#39;)&quot;</span></span></code></pre></div>
<p>The <code>installr</code> utility shipped with the <code>rhub/r-minimal</code> image uses <code>pak</code>
to install packages. The <code>-p</code> flag will remove <code>pak</code> after the installation.
You can do:</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb121-1"><a href="6-part2-containerizing-shiny-apps.html#cb121-1" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">installr</span> <span class="at">-p</span> shiny tidyverse/ggplot2 local::.</span></code></pre></div>
<p>You can pin package versions using Git references, e.g. <code>tidyverse/ggplot2@v1.0.0</code>,
or using <code>remotes::install_version()</code>.</p>
<p>These functions allow you to provide repositories as argument. But more often,
the repositories are set globally as part of <code>options()</code>. You can include
the list of repositories in the <code>Rprofile.site</code> file:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="6-part2-containerizing-shiny-apps.html#cb122-1" tabindex="-1"></a><span class="co"># Rprofile.site</span></span>
<span id="cb122-2"><a href="6-part2-containerizing-shiny-apps.html#cb122-2" tabindex="-1"></a><span class="fu">local</span>({</span>
<span id="cb122-3"><a href="6-part2-containerizing-shiny-apps.html#cb122-3" tabindex="-1"></a>    r <span class="ot">&lt;-</span> <span class="fu">getOption</span>(<span class="st">&quot;repos&quot;</span>)</span>
<span id="cb122-4"><a href="6-part2-containerizing-shiny-apps.html#cb122-4" tabindex="-1"></a>    r[<span class="st">&quot;p3m&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;https://p3m.dev/cran/__linux__/noble/2024-07-09&quot;</span></span>
<span id="cb122-5"><a href="6-part2-containerizing-shiny-apps.html#cb122-5" tabindex="-1"></a>    r[<span class="st">&quot;archive&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;https://cranhaven.r-universe.dev&quot;</span></span>
<span id="cb122-6"><a href="6-part2-containerizing-shiny-apps.html#cb122-6" tabindex="-1"></a>    r[<span class="st">&quot;CRAN&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;https://cloud.r-project.org&quot;</span></span>
<span id="cb122-7"><a href="6-part2-containerizing-shiny-apps.html#cb122-7" tabindex="-1"></a>    <span class="fu">options</span>(<span class="at">repos =</span> r)</span>
<span id="cb122-8"><a href="6-part2-containerizing-shiny-apps.html#cb122-8" tabindex="-1"></a>})</span></code></pre></div>
<p>The P3M repository is set for Ubuntu 24.04 (Noble) with a snapshot of
CRAN taken on July 9th, 2024. This effectively freezes package versions to
enhance reproducibility. This way of pining maximum package versions is also
called “time travel”. The <a href="https://www.cranhaven.org">CRAN Haven</a>
repository is for recently archived CRAN packages. These archived packages might
find their way back to CRAN after addressing the issues for which those got
archived. This repository can handle such temporary inconveniences.
<code>COPY</code> this file into the <code>/etc/R</code> folder on the Rocker images:</p>
<pre><code>COPY Rprofile.site /etc/R</code></pre>
<p>As you develop your Shiny app, you will have to occasionally update the <code>Dockerfile</code>
to add manually in any new dependencies. If you forget to do this you will be
reminded by an error the next time you build your Docker image and run your app.</p>
</div>
<div id="part2-install-r-pkg-description" class="section level3 hasAnchor" number="6.9.2">
<h3><span class="header-section-number">6.9.2</span> Using the DESCRIPTION File<a href="6-part2-containerizing-shiny-apps.html#part2-install-r-pkg-description" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>You have seen how to use <code>remotes::install_local()</code> to install a dependency
from a local directory or a <code>.tar.gz</code> source file. The list of packages to be
installed is determined by the <code>DESCRIPTION</code> file that is at the base of any
package folder. It lists the dependencies of the packages.</p>
<p>Packages listed under the <code>Imports</code> field are installed and needed by the
package. Other packages listed under the <code>Suggests</code> field are needed for
development but are not essential for using the package.</p>
<p>A commonly used hack in the R community is to highjack the package development
tooling to simplify installation of the codebase even if it is
not necessarily structured as a package. The only thing you need for
<code>remotes::install_local()</code> and similar functions to work is the
<code>DESCRIPTION</code> file. You don’t even need all the customary fields like title,
description, or package maintainer in this file.</p>
<p>For the Bananas app, we need <code>shiny</code>, <code>plotly</code> and the <code>e1071</code> package listed
under <code>Imports</code>. Put this in the <code>DESCRIPTION</code> file:</p>
<pre class="text"><code>Imports: e1071, plotly, shiny</code></pre>
<p>In the <code>Dockerfile</code> you need to <code>COPY</code> the <code>DESCRIPTION</code> file into the
file system of the image, then call the <code>remotes::install_deps()</code> function.
The <code>upgrade='never'</code> argument will prevent installing newer versions of existing
packages, thus cutting down unnecessary install time:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb125-1"><a href="6-part2-containerizing-shiny-apps.html#cb125-1" tabindex="-1"></a><span class="kw">FROM</span> rocker/r2u:24.04</span>
<span id="cb125-2"><a href="6-part2-containerizing-shiny-apps.html#cb125-2" tabindex="-1"></a></span>
<span id="cb125-3"><a href="6-part2-containerizing-shiny-apps.html#cb125-3" tabindex="-1"></a><span class="kw">COPY</span> app/DESCRIPTION .</span>
<span id="cb125-4"><a href="6-part2-containerizing-shiny-apps.html#cb125-4" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;remotes::install_deps(upgrade=&#39;never&#39;)&quot;</span></span>
<span id="cb125-5"><a href="6-part2-containerizing-shiny-apps.html#cb125-5" tabindex="-1"></a></span>
<span id="cb125-6"><a href="6-part2-containerizing-shiny-apps.html#cb125-6" tabindex="-1"></a>[...]</span></code></pre></div>
<p>You can use the <code>Rprofile.site</code> to specify your preferred repositories.
The <code>remotes</code> functions will respect those settings.</p>
<p>Using the <code>DESCRIPTION</code> file lets you record the dependencies
outside of your <code>Dockerfile</code>. As you develop your Shiny app, you have to update
the <code>DESCRIPTION</code>. When the file changes, Docker will invalidate the cache and
install the dependencies with the new packages included.</p>
</div>
<div id="part2-install-r-pkg-renv" class="section level3 hasAnchor" number="6.9.3">
<h3><span class="header-section-number">6.9.3</span> Using renv<a href="6-part2-containerizing-shiny-apps.html#part2-install-r-pkg-renv" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>renv</code> package <span class="citation">(<a href="#ref-R-renv">Ushey and Wickham 2024</a>)</span> is a dependency management toolkit for R.
You can create and manage R libraries in your local project and record the state
of these libraries to a lockfile. This lockfile can be used later to restore
the project, thus making projects more isolated, portable, and reproducible.</p>
<p>If you are using <code>renv</code> with your Shiny projects, you are probably already
familiar with the workflow. You can discover dependencies with <code>renv::init()</code>
and occasionally save the state of these libraries to a lockfile with
<code>renv::snapshot()</code>. The nice thing about this approach is that the exact version
of each package is recorded that makes Docker builds reproducible as well.</p>
<p>The renv package has a few different snapshot modes.
The default is called “implicit”. This mode adds the intersection of all
your installed packages and those used in your project as inferred by
<code>renv::dependencies()</code> to the lockfile.</p>
<p>The other mode is called “explicit” snapshot that only captures packages
that are listed in the project <code>DESCRIPTION</code>.
The “custom” model lets you specify filters for modifying the implicit
snapshot, so that you will not end up with the kitchen sink of packages in
your Docker image. Read the <em>Using renv with Docker</em> vignette of <code>renv</code> for
more useful tips.</p>
<p>Once you have the lockfile in your project folder, you can use it like this:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb126-1"><a href="6-part2-containerizing-shiny-apps.html#cb126-1" tabindex="-1"></a>[...]</span>
<span id="cb126-2"><a href="6-part2-containerizing-shiny-apps.html#cb126-2" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">install.r</span> renv</span>
<span id="cb126-3"><a href="6-part2-containerizing-shiny-apps.html#cb126-3" tabindex="-1"></a><span class="kw">COPY</span> app/renv.lock .</span>
<span id="cb126-4"><a href="6-part2-containerizing-shiny-apps.html#cb126-4" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;options(renv.consent=TRUE);renv::restore()&quot;</span></span>
<span id="cb126-5"><a href="6-part2-containerizing-shiny-apps.html#cb126-5" tabindex="-1"></a>[...]</span></code></pre></div>
<p>You have to install <code>renv</code>, copy the <code>renv.lock</code> file over, and use the
<code>renv::restore()</code> command. The <code>renv.consent</code> option gives consent to <code>renv</code>
to write and update certain files.</p>
<p><code>renv</code> pins the exact package versions in the lockfile. This is necessary for
reproducibility. But full reproducibility is much harder than just the version
of R and the package versions. You have to think about the operating system,
your system dependencies, and even the hardware <span class="citation">(<a href="#ref-Rodrigues2023">Rodrigues 2023</a>)</span>.</p>
<p>Exact package versions could take quite long to install. The reason for that is
that binary version of the packages might disappear from the package repositories.
In that case, <code>renv</code> will install it from source and it will need possible
build time dependencies. The older the lockfile gets, the more problematic
it can be to install it without hiccups.</p>
</div>
<div id="part2-install-r-pkg-deps" class="section level3 hasAnchor" number="6.9.4">
<h3><span class="header-section-number">6.9.4</span> Using deps<a href="6-part2-containerizing-shiny-apps.html#part2-install-r-pkg-deps" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>renv</code> goes to great lengths to make your R projects perfectly
reproducible. This requires knowing the exact package versions and the
source where it was installed from (CRAN, remotes, local files). This
information is registered in the lock file, which serves as the manifest
for recreating the exact replica of the environment.</p>
<p>Full reproducibility is often required for reports, markdown-based
documents, and scripts. These are loosely defined projects combined with
strict version requirements, often erring on the side of “more
dependencies are safer”.</p>
<p>On the other end of the spectrum, you have package-based development.
This is the main use case for dependency management-oriented packages,
such as <code>remotes</code> and <code>pak</code>.</p>
<p>In this case, exact versions are managed only to the extent of avoiding
breaking changes (given that testing can surface these). So what we have
is a package-based workflow combined with a “no breaking changes”
philosophy to version requirements. This approach often leads to leaner
installation.</p>
<p>If you are developing your Shiny app as an R package, then the
package-based development is probably the way to go. You already have a
<code>DESCRIPTION</code> file, so just keep developing.</p>
<p>But what if you are not writing an R package and wanted to combine the best
of both approaches? A loosely defined project with just strict-enough
version requirements without having to manage a <code>DESCRIPTION</code> file.
Why would you need a <code>DESCRIPTION</code> file when you have no R package?
Also, there is a lot that a <code>DESCRIPTION</code> file won’t do for you.</p>
<p>You can manage dependencies with the <code>deps</code> <span class="citation">(<a href="#ref-R-deps">Sólymos 2024</a>)</span> package by decorating your
existing R code with special, roxygen-style comments. For example, here is
how you can specify a remote, and alternative CRAN-like repository, pin
a package version, or install from a local source:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="6-part2-containerizing-shiny-apps.html#cb127-1" tabindex="-1"></a><span class="co">#&#39; @remote analythium/rconfig@CRAN-v0.1.3</span></span>
<span id="cb127-2"><a href="6-part2-containerizing-shiny-apps.html#cb127-2" tabindex="-1"></a>rconfig<span class="sc">::</span><span class="fu">config</span>()</span>
<span id="cb127-3"><a href="6-part2-containerizing-shiny-apps.html#cb127-3" tabindex="-1"></a></span>
<span id="cb127-4"><a href="6-part2-containerizing-shiny-apps.html#cb127-4" tabindex="-1"></a><span class="co">#&#39; @repo sf https://r-spatial.r-universe.dev</span></span>
<span id="cb127-5"><a href="6-part2-containerizing-shiny-apps.html#cb127-5" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb127-6"><a href="6-part2-containerizing-shiny-apps.html#cb127-6" tabindex="-1"></a></span>
<span id="cb127-7"><a href="6-part2-containerizing-shiny-apps.html#cb127-7" tabindex="-1"></a><span class="co">#&#39; @ver rgl 0.108.3</span></span>
<span id="cb127-8"><a href="6-part2-containerizing-shiny-apps.html#cb127-8" tabindex="-1"></a><span class="fu">library</span>(rgl)</span>
<span id="cb127-9"><a href="6-part2-containerizing-shiny-apps.html#cb127-9" tabindex="-1"></a></span>
<span id="cb127-10"><a href="6-part2-containerizing-shiny-apps.html#cb127-10" tabindex="-1"></a><span class="co">#&#39; @local mypackage_0.1.0.tar.gz</span></span>
<span id="cb127-11"><a href="6-part2-containerizing-shiny-apps.html#cb127-11" tabindex="-1"></a><span class="fu">library</span>(mypackage)</span></code></pre></div>
<p>You can exclude development packages with the <code>@dev</code> decorator and list
system requirements following the <code>@sys</code> decorator.</p>
<p><code>deps</code> helps to find all dependencies from our files using <code>renv::dependencies()</code>.
It writes these dependencies into the <code>dependencies.json</code> file, including the
information contained in the comments when using the <code>deps::create()</code> function.
The decorators make your intent explicit, just like if we were writing an
R package. But we do not need to manually write these into a file and
keep it up-to-date. We can just rerun <code>create()</code> to update the JSON
manifest file.</p>
<p><code>create()</code> crawls the project directory for package dependencies. It
will amend the dependency list and package sources based on the
comments. The other function in <code>deps</code> is <code>install()</code> which looks for the <code>dependencies.json</code>
file in the root of the project directory (or runs <code>create()</code> when the JSON file
is not found) and performs dependency installation according to the
instructions in the JSON file.</p>
<p>Here is the Dockerfile usage where first we install the <code>deps</code> package and
copy the <code>dependencies.json</code>. The next <code>RUN</code> instruction is needed if you
had system requirements specified via <code>@sys</code>. The <code>jq</code> package is used to
parse the JSON and install any of these libraries. Finally, the line with
<code>deps::install()</code> that performs the R package installation based on the JSON file:</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb128-1"><a href="6-part2-containerizing-shiny-apps.html#cb128-1" tabindex="-1"></a>[...]</span>
<span id="cb128-2"><a href="6-part2-containerizing-shiny-apps.html#cb128-2" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">install.r</span> deps</span>
<span id="cb128-3"><a href="6-part2-containerizing-shiny-apps.html#cb128-3" tabindex="-1"></a><span class="kw">COPY</span> app/dependencies.json .</span>
<span id="cb128-4"><a href="6-part2-containerizing-shiny-apps.html#cb128-4" tabindex="-1"></a></span>
<span id="cb128-5"><a href="6-part2-containerizing-shiny-apps.html#cb128-5" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb128-6"><a href="6-part2-containerizing-shiny-apps.html#cb128-6" tabindex="-1"></a>    <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="at">--no-install-recommends</span> <span class="dt">\</span></span>
<span id="cb128-7"><a href="6-part2-containerizing-shiny-apps.html#cb128-7" tabindex="-1"></a>    jq</span>
<span id="cb128-8"><a href="6-part2-containerizing-shiny-apps.html#cb128-8" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb128-9"><a href="6-part2-containerizing-shiny-apps.html#cb128-9" tabindex="-1"></a>    <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="at">--no-install-recommends</span> <span class="dt">\</span></span>
<span id="cb128-10"><a href="6-part2-containerizing-shiny-apps.html#cb128-10" tabindex="-1"></a>    <span class="va">$(</span> <span class="ex">jq</span> <span class="at">-r</span> <span class="st">&#39;.sysreqs | join(&quot; &quot;)&#39;</span> dependencies.json <span class="va">)</span></span>
<span id="cb128-11"><a href="6-part2-containerizing-shiny-apps.html#cb128-11" tabindex="-1"></a></span>
<span id="cb128-12"><a href="6-part2-containerizing-shiny-apps.html#cb128-12" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;deps::install()&quot;</span></span>
<span id="cb128-13"><a href="6-part2-containerizing-shiny-apps.html#cb128-13" tabindex="-1"></a>[...]</span></code></pre></div>
<p>The <code>deps</code> package comes with a small command line utility that can be
added to the dockerfile to simplify the installation process:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb129-1"><a href="6-part2-containerizing-shiny-apps.html#cb129-1" tabindex="-1"></a><span class="kw">FROM</span> rocker/r2u:24.04</span>
<span id="cb129-2"><a href="6-part2-containerizing-shiny-apps.html#cb129-2" tabindex="-1"></a></span>
<span id="cb129-3"><a href="6-part2-containerizing-shiny-apps.html#cb129-3" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">install.r</span> pak rconfig deps</span>
<span id="cb129-4"><a href="6-part2-containerizing-shiny-apps.html#cb129-4" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">cp</span> <span class="at">-p</span> <span class="dt">\</span></span>
<span id="cb129-5"><a href="6-part2-containerizing-shiny-apps.html#cb129-5" tabindex="-1"></a>    <span class="va">$(</span><span class="ex">R</span> RHOME<span class="va">)</span>/site-library/deps/examples/03-cli/deps-cli.R <span class="dt">\</span></span>
<span id="cb129-6"><a href="6-part2-containerizing-shiny-apps.html#cb129-6" tabindex="-1"></a>    /usr/local/bin/deps-cli</span>
<span id="cb129-7"><a href="6-part2-containerizing-shiny-apps.html#cb129-7" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">chmod</span> +x /usr/local/bin/deps-cli</span>
<span id="cb129-8"><a href="6-part2-containerizing-shiny-apps.html#cb129-8" tabindex="-1"></a></span>
<span id="cb129-9"><a href="6-part2-containerizing-shiny-apps.html#cb129-9" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb129-10"><a href="6-part2-containerizing-shiny-apps.html#cb129-10" tabindex="-1"></a></span>
<span id="cb129-11"><a href="6-part2-containerizing-shiny-apps.html#cb129-11" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">deps-cli</span> all</span>
<span id="cb129-12"><a href="6-part2-containerizing-shiny-apps.html#cb129-12" tabindex="-1"></a>[...]</span></code></pre></div>
<p>The <code>deps-cli all</code> command will analyze dependencies and install system and R
dependencies in 1 line. It also looks for the following files before attempting
to auto-detect dependencies in the absence of the <code>dependencies.json</code>:
<code>renv.lock</code>, <code>pkg.lock</code>, and <code>DESCRIPTION</code>. <code>pkg.lock</code> is the lockfile created
by <code>pak</code>.</p>
</div>
</div>
<div id="part2-install-python" class="section level2 hasAnchor" number="6.10">
<h2><span class="header-section-number">6.10</span> Python Requirements<a href="6-part2-containerizing-shiny-apps.html#part2-install-python" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>FIXME: Add content here.</p>
<ul>
<li>renv <a href="https://cran.r-project.org/web/packages/renv/vignettes/python.html" class="uri">https://cran.r-project.org/web/packages/renv/vignettes/python.html</a></li>
<li>pip</li>
<li>Conda, venv? Docker’s purpose is isolation, so multiple venv’s do not make sense in containers according to some posts. Maybe explain that here?</li>
<li>mention shinylive installs</li>
<li>how to reuse <code>.cache</code> by mounting it: <a href="https://testdriven.io/blog/docker-best-practices/#cache-python-packages-to-the-docker-host" class="uri">https://testdriven.io/blog/docker-best-practices/#cache-python-packages-to-the-docker-host</a></li>
</ul>
</div>
<div id="part2-dynamic-shiny-apps" class="section level2 hasAnchor" number="6.11">
<h2><span class="header-section-number">6.11</span> Dynamic Shiny Apps<a href="6-part2-containerizing-shiny-apps.html#part2-dynamic-shiny-apps" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Dynamic Shiny app require a runtime environment on a host server that can support
the HTTP and websocket connections required for R and Python to communicate with
the client (Fig. <a href="5-part2-developing-shiny-apps.html#fig:part2-shiny-lifecycle">5.6</a>). Now that we have
reviewed Shiny app development and general principles of working with Docker,
we can dive into specific examples. We will use the Old Faithful example.
You can follow along using the code in the repository at <a href="https://github.com/h10y/faithful" class="uri">https://github.com/h10y/faithful</a>.</p>
<p>There are many examples organized into folders inside the repo. Consult the
readme file about each of these. In general, we provide Docker images
for the dynamic Shiny app examples in the form of
<code>h10y/faithful/&lt;folder-name&gt;:latest</code>. You can use <code>docker run</code> to pull and
start the Shiny app as:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb130-1"><a href="6-part2-containerizing-shiny-apps.html#cb130-1" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-p</span> 8080:3838 ghcr.io/h10y/faithful/<span class="op">&lt;</span>folder-name<span class="op">&gt;</span>:latest</span></code></pre></div>
<p>Visit <code>http://localhost:8080</code> in your browser to try the app.</p>
<div id="part2-dynamic-shiny-apps-r" class="section level3 hasAnchor" number="6.11.1">
<h3><span class="header-section-number">6.11.1</span> R<a href="6-part2-containerizing-shiny-apps.html#part2-dynamic-shiny-apps-r" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The simplest containerized app follows the Dockerfile examples for R that you
have seen so far. We provide two Dockerfiles, one for the <code>rocker/r2u</code> and one
for the <code>rhub/r-minimal</code> image within the <code>r-shiny</code> folder. Follow this example
if your Shiny app consists of a single or multiple files. Put those files in the
<code>app</code> folder. Pick your favorite way of specifying your dependencies, and edit the
<code>Dockerfile</code> accordingly. The <code>CMD</code> instruction for this type of setup is
<code>shiny::runApp()</code>.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb131-1"><a href="6-part2-containerizing-shiny-apps.html#cb131-1" tabindex="-1"></a><span class="kw">FROM</span> rocker/r2u:24.04</span>
<span id="cb131-2"><a href="6-part2-containerizing-shiny-apps.html#cb131-2" tabindex="-1"></a></span>
<span id="cb131-3"><a href="6-part2-containerizing-shiny-apps.html#cb131-3" tabindex="-1"></a><span class="co"># Add here your dependencies</span></span>
<span id="cb131-4"><a href="6-part2-containerizing-shiny-apps.html#cb131-4" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;install.packages(&#39;shiny&#39;)&quot;</span></span>
<span id="cb131-5"><a href="6-part2-containerizing-shiny-apps.html#cb131-5" tabindex="-1"></a></span>
<span id="cb131-6"><a href="6-part2-containerizing-shiny-apps.html#cb131-6" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">groupadd</span> app <span class="kw">&amp;&amp;</span> <span class="ex">useradd</span> <span class="at">-g</span> app app</span>
<span id="cb131-7"><a href="6-part2-containerizing-shiny-apps.html#cb131-7" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/app</span>
<span id="cb131-8"><a href="6-part2-containerizing-shiny-apps.html#cb131-8" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb131-9"><a href="6-part2-containerizing-shiny-apps.html#cb131-9" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">chown</span> app:app <span class="at">-R</span> /home/app</span>
<span id="cb131-10"><a href="6-part2-containerizing-shiny-apps.html#cb131-10" tabindex="-1"></a><span class="kw">USER</span> app</span>
<span id="cb131-11"><a href="6-part2-containerizing-shiny-apps.html#cb131-11" tabindex="-1"></a><span class="kw">EXPOSE</span> 3838</span>
<span id="cb131-12"><a href="6-part2-containerizing-shiny-apps.html#cb131-12" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;R&quot;</span>, <span class="st">&quot;-e&quot;</span>, <span class="st">&quot;shiny::runApp(host=&#39;0.0.0.0&#39;, port=3838)&quot;</span>]</span></code></pre></div>
<p>If your Shiny app is organized as nested files following the structure expected
by the <code>rhino</code> package, check the <code>r-rhino</code> folder for an example.
<code>rhino</code> relies on the <code>renv</code> package for dependency management, so edit the
Dockerfile accordingly. The <code>CMD</code> instruction for a Rhino app is the same as
for the <code>r-shiny</code> setup, because Rhiny uses an <code>app.R</code> file as its entrypoint
that is being recognized by Posit products as a Shiny app. <code>shiny::runApp()</code>
will also recognize it as a Shiny app. The <code>app.R</code> file has a single
command, <code>rhino::app()</code>, that returns a Shiny app object.</p>
<p>If you follow a package based development for your Shiny app, check out the
<code>r-package</code>, <code>r-golem</code>, and <code>r-leprechaun</code> folders for Dockerfile examples.
Here is the <code>r-package</code> example that does not follow any specific framework,
but uses the <code>DESCRIPTION</code> file to define its dependencies that will be picked
up by <code>remotes::install_local()</code>. At the end, we call a function from the package
itself to launch the Shiny app, i.e. <code>faithful::run_app()</code>:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb132-1"><a href="6-part2-containerizing-shiny-apps.html#cb132-1" tabindex="-1"></a><span class="kw">FROM</span> rocker/r2u:24.04</span>
<span id="cb132-2"><a href="6-part2-containerizing-shiny-apps.html#cb132-2" tabindex="-1"></a></span>
<span id="cb132-3"><a href="6-part2-containerizing-shiny-apps.html#cb132-3" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">groupadd</span> app <span class="kw">&amp;&amp;</span> <span class="ex">useradd</span> <span class="at">-g</span> app app</span>
<span id="cb132-4"><a href="6-part2-containerizing-shiny-apps.html#cb132-4" tabindex="-1"></a></span>
<span id="cb132-5"><a href="6-part2-containerizing-shiny-apps.html#cb132-5" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;install.packages(&#39;remotes&#39;)&quot;</span></span>
<span id="cb132-6"><a href="6-part2-containerizing-shiny-apps.html#cb132-6" tabindex="-1"></a><span class="kw">COPY</span> faithful faithful</span>
<span id="cb132-7"><a href="6-part2-containerizing-shiny-apps.html#cb132-7" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;remotes::install_local(&#39;faithful&#39;)&quot;</span></span>
<span id="cb132-8"><a href="6-part2-containerizing-shiny-apps.html#cb132-8" tabindex="-1"></a></span>
<span id="cb132-9"><a href="6-part2-containerizing-shiny-apps.html#cb132-9" tabindex="-1"></a><span class="kw">USER</span> app</span>
<span id="cb132-10"><a href="6-part2-containerizing-shiny-apps.html#cb132-10" tabindex="-1"></a><span class="kw">EXPOSE</span> 3838</span>
<span id="cb132-11"><a href="6-part2-containerizing-shiny-apps.html#cb132-11" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;R&quot;</span>, <span class="st">&quot;-e&quot;</span>, <span class="st">&quot;faithful::run_app(host=&#39;0.0.0.0&#39;, port=3838)&quot;</span>]</span></code></pre></div>
<p>The <code>install.packages('remotes')</code> line is not necessary for the <code>rocker/r2u</code>
image because it comes preinstalled. But we left the line there so that the
Dockerfiles can be used with other parent images that might not have <code>remotes</code>
available.</p>
<p>The Golem and Leprechaun framework based Dockerfiles are slight variations of
this. Here is the one with Golem:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb133-1"><a href="6-part2-containerizing-shiny-apps.html#cb133-1" tabindex="-1"></a>[...]</span>
<span id="cb133-2"><a href="6-part2-containerizing-shiny-apps.html#cb133-2" tabindex="-1"></a><span class="kw">COPY</span> faithfulGolem faithfulGolem</span>
<span id="cb133-3"><a href="6-part2-containerizing-shiny-apps.html#cb133-3" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;remotes::install_local(&#39;faithfulGolem&#39;)&quot;</span></span>
<span id="cb133-4"><a href="6-part2-containerizing-shiny-apps.html#cb133-4" tabindex="-1"></a>[...]</span>
<span id="cb133-5"><a href="6-part2-containerizing-shiny-apps.html#cb133-5" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;R&quot;</span>, <span class="st">&quot;-e&quot;</span>, <span class="st">&quot;faithfulGolem::run_app( </span><span class="op">\</span></span>
<span id="cb133-6"><a href="6-part2-containerizing-shiny-apps.html#cb133-6" tabindex="-1"></a><span class="st">    options=list(host=&#39;0.0.0.0&#39;, port=3838))&quot;</span>]</span></code></pre></div>
<p>The same with Leprechaun:</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb134-1"><a href="6-part2-containerizing-shiny-apps.html#cb134-1" tabindex="-1"></a>[...]</span>
<span id="cb134-2"><a href="6-part2-containerizing-shiny-apps.html#cb134-2" tabindex="-1"></a><span class="kw">COPY</span> faithfulLeprechaun faithfulLeprechaun</span>
<span id="cb134-3"><a href="6-part2-containerizing-shiny-apps.html#cb134-3" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;remotes::install_local(&#39;faithfulLeprechaun&#39;)&quot;</span></span>
<span id="cb134-4"><a href="6-part2-containerizing-shiny-apps.html#cb134-4" tabindex="-1"></a>[...]</span>
<span id="cb134-5"><a href="6-part2-containerizing-shiny-apps.html#cb134-5" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;R&quot;</span>, <span class="st">&quot;-e&quot;</span>, <span class="st">&quot;faithfulLeprechaun::run( </span><span class="op">\</span></span>
<span id="cb134-6"><a href="6-part2-containerizing-shiny-apps.html#cb134-6" tabindex="-1"></a><span class="st">    options=list(host=&#39;0.0.0.0&#39;, port=3838))&quot;</span>]</span></code></pre></div>
</div>
<div id="part2-dynamic-shiny-apps-python" class="section level3 hasAnchor" number="6.11.2">
<h3><span class="header-section-number">6.11.2</span> Python<a href="6-part2-containerizing-shiny-apps.html#part2-dynamic-shiny-apps-python" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The Python version of the app follows similar principles. You can find it in the
<code>py-shiny</code> folder. The parent image is <code>python:3.9</code>, and dependency management
is done via <code>pip</code> and the <code>requirements.txt</code> file. Edit this file as the
starting point for your single or multiple file Python for Shiny apps.
The <code>CMD</code> instruction calls <code>uvicorn</code> to host the app:</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb135-1"><a href="6-part2-containerizing-shiny-apps.html#cb135-1" tabindex="-1"></a><span class="kw">FROM</span> python:3.9</span>
<span id="cb135-2"><a href="6-part2-containerizing-shiny-apps.html#cb135-2" tabindex="-1"></a></span>
<span id="cb135-3"><a href="6-part2-containerizing-shiny-apps.html#cb135-3" tabindex="-1"></a><span class="co"># Add here your dependencies</span></span>
<span id="cb135-4"><a href="6-part2-containerizing-shiny-apps.html#cb135-4" tabindex="-1"></a><span class="kw">COPY</span> app/requirements.txt .</span>
<span id="cb135-5"><a href="6-part2-containerizing-shiny-apps.html#cb135-5" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">--no-cache-dir</span> <span class="at">--upgrade</span> <span class="at">-r</span> requirements.txt</span>
<span id="cb135-6"><a href="6-part2-containerizing-shiny-apps.html#cb135-6" tabindex="-1"></a></span>
<span id="cb135-7"><a href="6-part2-containerizing-shiny-apps.html#cb135-7" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">groupadd</span> app <span class="kw">&amp;&amp;</span> <span class="ex">useradd</span> <span class="at">-g</span> app app</span>
<span id="cb135-8"><a href="6-part2-containerizing-shiny-apps.html#cb135-8" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/app</span>
<span id="cb135-9"><a href="6-part2-containerizing-shiny-apps.html#cb135-9" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb135-10"><a href="6-part2-containerizing-shiny-apps.html#cb135-10" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">chown</span> app:app <span class="at">-R</span> /home/app</span>
<span id="cb135-11"><a href="6-part2-containerizing-shiny-apps.html#cb135-11" tabindex="-1"></a><span class="kw">USER</span> app</span>
<span id="cb135-12"><a href="6-part2-containerizing-shiny-apps.html#cb135-12" tabindex="-1"></a><span class="kw">EXPOSE</span> 3838</span>
<span id="cb135-13"><a href="6-part2-containerizing-shiny-apps.html#cb135-13" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">mkdir</span> .config</span>
<span id="cb135-14"><a href="6-part2-containerizing-shiny-apps.html#cb135-14" tabindex="-1"></a><span class="kw">ENV</span> MPLCONFIGDIR=/home/app/.config</span>
<span id="cb135-15"><a href="6-part2-containerizing-shiny-apps.html#cb135-15" tabindex="-1"></a><span class="kw">ENV</span> HOME=/home/app</span>
<span id="cb135-16"><a href="6-part2-containerizing-shiny-apps.html#cb135-16" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;uvicorn&quot;</span>, <span class="st">&quot;app:app&quot;</span>, <span class="st">&quot;--host&quot;</span>, <span class="st">&quot;0.0.0.0&quot;</span>, <span class="st">&quot;--port&quot;</span>, <span class="st">&quot;3838&quot;</span>]</span></code></pre></div>
</div>
<div id="part2-dynamic-shiny-apps-rmd" class="section level3 hasAnchor" number="6.11.3">
<h3><span class="header-section-number">6.11.3</span> R Markdown<a href="6-part2-containerizing-shiny-apps.html#part2-dynamic-shiny-apps-rmd" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Hosting R Markdown documents with the <code>runtime: shiny</code> is very similar to hosting
regular Shiny apps. You need <code>pandoc</code> as a system requirement that you can
install with the image operating system’s package manager. The <code>CMD</code> instruction
uses <code>rmarkdown::run()</code> to render and run the document every time a user
connects to it:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb136-1"><a href="6-part2-containerizing-shiny-apps.html#cb136-1" tabindex="-1"></a><span class="kw">FROM</span> rocker/r2u:24.04</span>
<span id="cb136-2"><a href="6-part2-containerizing-shiny-apps.html#cb136-2" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb136-3"><a href="6-part2-containerizing-shiny-apps.html#cb136-3" tabindex="-1"></a>    <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="at">--no-install-recommends</span> <span class="dt">\</span></span>
<span id="cb136-4"><a href="6-part2-containerizing-shiny-apps.html#cb136-4" tabindex="-1"></a>    pandoc <span class="dt">\</span></span>
<span id="cb136-5"><a href="6-part2-containerizing-shiny-apps.html#cb136-5" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> <span class="at">-rf</span> /var/lib/apt/lists/<span class="pp">*</span></span>
<span id="cb136-6"><a href="6-part2-containerizing-shiny-apps.html#cb136-6" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;install.packages(c(&#39;shiny&#39;, &#39;rmarkdown&#39;))&quot;</span></span>
<span id="cb136-7"><a href="6-part2-containerizing-shiny-apps.html#cb136-7" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">groupadd</span> app <span class="kw">&amp;&amp;</span> <span class="ex">useradd</span> <span class="at">-g</span> app app</span>
<span id="cb136-8"><a href="6-part2-containerizing-shiny-apps.html#cb136-8" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/app</span>
<span id="cb136-9"><a href="6-part2-containerizing-shiny-apps.html#cb136-9" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb136-10"><a href="6-part2-containerizing-shiny-apps.html#cb136-10" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">chown</span> app:app <span class="at">-R</span> /home/app</span>
<span id="cb136-11"><a href="6-part2-containerizing-shiny-apps.html#cb136-11" tabindex="-1"></a><span class="kw">USER</span> app</span>
<span id="cb136-12"><a href="6-part2-containerizing-shiny-apps.html#cb136-12" tabindex="-1"></a><span class="kw">EXPOSE</span> 3838</span>
<span id="cb136-13"><a href="6-part2-containerizing-shiny-apps.html#cb136-13" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;R&quot;</span>, <span class="st">&quot;-e&quot;</span>, <span class="st">&quot;rmarkdown::run( </span><span class="op">\</span></span>
<span id="cb136-14"><a href="6-part2-containerizing-shiny-apps.html#cb136-14" tabindex="-1"></a><span class="st">    shiny_args = list(port = 3838, host = &#39;0.0.0.0&#39;))&quot;</span>]</span></code></pre></div>
<p>The prerendered option with <code>runtime: shinyrmd</code> require a rendering step
by calling <code>rmarkdown::render()</code> before the final <code>rmarkdown::run()</code>
in the <code>CMD</code>. Note that the <code>RMARKDOWN_RUN_PRERENDER</code> is set to <code>0</code> that tells
<code>rmarkdown</code> to not render the document for every user. The HTML is rendered only
once so only the reactive components need to be dealt with:</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb137-1"><a href="6-part2-containerizing-shiny-apps.html#cb137-1" tabindex="-1"></a><span class="kw">FROM</span> rocker/r2u:24.04</span>
<span id="cb137-2"><a href="6-part2-containerizing-shiny-apps.html#cb137-2" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb137-3"><a href="6-part2-containerizing-shiny-apps.html#cb137-3" tabindex="-1"></a>    <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="at">--no-install-recommends</span> <span class="dt">\</span></span>
<span id="cb137-4"><a href="6-part2-containerizing-shiny-apps.html#cb137-4" tabindex="-1"></a>    pandoc <span class="dt">\</span></span>
<span id="cb137-5"><a href="6-part2-containerizing-shiny-apps.html#cb137-5" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> <span class="at">-rf</span> /var/lib/apt/lists/<span class="pp">*</span></span>
<span id="cb137-6"><a href="6-part2-containerizing-shiny-apps.html#cb137-6" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;install.packages(c(&#39;shiny&#39;, &#39;rmarkdown&#39;, &#39;deps&#39;))&quot;</span></span>
<span id="cb137-7"><a href="6-part2-containerizing-shiny-apps.html#cb137-7" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">groupadd</span> app <span class="kw">&amp;&amp;</span> <span class="ex">useradd</span> <span class="at">-g</span> app app</span>
<span id="cb137-8"><a href="6-part2-containerizing-shiny-apps.html#cb137-8" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/app</span>
<span id="cb137-9"><a href="6-part2-containerizing-shiny-apps.html#cb137-9" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb137-10"><a href="6-part2-containerizing-shiny-apps.html#cb137-10" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;deps::install(ask=FALSE)&quot;</span></span>
<span id="cb137-11"><a href="6-part2-containerizing-shiny-apps.html#cb137-11" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-e</span> <span class="st">&quot;rmarkdown::render(&#39;index.Rmd&#39;)&quot;</span></span>
<span id="cb137-12"><a href="6-part2-containerizing-shiny-apps.html#cb137-12" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">chown</span> app:app <span class="at">-R</span> /home/app</span>
<span id="cb137-13"><a href="6-part2-containerizing-shiny-apps.html#cb137-13" tabindex="-1"></a><span class="kw">USER</span> app</span>
<span id="cb137-14"><a href="6-part2-containerizing-shiny-apps.html#cb137-14" tabindex="-1"></a><span class="kw">EXPOSE</span> 3838</span>
<span id="cb137-15"><a href="6-part2-containerizing-shiny-apps.html#cb137-15" tabindex="-1"></a><span class="kw">ENV</span> RMARKDOWN_RUN_PRERENDER=0</span>
<span id="cb137-16"><a href="6-part2-containerizing-shiny-apps.html#cb137-16" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;R&quot;</span>, <span class="st">&quot;-e&quot;</span>, <span class="st">&quot;rmarkdown::run( </span><span class="op">\</span></span>
<span id="cb137-17"><a href="6-part2-containerizing-shiny-apps.html#cb137-17" tabindex="-1"></a><span class="st">    shiny_args = list(port = 3838, host = &#39;0.0.0.0&#39;))&quot;</span>]</span></code></pre></div>
</div>
<div id="part2-dynamic-shiny-apps-quarto-r" class="section level3 hasAnchor" number="6.11.4">
<h3><span class="header-section-number">6.11.4</span> Quarto with R<a href="6-part2-containerizing-shiny-apps.html#part2-dynamic-shiny-apps-quarto-r" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Using Quarto with R to build and image is conceptually very similar to
R Markdown. First we install <code>quarto</code>. There are many ways of installing it,
this is one option. You need <code>curl</code> to download the Quarto installer,
we use <code>gdebi</code> here to install Quarto from the downloaded <code>.deb</code> package.
Once we have Quarto installed, we remove the Gdebi build time dependency.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb138-1"><a href="6-part2-containerizing-shiny-apps.html#cb138-1" tabindex="-1"></a><span class="kw">FROM</span> rocker/r2u:24.04</span>
<span id="cb138-2"><a href="6-part2-containerizing-shiny-apps.html#cb138-2" tabindex="-1"></a></span>
<span id="cb138-3"><a href="6-part2-containerizing-shiny-apps.html#cb138-3" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="at">--no-install-recommends</span> <span class="dt">\</span></span>
<span id="cb138-4"><a href="6-part2-containerizing-shiny-apps.html#cb138-4" tabindex="-1"></a>    pandoc <span class="dt">\</span></span>
<span id="cb138-5"><a href="6-part2-containerizing-shiny-apps.html#cb138-5" tabindex="-1"></a>    curl <span class="dt">\</span></span>
<span id="cb138-6"><a href="6-part2-containerizing-shiny-apps.html#cb138-6" tabindex="-1"></a>    gdebi-core <span class="dt">\</span></span>
<span id="cb138-7"><a href="6-part2-containerizing-shiny-apps.html#cb138-7" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> <span class="at">-rf</span> /var/lib/apt/lists/<span class="pp">*</span></span>
<span id="cb138-8"><a href="6-part2-containerizing-shiny-apps.html#cb138-8" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">curl</span> <span class="at">-LO</span> https://quarto.org/download/latest/quarto-linux-amd64.deb</span>
<span id="cb138-9"><a href="6-part2-containerizing-shiny-apps.html#cb138-9" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">gdebi</span> <span class="at">--non-interactive</span> quarto-linux-amd64.deb</span>
<span id="cb138-10"><a href="6-part2-containerizing-shiny-apps.html#cb138-10" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> purge <span class="at">-y</span> gdebi-core <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> autoremove <span class="at">-y</span></span>
<span id="cb138-11"><a href="6-part2-containerizing-shiny-apps.html#cb138-11" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">install.r</span> quarto shiny deps</span>
<span id="cb138-12"><a href="6-part2-containerizing-shiny-apps.html#cb138-12" tabindex="-1"></a></span>
<span id="cb138-13"><a href="6-part2-containerizing-shiny-apps.html#cb138-13" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">groupadd</span> app <span class="kw">&amp;&amp;</span> <span class="ex">useradd</span> <span class="at">-g</span> app app</span>
<span id="cb138-14"><a href="6-part2-containerizing-shiny-apps.html#cb138-14" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/app</span>
<span id="cb138-15"><a href="6-part2-containerizing-shiny-apps.html#cb138-15" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb138-16"><a href="6-part2-containerizing-shiny-apps.html#cb138-16" tabindex="-1"></a></span>
<span id="cb138-17"><a href="6-part2-containerizing-shiny-apps.html#cb138-17" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;deps::install(ask=FALSE)&quot;</span></span>
<span id="cb138-18"><a href="6-part2-containerizing-shiny-apps.html#cb138-18" tabindex="-1"></a></span>
<span id="cb138-19"><a href="6-part2-containerizing-shiny-apps.html#cb138-19" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">quarto</span> render index.qmd</span>
<span id="cb138-20"><a href="6-part2-containerizing-shiny-apps.html#cb138-20" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">chown</span> app:app <span class="at">-R</span> /home/app</span>
<span id="cb138-21"><a href="6-part2-containerizing-shiny-apps.html#cb138-21" tabindex="-1"></a><span class="kw">USER</span> app</span>
<span id="cb138-22"><a href="6-part2-containerizing-shiny-apps.html#cb138-22" tabindex="-1"></a><span class="kw">EXPOSE</span> 3838</span>
<span id="cb138-23"><a href="6-part2-containerizing-shiny-apps.html#cb138-23" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;quarto&quot;</span>, <span class="st">&quot;serve&quot;</span>, <span class="st">&quot;index.qmd&quot;</span>, <span class="st">&quot;--port&quot;</span>, <span class="st">&quot;3838&quot;</span>, <span class="op">\</span></span>
<span id="cb138-24"><a href="6-part2-containerizing-shiny-apps.html#cb138-24" tabindex="-1"></a>    <span class="st">&quot;--host&quot;</span>, <span class="st">&quot;0.0.0.0&quot;</span>, <span class="st">&quot;--no-render&quot;</span>]</span></code></pre></div>
<p>The prerendering uses <code>quarto render</code> before <code>quarto serve</code> with the
<code>--no-render</code> flag in the <code>CMD</code> instruction at the end.</p>
</div>
<div id="part2-dynamic-shiny-apps-quarto-python" class="section level3 hasAnchor" number="6.11.5">
<h3><span class="header-section-number">6.11.5</span> Quarto with Python<a href="6-part2-containerizing-shiny-apps.html#part2-dynamic-shiny-apps-quarto-python" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The Python version with Quarto works very similarly, the only difference is the
<code>pip install</code> part based in the <code>requirements.txt</code> file. Otherwise, the Python
code will be <code>COPY</code>-ed over as part of the <code>.qmd</code> file. The rendering and serving
steps are the same:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb139-1"><a href="6-part2-containerizing-shiny-apps.html#cb139-1" tabindex="-1"></a><span class="kw">FROM</span> python:3.9</span>
<span id="cb139-2"><a href="6-part2-containerizing-shiny-apps.html#cb139-2" tabindex="-1"></a></span>
<span id="cb139-3"><a href="6-part2-containerizing-shiny-apps.html#cb139-3" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="at">--no-install-recommends</span> <span class="dt">\</span></span>
<span id="cb139-4"><a href="6-part2-containerizing-shiny-apps.html#cb139-4" tabindex="-1"></a>    pandoc <span class="dt">\</span></span>
<span id="cb139-5"><a href="6-part2-containerizing-shiny-apps.html#cb139-5" tabindex="-1"></a>    curl <span class="dt">\</span></span>
<span id="cb139-6"><a href="6-part2-containerizing-shiny-apps.html#cb139-6" tabindex="-1"></a>    gdebi-core <span class="dt">\</span></span>
<span id="cb139-7"><a href="6-part2-containerizing-shiny-apps.html#cb139-7" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> <span class="at">-rf</span> /var/lib/apt/lists/<span class="pp">*</span></span>
<span id="cb139-8"><a href="6-part2-containerizing-shiny-apps.html#cb139-8" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">curl</span> <span class="at">-LO</span> https://quarto.org/download/latest/quarto-linux-amd64.deb</span>
<span id="cb139-9"><a href="6-part2-containerizing-shiny-apps.html#cb139-9" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">gdebi</span> <span class="at">--non-interactive</span> quarto-linux-amd64.deb</span>
<span id="cb139-10"><a href="6-part2-containerizing-shiny-apps.html#cb139-10" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">gdebi</span> <span class="at">--non-interactive</span> quarto-linux-amd64.deb</span>
<span id="cb139-11"><a href="6-part2-containerizing-shiny-apps.html#cb139-11" tabindex="-1"></a></span>
<span id="cb139-12"><a href="6-part2-containerizing-shiny-apps.html#cb139-12" tabindex="-1"></a><span class="kw">COPY</span> app/requirements.txt .</span>
<span id="cb139-13"><a href="6-part2-containerizing-shiny-apps.html#cb139-13" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">--no-cache-dir</span> <span class="at">--upgrade</span> <span class="at">-r</span> requirements.txt</span>
<span id="cb139-14"><a href="6-part2-containerizing-shiny-apps.html#cb139-14" tabindex="-1"></a></span>
<span id="cb139-15"><a href="6-part2-containerizing-shiny-apps.html#cb139-15" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">groupadd</span> app <span class="kw">&amp;&amp;</span> <span class="ex">useradd</span> <span class="at">-g</span> app app</span>
<span id="cb139-16"><a href="6-part2-containerizing-shiny-apps.html#cb139-16" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/app</span>
<span id="cb139-17"><a href="6-part2-containerizing-shiny-apps.html#cb139-17" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb139-18"><a href="6-part2-containerizing-shiny-apps.html#cb139-18" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">quarto</span> render index.qmd</span>
<span id="cb139-19"><a href="6-part2-containerizing-shiny-apps.html#cb139-19" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">chown</span> app:app <span class="at">-R</span> /home/app</span>
<span id="cb139-20"><a href="6-part2-containerizing-shiny-apps.html#cb139-20" tabindex="-1"></a><span class="kw">USER</span> app</span>
<span id="cb139-21"><a href="6-part2-containerizing-shiny-apps.html#cb139-21" tabindex="-1"></a><span class="kw">EXPOSE</span> 3838</span>
<span id="cb139-22"><a href="6-part2-containerizing-shiny-apps.html#cb139-22" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;quarto&quot;</span>, <span class="st">&quot;serve&quot;</span>, <span class="st">&quot;index.qmd&quot;</span>, <span class="st">&quot;--port&quot;</span>, <span class="st">&quot;3838&quot;</span>, <span class="op">\</span></span>
<span id="cb139-23"><a href="6-part2-containerizing-shiny-apps.html#cb139-23" tabindex="-1"></a>    <span class="st">&quot;--host&quot;</span>, <span class="st">&quot;0.0.0.0&quot;</span>, <span class="st">&quot;--no-render&quot;</span>]</span></code></pre></div>
</div>
<div id="part2-dynamic-shiny-apps-shiny-server" class="section level3 hasAnchor" number="6.11.6">
<h3><span class="header-section-number">6.11.6</span> Shiny Server<a href="6-part2-containerizing-shiny-apps.html#part2-dynamic-shiny-apps-shiny-server" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Shiny Server is part of the <code>rocker/shiny</code> image which is commonly used Docker
parent image for hosting Shiny apps. Shiny Server’s Professional version was
originally the enterprise self hosting option for Shiny apps before Posit
Connect. Nowadays, there is only an Open Source version available.
We will talk about non-containerized Shiny Server as a hosting option later.</p>
<p>A nice feature of a containerized Shiny Server compared to previously discussed
options is that it can host multiple Shiny apps, even R, R Markdown, Python,
and Quarto apps together in the same container.</p>
<p>FIXME: Provide link to this example.</p>
<p>We’ll use the following setup, combining multiple version of our three
example apps. We include the apps and their version in a hierarchical folder
structure within the <code>apps</code> folder. Besides these files we have an <code>index.html</code>
file in the root of the <code>apps</code> folder which will provide links to the
different apps inside the nested folders. The <code>Dockerfile</code> sits next to the
<code>apps</code> folder:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb140-1"><a href="6-part2-containerizing-shiny-apps.html#cb140-1" tabindex="-1"></a><span class="ex">├──</span> apps</span>
<span id="cb140-2"><a href="6-part2-containerizing-shiny-apps.html#cb140-2" tabindex="-1"></a><span class="ex">│</span>   ├── bananas</span>
<span id="cb140-3"><a href="6-part2-containerizing-shiny-apps.html#cb140-3" tabindex="-1"></a><span class="ex">│</span>   │   └── r-shiny</span>
<span id="cb140-4"><a href="6-part2-containerizing-shiny-apps.html#cb140-4" tabindex="-1"></a><span class="ex">│</span>   ├── faithful</span>
<span id="cb140-5"><a href="6-part2-containerizing-shiny-apps.html#cb140-5" tabindex="-1"></a><span class="ex">│</span>   │   ├── py-shiny</span>
<span id="cb140-6"><a href="6-part2-containerizing-shiny-apps.html#cb140-6" tabindex="-1"></a><span class="ex">│</span>   │   ├── quarto-r-shiny</span>
<span id="cb140-7"><a href="6-part2-containerizing-shiny-apps.html#cb140-7" tabindex="-1"></a><span class="ex">│</span>   │   ├── r-shiny</span>
<span id="cb140-8"><a href="6-part2-containerizing-shiny-apps.html#cb140-8" tabindex="-1"></a><span class="ex">│</span>   │   └── rmd-shiny</span>
<span id="cb140-9"><a href="6-part2-containerizing-shiny-apps.html#cb140-9" tabindex="-1"></a><span class="ex">│</span>   ├── lbtest</span>
<span id="cb140-10"><a href="6-part2-containerizing-shiny-apps.html#cb140-10" tabindex="-1"></a><span class="ex">│</span>   │   ├── py-shiny</span>
<span id="cb140-11"><a href="6-part2-containerizing-shiny-apps.html#cb140-11" tabindex="-1"></a><span class="ex">│</span>   │   └── r-shiny</span>
<span id="cb140-12"><a href="6-part2-containerizing-shiny-apps.html#cb140-12" tabindex="-1"></a><span class="ex">│</span>   └── index.html</span>
<span id="cb140-13"><a href="6-part2-containerizing-shiny-apps.html#cb140-13" tabindex="-1"></a><span class="ex">└──</span> Dockerfile</span></code></pre></div>
<p>We use the <code>rocker/shiny:4.4.1</code> parent image, install <code>pip</code> for Python 3
because we need it to install requirements for the Python Shiny app (<code>pip</code> is
not part of the parent image but you already have Python). We use <code>install2.r</code>
to manually install R package dependencies.</p>
<p>Shiny Server comes with a few apps pre-installed inside the <code>/srv/shiny-server</code>
folder. We remove all these files before we <code>COPY</code> the contents from the <code>apps</code>
directory over to the image. Once all the files are there, we install
R dependencies by relying on the <code>deps</code> packages crawling feature:
<code>deps::install(ask=FALSE)</code> will create a temporary <code>dependencies.json</code> file
based on exploring all the dependencies inside the newly populated
<code>/srv/shiny-server</code> folder. Next we install Python dependencies.
Finally, in <code>CMD</code> we call the executable <code>/usr/bin/shiny-server</code> that will start
the Shiny Server. It will by default listen on port 3838.</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb141-1"><a href="6-part2-containerizing-shiny-apps.html#cb141-1" tabindex="-1"></a><span class="kw">FROM</span> rocker/shiny:4.4.1</span>
<span id="cb141-2"><a href="6-part2-containerizing-shiny-apps.html#cb141-2" tabindex="-1"></a></span>
<span id="cb141-3"><a href="6-part2-containerizing-shiny-apps.html#cb141-3" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="dt">\</span></span>
<span id="cb141-4"><a href="6-part2-containerizing-shiny-apps.html#cb141-4" tabindex="-1"></a>    <span class="at">--no-install-recommends</span> <span class="dt">\</span></span>
<span id="cb141-5"><a href="6-part2-containerizing-shiny-apps.html#cb141-5" tabindex="-1"></a>    python3-pip <span class="dt">\</span></span>
<span id="cb141-6"><a href="6-part2-containerizing-shiny-apps.html#cb141-6" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> <span class="at">-rf</span> /var/lib/apt/lists/<span class="pp">*</span></span>
<span id="cb141-7"><a href="6-part2-containerizing-shiny-apps.html#cb141-7" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">install2.r</span> <span class="at">--error</span> <span class="at">--skipinstalled</span> <span class="dt">\</span></span>
<span id="cb141-8"><a href="6-part2-containerizing-shiny-apps.html#cb141-8" tabindex="-1"></a>    shiny <span class="dt">\</span></span>
<span id="cb141-9"><a href="6-part2-containerizing-shiny-apps.html#cb141-9" tabindex="-1"></a>    bslib <span class="dt">\</span></span>
<span id="cb141-10"><a href="6-part2-containerizing-shiny-apps.html#cb141-10" tabindex="-1"></a>    rmarkdown <span class="dt">\</span></span>
<span id="cb141-11"><a href="6-part2-containerizing-shiny-apps.html#cb141-11" tabindex="-1"></a>    quarto <span class="dt">\</span></span>
<span id="cb141-12"><a href="6-part2-containerizing-shiny-apps.html#cb141-12" tabindex="-1"></a>    deps</span>
<span id="cb141-13"><a href="6-part2-containerizing-shiny-apps.html#cb141-13" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">rm</span> <span class="at">-rf</span> /srv/shiny-server/<span class="pp">*</span></span>
<span id="cb141-14"><a href="6-part2-containerizing-shiny-apps.html#cb141-14" tabindex="-1"></a><span class="kw">COPY</span> ./apps /srv/shiny-server/</span>
<span id="cb141-15"><a href="6-part2-containerizing-shiny-apps.html#cb141-15" tabindex="-1"></a></span>
<span id="cb141-16"><a href="6-part2-containerizing-shiny-apps.html#cb141-16" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-q</span> <span class="at">-e</span> <span class="st">&quot;deps::install(&#39;/srv/shiny-server&#39;,ask=FALSE)&quot;</span></span>
<span id="cb141-17"><a href="6-part2-containerizing-shiny-apps.html#cb141-17" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">--no-cache-dir</span> <span class="at">--upgrade</span> <span class="dt">\</span></span>
<span id="cb141-18"><a href="6-part2-containerizing-shiny-apps.html#cb141-18" tabindex="-1"></a>    <span class="at">-r</span> /srv/shiny-server/faithful/py-shiny/requirements.txt</span>
<span id="cb141-19"><a href="6-part2-containerizing-shiny-apps.html#cb141-19" tabindex="-1"></a></span>
<span id="cb141-20"><a href="6-part2-containerizing-shiny-apps.html#cb141-20" tabindex="-1"></a><span class="kw">USER</span> shiny</span>
<span id="cb141-21"><a href="6-part2-containerizing-shiny-apps.html#cb141-21" tabindex="-1"></a><span class="kw">EXPOSE</span> 3838</span>
<span id="cb141-22"><a href="6-part2-containerizing-shiny-apps.html#cb141-22" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;/usr/bin/shiny-server&quot;</span>]</span></code></pre></div>
<p>You can build the image and start a container as:</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb142-1"><a href="6-part2-containerizing-shiny-apps.html#cb142-1" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> shiny-server .</span>
<span id="cb142-2"><a href="6-part2-containerizing-shiny-apps.html#cb142-2" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-p</span> 8080:3838 shiny-server</span></code></pre></div>
<p>Visit <code>http://localhost:8080</code> to see the landing page
(Fig. <a href="6-part2-containerizing-shiny-apps.html#fig:part2-docker-shinyserver">6.2</a>. Use the links to navigate the
different apps.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:part2-docker-shinyserver"></span>
<img src="images/02/docker-shinyserver.png" alt="Landing page for the containerized Shiny Server deployment." width="100%" />
<p class="caption">
Figure 6.2: Landing page for the containerized Shiny Server deployment.
</p>
</div>
</div>
</div>
<div id="part2-static-shiny-apps" class="section level2 hasAnchor" number="6.12">
<h2><span class="header-section-number">6.12</span> Static Shiny Apps<a href="6-part2-containerizing-shiny-apps.html#part2-static-shiny-apps" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Static Shiny apps can be rendered on your local machine as explained in
<a href="5-part2-developing-shiny-apps.html#part2-organizing-shiny-apps">5.2</a>.
You’d use <code>shinylive::export("&lt;input-folder&gt;", "&lt;output-folder&gt;")</code> in R and
<code>shinylive export &lt;input-folder&gt; &lt;output-folder&gt;</code> in Python to render the static pages for
Shinylive based on a Shiny app inside the <code>&lt;input-folder&gt;</code> folder.
The Quarto examples that used Shinylive were rendered similarly with the
<code>quarto render &lt;input-file&gt; --output-dir &lt;output-folder&gt;</code> command.</p>
<p>As you saw before, you need to have a proper webserver hosting the pages and
the required CSS and JavaScript assets to avoid cross-origin resource sharing
(CORS) issues.
You can upload the static files to any file hosting service, like GitHub or
GitLab Pages, Netlify, or the DigitalOcean App Platform. These platforms all
offer a free tier for hosting static assets.
The static pages we rendered based on the Old Faithful example are
deployed to GitHub Pages at <a href="https://h10y.github.io/faithful/" class="uri">https://h10y.github.io/faithful/</a>.
You can also set up your self hosted virtual server in the cloud to host
static files, as you will see in later chapters.</p>
<p>Apart from static hosting, it is possible to put the static files in a Docker
image behind a server process. This option assumes that you have all the build
time requirements for rendering the Shinylive or Quarto with Shinylive
documents.</p>
<p>You can use R or Python as well to serve the static contents using
the much bulkier parent images of <code>rocker/r2u</code> or <code>python:3.9</code>. You can use
the <code>httpuv</code> R package or the <code>http.server</code> Python module.
Although this is clearly doable, it is not necessary and will result in a much
larger Docker image. The same outcome can be achieved by using a slimmer parent
image and using a multi-stage Docker build process.</p>
<p>We’ll use the <a href="https://github.com/openfaas/of-watchdog">OpenFaaS Watchdog</a>
for static hosting. It is a single binary file that is built for multiple
architectures and is able to serve static assets among other use cases.
It is well suited for containerized deployments because it provides a healthcheck
mechanism and exposes metrics for observability. You may notice in this
example that we have two <code>FROM</code> instructions. The first one takes the
watchdog image, the second one uses a small Alpine linux image.
We <code>COPY</code> the contents from the <code>app</code> folder of the build context to the
<code>/home/app</code> folder of the Alpine image’s file system as we did before.
Then we copy the <code>fwatchdog</code> executable file from the watchdog image as well.
The only thing why the Dockerfile looks a bit verbose is because we want to
create a non-privileged user as we did before to harden our image’s security.</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb143-1"><a href="6-part2-containerizing-shiny-apps.html#cb143-1" tabindex="-1"></a><span class="kw">FROM</span> ghcr.io/openfaas/of-watchdog:0.10.1 <span class="kw">AS</span> watchdog</span>
<span id="cb143-2"><a href="6-part2-containerizing-shiny-apps.html#cb143-2" tabindex="-1"></a></span>
<span id="cb143-3"><a href="6-part2-containerizing-shiny-apps.html#cb143-3" tabindex="-1"></a><span class="kw">FROM</span> alpine:3.20</span>
<span id="cb143-4"><a href="6-part2-containerizing-shiny-apps.html#cb143-4" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">adduser</span> <span class="at">-D</span> app</span>
<span id="cb143-5"><a href="6-part2-containerizing-shiny-apps.html#cb143-5" tabindex="-1"></a><span class="kw">USER</span> app</span>
<span id="cb143-6"><a href="6-part2-containerizing-shiny-apps.html#cb143-6" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/app</span>
<span id="cb143-7"><a href="6-part2-containerizing-shiny-apps.html#cb143-7" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb143-8"><a href="6-part2-containerizing-shiny-apps.html#cb143-8" tabindex="-1"></a><span class="kw">COPY</span> <span class="op">--from=watchdog</span> /fwatchdog .</span>
<span id="cb143-9"><a href="6-part2-containerizing-shiny-apps.html#cb143-9" tabindex="-1"></a><span class="kw">ENV</span> mode=<span class="st">&quot;static&quot;</span></span>
<span id="cb143-10"><a href="6-part2-containerizing-shiny-apps.html#cb143-10" tabindex="-1"></a><span class="kw">ENV</span> static_path=<span class="st">&quot;/home/app&quot;</span></span>
<span id="cb143-11"><a href="6-part2-containerizing-shiny-apps.html#cb143-11" tabindex="-1"></a><span class="kw">HEALTHCHECK</span> <span class="op">--interval=3s</span> <span class="kw">CMD</span> [ -e /tmp/.lock ] || exit 1</span>
<span id="cb143-12"><a href="6-part2-containerizing-shiny-apps.html#cb143-12" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;./fwatchdog&quot;</span>]</span></code></pre></div>
<p>The same <code>Dockerfile</code> would work for all static Shiny output whether that is coming
from Shinylive or Quarto with Shinylive. Just have these files in the <code>app</code>
folder and you are done.</p>
<p>The <code>FROM &lt;image&gt; AS &lt;stage&gt;</code> specification allows us to
later specify which parent image we refer to. This is done via the
<code>--from=&lt;stage&gt;</code> flag for the <code>COPY</code> instruction.
The multiple images used in the same <code>Dockerfile</code> are called stages, and the
a build is referred to as a <em>multi-stage build</em>. It is often used to
use a bulkier image for build purposes and a leaner image to only
copy specific files to. In this case we copy the static contents and an
executable file called <code>watchdog</code>.</p>
<p>The environment variables tell the watchdog process to use the static mode and
that the contents are in the <code>/home/app</code> folder. The <code>HEALTHCHECK</code> specifies that
we should check the existence of the <code>/tmp/.lock</code> file every 3 seconds.
This lockfile is created by the watchdog process and its existence is proof
of a healthy server. When you run your containers using container orchestration
tools like Kubernetes, a failed healthcheck results in
creating a new container and removing the old one.</p>
<div id="part2-multi-stage-builds" class="section level3 hasAnchor" number="6.12.1">
<h3><span class="header-section-number">6.12.1</span> Multi-stage Builds<a href="6-part2-containerizing-shiny-apps.html#part2-multi-stage-builds" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A common use case for multi-stage builds is to run the building/rendering
process in the first stage of the build, and copy over the results – in our
case the static files – from the first stage to the final slimmer image
(Fig. <a href="6-part2-containerizing-shiny-apps.html#fig:part2-docker-layers">6.3</a>.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:part2-docker-layers"></span>
<img src="images/02/docker-layers.png" alt="Docker layers for single (left) and multi-stage builds (right). Dashed lines are temporary layers." width="100%" />
<p class="caption">
Figure 6.3: Docker layers for single (left) and multi-stage builds (right). Dashed lines are temporary layers.
</p>
</div>
<p>A Python Shinylive example demonstrates this use case of the multi-stage
build capabilities of Docker. The first stage is called the <code>builder</code> and is
based on the general <code>python:3.9</code> image. We save the rendered output into the
<code>/root/output folder</code>.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb144-1"><a href="6-part2-containerizing-shiny-apps.html#cb144-1" tabindex="-1"></a><span class="kw">FROM</span> python:3.9 <span class="kw">AS</span> builder</span>
<span id="cb144-2"><a href="6-part2-containerizing-shiny-apps.html#cb144-2" tabindex="-1"></a><span class="kw">WORKDIR</span> /root</span>
<span id="cb144-3"><a href="6-part2-containerizing-shiny-apps.html#cb144-3" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install shinylive</span>
<span id="cb144-4"><a href="6-part2-containerizing-shiny-apps.html#cb144-4" tabindex="-1"></a><span class="kw">COPY</span> py-shiny/app app</span>
<span id="cb144-5"><a href="6-part2-containerizing-shiny-apps.html#cb144-5" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="dt">\</span></span>
<span id="cb144-6"><a href="6-part2-containerizing-shiny-apps.html#cb144-6" tabindex="-1"></a>    <span class="at">--no-cache-dir</span> <span class="at">--upgrade</span> <span class="at">-r</span> /root/app/requirements.txt</span>
<span id="cb144-7"><a href="6-part2-containerizing-shiny-apps.html#cb144-7" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">shinylive</span> export app output</span>
<span id="cb144-8"><a href="6-part2-containerizing-shiny-apps.html#cb144-8" tabindex="-1"></a>[...]</span></code></pre></div>
<p>The same idea works for Quarto with Shinylive:</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb145-1"><a href="6-part2-containerizing-shiny-apps.html#cb145-1" tabindex="-1"></a><span class="kw">FROM</span> python:3.9 <span class="kw">AS</span> builder</span>
<span id="cb145-2"><a href="6-part2-containerizing-shiny-apps.html#cb145-2" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="at">--no-install-recommends</span> <span class="dt">\</span></span>
<span id="cb145-3"><a href="6-part2-containerizing-shiny-apps.html#cb145-3" tabindex="-1"></a>    pandoc <span class="dt">\</span></span>
<span id="cb145-4"><a href="6-part2-containerizing-shiny-apps.html#cb145-4" tabindex="-1"></a>    curl <span class="dt">\</span></span>
<span id="cb145-5"><a href="6-part2-containerizing-shiny-apps.html#cb145-5" tabindex="-1"></a>    gdebi-core <span class="dt">\</span></span>
<span id="cb145-6"><a href="6-part2-containerizing-shiny-apps.html#cb145-6" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> <span class="at">-rf</span> /var/lib/apt/lists/<span class="pp">*</span></span>
<span id="cb145-7"><a href="6-part2-containerizing-shiny-apps.html#cb145-7" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">curl</span> <span class="at">-LO</span> https://quarto.org/download/latest/quarto-linux-amd64.deb</span>
<span id="cb145-8"><a href="6-part2-containerizing-shiny-apps.html#cb145-8" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">gdebi</span> <span class="at">--non-interactive</span> quarto-linux-amd64.deb</span>
<span id="cb145-9"><a href="6-part2-containerizing-shiny-apps.html#cb145-9" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> purge <span class="at">-y</span> gdebi-core <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> autoremove <span class="at">-y</span></span>
<span id="cb145-10"><a href="6-part2-containerizing-shiny-apps.html#cb145-10" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install shinylive</span>
<span id="cb145-11"><a href="6-part2-containerizing-shiny-apps.html#cb145-11" tabindex="-1"></a><span class="kw">WORKDIR</span> /root/app</span>
<span id="cb145-12"><a href="6-part2-containerizing-shiny-apps.html#cb145-12" tabindex="-1"></a><span class="kw">COPY</span> quarto-py-shinylive/index.qmd /root/app/index.qmd</span>
<span id="cb145-13"><a href="6-part2-containerizing-shiny-apps.html#cb145-13" tabindex="-1"></a><span class="kw">COPY</span> quarto-py-shiny/app/requirements.txt /root/app/requirements.txt</span>
<span id="cb145-14"><a href="6-part2-containerizing-shiny-apps.html#cb145-14" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">--no-cache-dir</span> <span class="at">--upgrade</span> <span class="at">-r</span> requirements.txt</span>
<span id="cb145-15"><a href="6-part2-containerizing-shiny-apps.html#cb145-15" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">quarto</span> add quarto-ext/shinylive <span class="at">--no-prompt</span></span>
<span id="cb145-16"><a href="6-part2-containerizing-shiny-apps.html#cb145-16" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">quarto</span> render /root/app/index.qmd <span class="at">--output-dir</span> /root/output</span>
<span id="cb145-17"><a href="6-part2-containerizing-shiny-apps.html#cb145-17" tabindex="-1"></a>[...]</span></code></pre></div>
<p>The R version is slightly different because of the different packages
that one has to install. Refer to the previous Quarto examples or
the example repository for the corresponding changes.</p>
<p>The second part for the <code>Dockerfile</code> for both the Shinylive and the Quarto
with Shinylive examples (R and Python alike) is the following:</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb146-1"><a href="6-part2-containerizing-shiny-apps.html#cb146-1" tabindex="-1"></a>[...]</span>
<span id="cb146-2"><a href="6-part2-containerizing-shiny-apps.html#cb146-2" tabindex="-1"></a><span class="kw">FROM</span> ghcr.io/openfaas/of-watchdog:0.10.1 <span class="kw">AS</span> watchdog</span>
<span id="cb146-3"><a href="6-part2-containerizing-shiny-apps.html#cb146-3" tabindex="-1"></a></span>
<span id="cb146-4"><a href="6-part2-containerizing-shiny-apps.html#cb146-4" tabindex="-1"></a><span class="kw">FROM</span> alpine:3.20</span>
<span id="cb146-5"><a href="6-part2-containerizing-shiny-apps.html#cb146-5" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">adduser</span> <span class="at">-D</span> app</span>
<span id="cb146-6"><a href="6-part2-containerizing-shiny-apps.html#cb146-6" tabindex="-1"></a><span class="kw">USER</span> app</span>
<span id="cb146-7"><a href="6-part2-containerizing-shiny-apps.html#cb146-7" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/app</span>
<span id="cb146-8"><a href="6-part2-containerizing-shiny-apps.html#cb146-8" tabindex="-1"></a><span class="kw">COPY</span> <span class="op">--from=builder</span> /root/output /home/app</span>
<span id="cb146-9"><a href="6-part2-containerizing-shiny-apps.html#cb146-9" tabindex="-1"></a><span class="kw">COPY</span> <span class="op">--from=watchdog</span> /fwatchdog .</span>
<span id="cb146-10"><a href="6-part2-containerizing-shiny-apps.html#cb146-10" tabindex="-1"></a><span class="kw">ENV</span> mode=<span class="st">&quot;static&quot;</span></span>
<span id="cb146-11"><a href="6-part2-containerizing-shiny-apps.html#cb146-11" tabindex="-1"></a><span class="kw">ENV</span> static_path=<span class="st">&quot;/home/app&quot;</span></span>
<span id="cb146-12"><a href="6-part2-containerizing-shiny-apps.html#cb146-12" tabindex="-1"></a><span class="kw">HEALTHCHECK</span> <span class="op">--interval=3s</span> <span class="kw">CMD</span> [ -e /tmp/.lock ] || exit 1</span>
<span id="cb146-13"><a href="6-part2-containerizing-shiny-apps.html#cb146-13" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;./fwatchdog&quot;</span>]</span></code></pre></div>
<p>This is identical to the previous example where you had the static files
rendered locally and outside of the Docker image, and then included with
<code>COPY app .</code>. Instead, you have <code>COPY --from=builder /root/output /home/app</code>
here which means: grab the files from the output folder of the build stage.</p>

</div>
</div>
<div id="part2-image-analysis" class="section level2 hasAnchor" number="6.13">
<h2><span class="header-section-number">6.13</span> Image Analysis<a href="6-part2-containerizing-shiny-apps.html#part2-image-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Image analysis is a two part process. First, we extract the
Software Bill of Material (SBOM) and other image metadata, these are called attestations.
Second, we evaluate these data against vulnerability data from security
advisories. Docker Scout can perform image analysis among other things and
is available by default for Docker Hub repositories.</p>
<p>Some of these features are experimental and are not universally supported
in all registries, so we won’t cover everything in detail.
You can consult the Docker CLI reference for <code>docker scout</code>.</p>
<div id="part2-image-analysis-attestations" class="section level3 hasAnchor" number="6.13.1">
<h3><span class="header-section-number">6.13.1</span> Attestations<a href="6-part2-containerizing-shiny-apps.html#part2-image-analysis-attestations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Attestations describe how an image was built, and what it contains.
The first kind of attestation is referred to as <strong>provenance</strong>.
You can add the minimum set of provenance information to an image using BuildKit
as:</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb147-1"><a href="6-part2-containerizing-shiny-apps.html#cb147-1" tabindex="-1"></a><span class="ex">docker</span> buildx build <span class="at">-t</span> <span class="op">&lt;</span>image-name<span class="op">&gt;</span>:<span class="op">&lt;</span>image-tag<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb147-2"><a href="6-part2-containerizing-shiny-apps.html#cb147-2" tabindex="-1"></a>    <span class="at">--attest</span> type=provenance,mode=min .</span></code></pre></div>
<p>Then you can inspect image provenance information with:</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb148-1"><a href="6-part2-containerizing-shiny-apps.html#cb148-1" tabindex="-1"></a><span class="ex">docker</span> buildx imagetools inspect <span class="op">&lt;</span>image-name<span class="op">&gt;</span>:<span class="op">&lt;</span>image-tag<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb148-2"><a href="6-part2-containerizing-shiny-apps.html#cb148-2" tabindex="-1"></a>    <span class="at">--format</span> <span class="st">&quot;{{ json .Provenance.SLSA }}&quot;</span></span></code></pre></div>
<p>The second kind of attestation is the <strong>Software Bill of Material</strong> (SBOM).
The SBOM is a complete inventory of a codebase, the license and version information.
The <code>docker scout</code> command can scan images and create an SBOM.
Here is the list view of the SBOM from the <code>rocker/r2u:24.04</code> image:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb149-1"><a href="6-part2-containerizing-shiny-apps.html#cb149-1" tabindex="-1"></a><span class="ex">docker</span> scout sbom <span class="at">--format</span> list rocker/r2u:24.04</span>
<span id="cb149-2"><a href="6-part2-containerizing-shiny-apps.html#cb149-2" tabindex="-1"></a></span>
<span id="cb149-3"><a href="6-part2-containerizing-shiny-apps.html#cb149-3" tabindex="-1"></a><span class="co">#         Name                       Version                Type</span></span>
<span id="cb149-4"><a href="6-part2-containerizing-shiny-apps.html#cb149-4" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb149-5"><a href="6-part2-containerizing-shiny-apps.html#cb149-5" tabindex="-1"></a><span class="co">#   KernSmooth                2.23-24                       cran</span></span>
<span id="cb149-6"><a href="6-part2-containerizing-shiny-apps.html#cb149-6" tabindex="-1"></a><span class="co">#   MASS                      7.3-61                        cran</span></span>
<span id="cb149-7"><a href="6-part2-containerizing-shiny-apps.html#cb149-7" tabindex="-1"></a><span class="co">#   Matrix                    1.7-0                         cran</span></span>
<span id="cb149-8"><a href="6-part2-containerizing-shiny-apps.html#cb149-8" tabindex="-1"></a><span class="co">#   acl                       2.3.2-1build1                 deb</span></span>
<span id="cb149-9"><a href="6-part2-containerizing-shiny-apps.html#cb149-9" tabindex="-1"></a><span class="co">#   [...]</span></span>
<span id="cb149-10"><a href="6-part2-containerizing-shiny-apps.html#cb149-10" tabindex="-1"></a><span class="co">#   zlib                      1:1.3.dfsg-3.1ubuntu2         deb</span></span>
<span id="cb149-11"><a href="6-part2-containerizing-shiny-apps.html#cb149-11" tabindex="-1"></a><span class="co">#   zlib1g                    1:1.3.dfsg-3.1ubuntu2         deb</span></span>
<span id="cb149-12"><a href="6-part2-containerizing-shiny-apps.html#cb149-12" tabindex="-1"></a><span class="co">#   zlib1g-dev                1:1.3.dfsg-3.1ubuntu2         deb</span></span></code></pre></div>
<p>Write the SBOM information into a JSON file for further processing:</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb150-1"><a href="6-part2-containerizing-shiny-apps.html#cb150-1" tabindex="-1"></a><span class="ex">docker</span> scout sbom rocker/r2u:24.04 <span class="op">&gt;</span> sbom-r2u.json</span></code></pre></div>
</div>
<div id="part2-image-analysis-scanning" class="section level3 hasAnchor" number="6.13.2">
<h3><span class="header-section-number">6.13.2</span> Vulnerability Scanning<a href="6-part2-containerizing-shiny-apps.html#part2-image-analysis-scanning" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Image analysis uses image SBOMs to understand what packages and versions an image
contains. Knowing the exact versions of your packages is not only good for
reproducibility but is also the foundation for vulnerability scanning.
Docker Scout compares the SBOM to a list of
<a href="https://docs.docker.com/scout/deep-dive/advisory-db-sources/">known vulnerabilities</a>.</p>
<p>The quick view gives a high level overview of different levels of
vulnerabilities. Vulnerabilities are ordered by severity:
critical (<code>C</code>), high (<code>H</code>), medium (<code>M</code>) or low (<code>L</code>).
There are no critical vulnerabilities known for the <code>rocker/r2u</code> image
and there are 2 vulnerabilities classified as high but no critical vulnerabilities.</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb151-1"><a href="6-part2-containerizing-shiny-apps.html#cb151-1" tabindex="-1"></a><span class="ex">docker</span> scout quickview rocker/r2u:24.04</span>
<span id="cb151-2"><a href="6-part2-containerizing-shiny-apps.html#cb151-2" tabindex="-1"></a></span>
<span id="cb151-3"><a href="6-part2-containerizing-shiny-apps.html#cb151-3" tabindex="-1"></a><span class="co">#   ✓ Pulled</span></span>
<span id="cb151-4"><a href="6-part2-containerizing-shiny-apps.html#cb151-4" tabindex="-1"></a><span class="co">#   ✓ Image stored for indexing</span></span>
<span id="cb151-5"><a href="6-part2-containerizing-shiny-apps.html#cb151-5" tabindex="-1"></a><span class="co">#   ✓ Indexed 435 packages</span></span>
<span id="cb151-6"><a href="6-part2-containerizing-shiny-apps.html#cb151-6" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb151-7"><a href="6-part2-containerizing-shiny-apps.html#cb151-7" tabindex="-1"></a><span class="co">#   i Base image was auto-detected. To get more accurate results,</span></span>
<span id="cb151-8"><a href="6-part2-containerizing-shiny-apps.html#cb151-8" tabindex="-1"></a><span class="co">#     build images with max-mode provenance attestations.</span></span>
<span id="cb151-9"><a href="6-part2-containerizing-shiny-apps.html#cb151-9" tabindex="-1"></a><span class="co">#     Review docs.docker.com ↗ for more information.</span></span>
<span id="cb151-10"><a href="6-part2-containerizing-shiny-apps.html#cb151-10" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb151-11"><a href="6-part2-containerizing-shiny-apps.html#cb151-11" tabindex="-1"></a><span class="co"># Target               │  rocker/r2u:24.04 │  0C  2H  206M  44L</span></span>
<span id="cb151-12"><a href="6-part2-containerizing-shiny-apps.html#cb151-12" tabindex="-1"></a><span class="co">#   digest             │  f3272f6d118c     │</span></span>
<span id="cb151-13"><a href="6-part2-containerizing-shiny-apps.html#cb151-13" tabindex="-1"></a><span class="co"># Base image           │  ubuntu:24.04     │  0C  0H    6M   6L</span></span>
<span id="cb151-14"><a href="6-part2-containerizing-shiny-apps.html#cb151-14" tabindex="-1"></a><span class="co"># Refreshed base image │  ubuntu:24.04     │  0C  0H    2M   6L</span></span>
<span id="cb151-15"><a href="6-part2-containerizing-shiny-apps.html#cb151-15" tabindex="-1"></a><span class="co"># Updated base image   │  ubuntu:24.10     │  0C  0H    0M   0L</span></span></code></pre></div>
<p>The CVEs subcommand analyzes an image for vulnerabilities, e.g. 
<code>docker scout cves rocker/r2u:24.04</code>.
CVE is short for Common Vulnerabilities and Exposures.
You might want to filter this result to show only critical and high vulnerability
packages.</p>
<p>It is not wise to ignore critical vulnerabilities. In such cases you should
find alternatives and not include such packages in your image.
Critical vulnerabilities can shake the whole software industry and are usually
patched in a short amount of time, or at least a workaround is suggested.
Get only critical CVEs as:</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb152-1"><a href="6-part2-containerizing-shiny-apps.html#cb152-1" tabindex="-1"></a><span class="ex">docker</span> scout cves <span class="at">--format</span> only-packages <span class="at">--only-vuln-packages</span> <span class="dt">\</span></span>
<span id="cb152-2"><a href="6-part2-containerizing-shiny-apps.html#cb152-2" tabindex="-1"></a>  <span class="at">--only-severity</span> critical rocker/r2u:24.04</span>
<span id="cb152-3"><a href="6-part2-containerizing-shiny-apps.html#cb152-3" tabindex="-1"></a></span>
<span id="cb152-4"><a href="6-part2-containerizing-shiny-apps.html#cb152-4" tabindex="-1"></a><span class="co">#   ✓ SBOM of image already cached, 435 packages indexed</span></span>
<span id="cb152-5"><a href="6-part2-containerizing-shiny-apps.html#cb152-5" tabindex="-1"></a><span class="co">#   ✓ No vulnerable package detected</span></span>
<span id="cb152-6"><a href="6-part2-containerizing-shiny-apps.html#cb152-6" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb152-7"><a href="6-part2-containerizing-shiny-apps.html#cb152-7" tabindex="-1"></a><span class="co"># Name  Version  Type  Vulnerabilities</span></span></code></pre></div>
<p>Here is how to check for critical and high vulnerabilities:</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb153-1"><a href="6-part2-containerizing-shiny-apps.html#cb153-1" tabindex="-1"></a><span class="ex">docker</span> scout cves <span class="at">--format</span> only-packages <span class="at">--only-vuln-packages</span> <span class="dt">\</span></span>
<span id="cb153-2"><a href="6-part2-containerizing-shiny-apps.html#cb153-2" tabindex="-1"></a>  <span class="at">--only-severity</span> critical,high rocker/r2u:24.04</span>
<span id="cb153-3"><a href="6-part2-containerizing-shiny-apps.html#cb153-3" tabindex="-1"></a></span>
<span id="cb153-4"><a href="6-part2-containerizing-shiny-apps.html#cb153-4" tabindex="-1"></a><span class="co">#   ✓ SBOM of image already cached, 435 packages indexed</span></span>
<span id="cb153-5"><a href="6-part2-containerizing-shiny-apps.html#cb153-5" tabindex="-1"></a><span class="co">#   ✗ Detected 1 vulnerable package with 2 vulnerabilities</span></span>
<span id="cb153-6"><a href="6-part2-containerizing-shiny-apps.html#cb153-6" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb153-7"><a href="6-part2-containerizing-shiny-apps.html#cb153-7" tabindex="-1"></a><span class="co"># Name     Version    Type        Vulnerabilities</span></span>
<span id="cb153-8"><a href="6-part2-containerizing-shiny-apps.html#cb153-8" tabindex="-1"></a><span class="co"># --------------------------------------------------------</span></span>
<span id="cb153-9"><a href="6-part2-containerizing-shiny-apps.html#cb153-9" tabindex="-1"></a><span class="co"># linux  6.8.0-35.35  deb      0C     2H     0M     0L</span></span></code></pre></div>
<p>You can see that the 2 high CVEs are part of Linux itself and
are not coming from packages that r2u adds on top of the Ubuntu parent image.</p>
</div>
</div>
<div id="part2-containers" class="section level2 hasAnchor" number="6.14">
<h2><span class="header-section-number">6.14</span> Containers<a href="6-part2-containerizing-shiny-apps.html#part2-containers" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>You have learnt how to build images using the Dockerfile to contain a Shiny app.
A “live” version of this image is called the container, that is the
runtime instance of the docker image. Besides the image, it
consists of a set of instructions that you specify before or during run time,
and an execution environment. Let’s see how you can create, start, and manage
Docker containers.</p>
<div id="part2-containers-run" class="section level3 hasAnchor" number="6.14.1">
<h3><span class="header-section-number">6.14.1</span> Docker Run<a href="6-part2-containerizing-shiny-apps.html#part2-containers-run" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>docker run</code> command is a versatile tool because it can
not only create and run a new container from an image, but it can also pull
the image if needed.</p>
<p>You have seen that we usually set the <code>-p</code> or <code>--port</code> option and map the
host port 8080 to the container port 3838 as e.g. <code>-p 8080:3838</code>.
Setting the port is needed when running a web application, such as Shiny.
This way you can view the application in your browser.</p>
<p>When you start a Docker container it executes a command that you specified
before in the Docker image’s configuration, the <code>Dockerfile</code>.
The default settings from the image usually work well, but you can
also change them if needed.
You may set or override many of the instructions from your Dockerfile:</p>
<ul>
<li><code>--expose</code> exposes a port or a range of ports,</li>
<li><code>--user</code> provides a username to be used,</li>
<li><code>--workdir</code> sets the working directory inside the container,</li>
<li><code>--entrypoint</code> overwrites the default <code>ENTRYPOINT</code> instruction.</li>
</ul>
<p>It is common to use the <code>--rm</code> flag to automatically remove the container and
its associated anonymous volumes when it exits. This way, when you hit CTRL+C,
it will not only stop the container, but it will also remove it and
<code>docker ps -a</code> will not list it any more. This is best suited for development.</p>
<p>You can provide environment variables through the <code>-e</code> or <code>--env</code> option
or provide a file with the variables using <code>--env-file</code>.</p>
<p>Specifying the platform via <code>--platform</code> is needed when working with different
architectures, such as ARM64 and AMD64.
Setting resources available for the container is possible with the
<code>--cpus</code> (number of CPUs) and setting memory limits by <code>--memory</code>.</p>
<p>Docker containers and their file systems are considered ephemeral, which means
they are not expected to persist data for long. Therefore, it is recommended
to rely on external storage (databases, object stores) for anything that
needs to persist and you do not want it to disappear when the container is
deleted.</p>
<p>Docker can persist data on the file system using
<a href="https://docs.docker.com/storage/">bind mounts or volumes</a>.
Bind mounts may be stored anywhere on the host system and you can specify
this via the <code>--mount</code> option in <code>docker run</code>.
Compared to mounts, volumes are stored in a part of the host filesystem
which is managed by Docker and other processes should not modify this part of
the filesystem. You can specify volumes with the <code>--volume</code> option.
Persisting data on the file system is an advanced topic that we’ll see some
examples of later. We mention it here because managing file systems is also
part of the magic of <code>docker run</code>.</p>
<p>One more important flag is the <code>-d</code> or <code>--detach</code> flag. This starts the
container as a background process. You get back your terminal and can start
typing other commands. It can be a good idea to also add a name to the container
so we can find it easier without looking for its ID:</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb154-1"><a href="6-part2-containerizing-shiny-apps.html#cb154-1" tabindex="-1"></a><span class="ex">docker</span> run <span class="dt">\</span></span>
<span id="cb154-2"><a href="6-part2-containerizing-shiny-apps.html#cb154-2" tabindex="-1"></a>  <span class="at">--rm</span> <span class="dt">\</span></span>
<span id="cb154-3"><a href="6-part2-containerizing-shiny-apps.html#cb154-3" tabindex="-1"></a>  <span class="at">-d</span> <span class="dt">\</span></span>
<span id="cb154-4"><a href="6-part2-containerizing-shiny-apps.html#cb154-4" tabindex="-1"></a>  <span class="at">-p</span> 8080:3838 <span class="dt">\</span></span>
<span id="cb154-5"><a href="6-part2-containerizing-shiny-apps.html#cb154-5" tabindex="-1"></a>  <span class="at">--name</span> r-shiny <span class="dt">\</span></span>
<span id="cb154-6"><a href="6-part2-containerizing-shiny-apps.html#cb154-6" tabindex="-1"></a>  <span class="at">--restart</span><span class="op">=</span>always <span class="dt">\</span></span>
<span id="cb154-7"><a href="6-part2-containerizing-shiny-apps.html#cb154-7" tabindex="-1"></a>  ghcr.io/h10y/faithful/r-shiny:latest</span>
<span id="cb154-8"><a href="6-part2-containerizing-shiny-apps.html#cb154-8" tabindex="-1"></a></span>
<span id="cb154-9"><a href="6-part2-containerizing-shiny-apps.html#cb154-9" tabindex="-1"></a><span class="ex">docker</span> ps</span>
<span id="cb154-10"><a href="6-part2-containerizing-shiny-apps.html#cb154-10" tabindex="-1"></a></span>
<span id="cb154-11"><a href="6-part2-containerizing-shiny-apps.html#cb154-11" tabindex="-1"></a><span class="co"># CONTAINER ID   IMAGE</span></span>
<span id="cb154-12"><a href="6-part2-containerizing-shiny-apps.html#cb154-12" tabindex="-1"></a><span class="co"># 592caa564860   ghcr.io/h10y/faithful/r-shiny:latest</span></span>
<span id="cb154-13"><a href="6-part2-containerizing-shiny-apps.html#cb154-13" tabindex="-1"></a></span>
<span id="cb154-14"><a href="6-part2-containerizing-shiny-apps.html#cb154-14" tabindex="-1"></a><span class="co"># COMMAND                    CREATED          STATUS</span></span>
<span id="cb154-15"><a href="6-part2-containerizing-shiny-apps.html#cb154-15" tabindex="-1"></a><span class="co"># &quot;R -e &#39;shiny::runApp...&quot;   15 seconds ago   Up 14 seconds</span></span>
<span id="cb154-16"><a href="6-part2-containerizing-shiny-apps.html#cb154-16" tabindex="-1"></a></span>
<span id="cb154-17"><a href="6-part2-containerizing-shiny-apps.html#cb154-17" tabindex="-1"></a><span class="co"># PORTS                    NAMES</span></span>
<span id="cb154-18"><a href="6-part2-containerizing-shiny-apps.html#cb154-18" tabindex="-1"></a><span class="co"># 0.0.0.0:8080-&gt;3838/tcp   r-shiny</span></span></code></pre></div>
<p>The <code>docker ps</code> command lists running containers. You see not only the info
we provided with <code>docker run</code> or that were defined in the <code>Dockerfile</code>, but also
for how long the container has been running (time since its creation) and also
the status of the container.</p>
<p>The <code>docker run</code> command is equivalent of first creating a container that
consumes no resources yet with <code>docker create &lt;image-name&gt;</code> and then starting
this container with <code>docker start &lt;container-name-or-id&gt;</code>, but it is much
more convenient to use <code>docker run</code>.</p>
<p>When the container is running in the background, you cannot stop it with CTRL+C.
You have to manage it using the container ID or the container name.
To stop the container, use <code>docker stop &lt;container-name-or-id&gt;</code>.
This will “gracefully” shut down the Shiny app by sending a so called SIGTERM
signal to it. If you use <code>docker kill &lt;container-name-or-id&gt;</code> instead, the process
will be abruptly killed with a so called SIGKILL signal. Try <code>docker stop</code>
first.</p>
<p>None of these commands will remove the container. This means you can start it
again with <code>docker start &lt;container-name-or-id&gt;</code>, or remove it with
<code>docker rm &lt;container-name-or-id&gt;</code>. Notice the subtle difference between
<code>docker rm</code> (remove a container) and <code>docker rmi</code> (remove an image).
Most of the docker commands have aliases, use these if you want to be more
specific, e.g. <code>docker rmi</code> is an alias for <code>docker image rm</code>, whereas
<code>docker rm</code> is an alias for <code>docker container rm</code>.</p>
<p>If for some reason, the container running in the background experiences an issue,
like a unexpected user input, or it runs out of memory, the container will be
stopped by default. If you want a different behavior, use the <code>--restart</code> to
specify a restart policy:</p>
<ul>
<li><code>on-failure</code>: restart only if the container exits with a non-zero exit status,</li>
<li><code>unless-stopped</code>: restart the container unless it is explicitly stopped or
Docker itself is stopped or restarted,</li>
<li><code>always</code>: the Docker daemon tries to restart the container indefinitely
irrespective of the cause.</li>
</ul>
<p>A non-zero exit status and running out of resources are clear signs of the app
not running as expected. You will see in a bit how to troubleshoot
using the Docker logs. But in less serious cases, we might not know the
“health” of the container without looking at the logs or a user telling us
that something is not right. This is where health checks come in.
Before we introduce health checks, let’s stop the container:</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb155-1"><a href="6-part2-containerizing-shiny-apps.html#cb155-1" tabindex="-1"></a><span class="ex">docker</span> stop r-shiny</span></code></pre></div>
<p>We used the <code>--rm</code> flag, so the container will be removed after being stopped.
If we haven’t used the <code>--rm</code> flag, we would still see it listed with
<code>docker ps -a</code>.</p>
</div>
<div id="part2-health-check" class="section level3 hasAnchor" number="6.14.2">
<h3><span class="header-section-number">6.14.2</span> Health Check<a href="6-part2-containerizing-shiny-apps.html#part2-health-check" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Shiny apps, just like any other web application, can crash for many different
reasons. It might be due to a bug in the code, your user might do something
unexpected. Or simply, the app runs out of resources. This most often means
that it runs out of memory. In these cases, it becomes unresponsive,
although the process inside is still running. From a user experience standpoint,
an exited process is the same as a non-exited but unresponsive process.
From a monitoring perspective, one is easier to detect than the other.
The purpose of the health check is to report on the status of our application,
so that we know when it is “unhealthy”, which means users cannot access it.</p>
<p>The <code>HEALTHCHECK</code> Dockerfile instruction checks a container’s health on startup.
It is written as <code>HEALTHCHECK &lt;options&gt; CMD &lt;command&gt;</code>.
The options determine how often the health check command is run
(<code>--interval</code>, default is 30s), the timeout duration (<code>--timeout</code>,
default is 30s). If checks take longer than the timeout, it is considered to have
failed.</p>
<p>There is also a start period (<code>--start-period</code>, default is 0s)
After this period there are by default 3 retries (<code>--retries</code>) 5s apart
(<code>--start-interval</code>). The container is not considered unhealth during the set
number of retries. If a health check succeeds during the start period, the
container is considered started.</p>
<p>The health check command’s exit status indicates the health status of the
container. The exit status can be either 0 (healthy) or 1 (unhealthy).
Different commands might return different exit statuses. This is why you often
see the health check command formatted as <code>&lt;command&gt; || exit 1</code> which will
force any non-0 exit status to be 1.</p>
<p>For web applications, the simplest command would be to see if the main page
responds to a request. If we start the shiny app on port 3838,
the Curl command <code>curl --fail http://localhost:3838</code> returns the HTML of the
Shiny app or it fails due to the <code>--fail</code> flag (same as <code>-f</code>).</p>
<p>The health check instruction could look like this:</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb156-1"><a href="6-part2-containerizing-shiny-apps.html#cb156-1" tabindex="-1"></a><span class="kw">HEALTHCHECK</span> <span class="op">--interval=15s</span> \</span>
<span id="cb156-2"><a href="6-part2-containerizing-shiny-apps.html#cb156-2" tabindex="-1"></a>    <span class="kw">CMD</span> <span class="ex">curl</span> <span class="at">--fail</span> http://localhost:3838 <span class="kw">||</span> <span class="bu">exit</span> 1</span></code></pre></div>
<p>The <code>curl</code> command might or might not be installed in your image. The
<code>ubuntu:24.04</code> parent image does not ship <code>curl</code>, so you have to add this
to the <code>RUN</code> instructions that install system requirements.
Alternatively, you can use <code>bash</code> (which is available on <code>ubuntu:24.04</code>
but not on <code>alpine:3.20</code>):</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb157-1"><a href="6-part2-containerizing-shiny-apps.html#cb157-1" tabindex="-1"></a><span class="kw">HEALTHCHECK</span> <span class="kw">CMD</span> <span class="fu">bash</span> <span class="at">-c</span> <span class="st">&#39;:&gt; /dev/tcp/127.0.0.1/3838&#39;</span> <span class="kw">||</span> <span class="bu">exit</span> 1</span></code></pre></div>
<p>This <code>bash</code> command redirects (<code>&gt;</code>) a null value (<code>:</code>) to the TCP port
3838 on the local host, which is available from inside the container.</p>
<p>Let’s try adding a health check to the <code>ghcr.io/h10y/faithful/r-shiny</code> image
and see how we might be able to see the health status. We can add the
command through the <code>--health-cmd</code> option of the <code>docker run</code>:</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb158-1"><a href="6-part2-containerizing-shiny-apps.html#cb158-1" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--rm</span> <span class="at">-d</span> <span class="at">-p</span> 8080:3838 <span class="dt">\</span></span>
<span id="cb158-2"><a href="6-part2-containerizing-shiny-apps.html#cb158-2" tabindex="-1"></a>  <span class="at">--name</span> healthy <span class="dt">\</span></span>
<span id="cb158-3"><a href="6-part2-containerizing-shiny-apps.html#cb158-3" tabindex="-1"></a>  <span class="at">--health-cmd</span><span class="op">=</span><span class="st">&quot;bash -c &#39;:&gt; /dev/tcp/127.0.0.1/3838&#39; || exit 1&quot;</span> <span class="dt">\</span></span>
<span id="cb158-4"><a href="6-part2-containerizing-shiny-apps.html#cb158-4" tabindex="-1"></a>  ghcr.io/h10y/faithful/r-shiny:latest</span></code></pre></div>
<p>Let’s start another container with a health check targeting a different port,
this will cause the check to fail. Note that the <code>healthy</code> container is already
using the 8080 port, we map the <code>unhealthy</code> container to port 8081:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb159-1"><a href="6-part2-containerizing-shiny-apps.html#cb159-1" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--rm</span> <span class="at">-d</span> <span class="at">-p</span> 8081:3838 <span class="dt">\</span></span>
<span id="cb159-2"><a href="6-part2-containerizing-shiny-apps.html#cb159-2" tabindex="-1"></a>  <span class="at">--name</span> unhealthy <span class="dt">\</span></span>
<span id="cb159-3"><a href="6-part2-containerizing-shiny-apps.html#cb159-3" tabindex="-1"></a>  <span class="at">--health-cmd</span><span class="op">=</span><span class="st">&quot;bash -c &#39;:&gt; /dev/tcp/127.0.0.1/4949&#39; || exit 1&quot;</span> <span class="dt">\</span></span>
<span id="cb159-4"><a href="6-part2-containerizing-shiny-apps.html#cb159-4" tabindex="-1"></a>  ghcr.io/h10y/faithful/r-shiny:latest</span></code></pre></div>
<p>Try <code>docker ps</code> a few times. The status for the healthy image should be <code>(healthy)</code>.
The unhealthy image should display <code>(health: starting)</code>, which would switch
to <code>(unhealthy)</code> after the start period. You can also access the health status
with the <code>docker inspect</code> command. You’ll need the <code>jq</code> command line tool that
can parse JSON output:</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb160-1"><a href="6-part2-containerizing-shiny-apps.html#cb160-1" tabindex="-1"></a><span class="ex">docker</span> inspect <span class="at">--format</span> <span class="st">&quot;{{json .State.Health }}&quot;</span> healthy <span class="kw">|</span> <span class="ex">jq</span></span>
<span id="cb160-2"><a href="6-part2-containerizing-shiny-apps.html#cb160-2" tabindex="-1"></a><span class="co"># {</span></span>
<span id="cb160-3"><a href="6-part2-containerizing-shiny-apps.html#cb160-3" tabindex="-1"></a><span class="co">#   &quot;Status&quot;: &quot;healthy&quot;,</span></span>
<span id="cb160-4"><a href="6-part2-containerizing-shiny-apps.html#cb160-4" tabindex="-1"></a><span class="co">#   &quot;FailingStreak&quot;: 0,</span></span>
<span id="cb160-5"><a href="6-part2-containerizing-shiny-apps.html#cb160-5" tabindex="-1"></a><span class="co">#   &quot;Log&quot;: [</span></span>
<span id="cb160-6"><a href="6-part2-containerizing-shiny-apps.html#cb160-6" tabindex="-1"></a><span class="co">#     {</span></span>
<span id="cb160-7"><a href="6-part2-containerizing-shiny-apps.html#cb160-7" tabindex="-1"></a><span class="co">#       &quot;Start&quot;: &quot;2024-07-17T08:29:36.969572509Z&quot;,</span></span>
<span id="cb160-8"><a href="6-part2-containerizing-shiny-apps.html#cb160-8" tabindex="-1"></a><span class="co">#       &quot;End&quot;: &quot;2024-07-17T08:29:37.0504063Z&quot;,</span></span>
<span id="cb160-9"><a href="6-part2-containerizing-shiny-apps.html#cb160-9" tabindex="-1"></a><span class="co">#       &quot;ExitCode&quot;: 0,</span></span>
<span id="cb160-10"><a href="6-part2-containerizing-shiny-apps.html#cb160-10" tabindex="-1"></a><span class="co">#       &quot;Output&quot;: &quot;&quot;</span></span>
<span id="cb160-11"><a href="6-part2-containerizing-shiny-apps.html#cb160-11" tabindex="-1"></a><span class="co">#     },</span></span>
<span id="cb160-12"><a href="6-part2-containerizing-shiny-apps.html#cb160-12" tabindex="-1"></a><span class="co">#     [...]</span></span>
<span id="cb160-13"><a href="6-part2-containerizing-shiny-apps.html#cb160-13" tabindex="-1"></a><span class="co"># }</span></span></code></pre></div>
<p>The output shows the health check results and the failing streak (how many times
the check has failed in a row). A 0 failing streak is your target.
The same command for the <code>unhealthy</code> container would show a very unhealthy
failing streak:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb161-1"><a href="6-part2-containerizing-shiny-apps.html#cb161-1" tabindex="-1"></a><span class="ex">docker</span> inspect <span class="at">--format</span> <span class="st">&quot;{{json .State.Health }}&quot;</span> unhealthy <span class="kw">|</span> <span class="ex">jq</span></span>
<span id="cb161-2"><a href="6-part2-containerizing-shiny-apps.html#cb161-2" tabindex="-1"></a><span class="co"># {</span></span>
<span id="cb161-3"><a href="6-part2-containerizing-shiny-apps.html#cb161-3" tabindex="-1"></a><span class="co">#   &quot;Status&quot;: &quot;unhealthy&quot;,</span></span>
<span id="cb161-4"><a href="6-part2-containerizing-shiny-apps.html#cb161-4" tabindex="-1"></a><span class="co">#   &quot;FailingStreak&quot;: 10,</span></span>
<span id="cb161-5"><a href="6-part2-containerizing-shiny-apps.html#cb161-5" tabindex="-1"></a><span class="co">#   &quot;Log&quot;: [</span></span>
<span id="cb161-6"><a href="6-part2-containerizing-shiny-apps.html#cb161-6" tabindex="-1"></a><span class="co">#     {</span></span>
<span id="cb161-7"><a href="6-part2-containerizing-shiny-apps.html#cb161-7" tabindex="-1"></a><span class="co">#       &quot;Start&quot;: &quot;2024-07-17T08:30:13.47309747Z&quot;,</span></span>
<span id="cb161-8"><a href="6-part2-containerizing-shiny-apps.html#cb161-8" tabindex="-1"></a><span class="co">#       &quot;End&quot;: &quot;2024-07-17T08:30:13.572182554Z&quot;,</span></span>
<span id="cb161-9"><a href="6-part2-containerizing-shiny-apps.html#cb161-9" tabindex="-1"></a><span class="co">#       &quot;ExitCode&quot;: 1,</span></span>
<span id="cb161-10"><a href="6-part2-containerizing-shiny-apps.html#cb161-10" tabindex="-1"></a><span class="co">#       &quot;Output&quot;: &quot;bash: connect: Connection refused</span></span>
<span id="cb161-11"><a href="6-part2-containerizing-shiny-apps.html#cb161-11" tabindex="-1"></a><span class="co">#         bash: line 1: /dev/tcp/127.0.0.1/4949: Connection refused&quot;</span></span>
<span id="cb161-12"><a href="6-part2-containerizing-shiny-apps.html#cb161-12" tabindex="-1"></a><span class="co">#     },</span></span>
<span id="cb161-13"><a href="6-part2-containerizing-shiny-apps.html#cb161-13" tabindex="-1"></a><span class="co">#     [...]</span></span>
<span id="cb161-14"><a href="6-part2-containerizing-shiny-apps.html#cb161-14" tabindex="-1"></a><span class="co"># }</span></span></code></pre></div>
<p>Health checks can be more complex than pinging the Shiny app endpoint.
For example if your application depends on connecting to external databases
and APIs, you might want to include multiple checks in a single script file.
These can be shell scripts, R, or Python scripts and can also rely on
environment variables that contain access tokens during the container run time.
You can include this script file in your image and add the corresponding
instruction as:</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb162-1"><a href="6-part2-containerizing-shiny-apps.html#cb162-1" tabindex="-1"></a><span class="kw">HEALTHCHECK</span> <span class="kw">CMD</span> <span class="ex">./healthcheck.sh</span></span></code></pre></div>
</div>
<div id="part2-container-life-cycle" class="section level3 hasAnchor" number="6.14.3">
<h3><span class="header-section-number">6.14.3</span> Container Life Cycle<a href="6-part2-containerizing-shiny-apps.html#part2-container-life-cycle" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>You have seen the some of the possible statuses of containers. Let’s review
the container life cycle in a bit more details so that you get a better sense
of how to manage containers that are in different states.
Figure <a href="6-part2-containerizing-shiny-apps.html#fig:part2-container-lifecycle">6.4</a> illustrates the container life cycle.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:part2-container-lifecycle"></span>
<img src="images/02/container-life-cycle.png" alt="The Docker container life cycle." width="100%" />
<p class="caption">
Figure 6.4: The Docker container life cycle.
</p>
</div>
<p>Containers can be in one of seven states:
<code>created</code>, <code>running</code>, <code>paused</code>, <code>restarting</code>, <code>exited</code>, <code>removing</code>, and <code>dead</code>.
First the container is <code>created</code>, which means it has never been started.
A freshly created container does not yet consumes resources.</p>
<p>After the startup, the container is either <code>running</code> or <code>exited</code>.
An <code>exited</code> status can mean that the container finished its job and exited with
status code <code>0</code>, or instead of <code>running</code>, the container failed to start and
exited with an error code <code>1</code>. The exited container does not consumes resources.</p>
<p>A <code>running</code> container is started by either <code>docker start</code> or <code>docker run</code>.
It might have a web server listening to incoming traffic,
as is the case with Shiny. The start is considered successfully if the container
is up for at least 10 seconds and Docker has started monitoring it.
The health check does not immediately affect the
state of the container as long as the main process is running, but the
information might be used by the orchestration service (i.e. Kubernetes)
to decide the fate of the container and replace it with a new instance.</p>
<p>A container that is no longer running enters the <code>exited</code> state.
This might be due to a CTRL+C signal, an exit code of <code>1</code>. It can be due to the
container running out of resources, for example exceeding the set memory limit.
You can also use the <code>docker stop</code> to stop the container.
When using <code>docker stop</code>, the main process inside the container will receive
a SIGTERM signal, and after a grace period, a SIGKILL.
The <code>docker kill</code> command sends SIGKILL immediately to stop the container.</p>
<p>An <code>exited</code> container can be started again with <code>docker start</code>. It can also
enter the <code>restarting</code> state when the orchestrator tries to restart a failed
container due to a set restart policy. The restart policy will not apply to
containers stopped manually.</p>
<p>A running container can enter the <code>restarting</code> state due to the designated restart
policy or by calling the <code>docker restart</code> command on a running container.
After that, the container will enter the <code>running</code> (or the <code>exited</code>) state.</p>
<p>If you pause a running container with <code>docker pause</code> it will be considered <code>paused</code>.
All processes are suspended for an indefinite time, memory is still allocated
to store the state of the running container, but no CPU resources are used.
You can unpause the container with <code>docker unpause</code>.</p>
<p>You can remove a container with <code>docker rm</code>. You might have to force the removal
of a running container with the <code>--force</code> (or <code>-f</code>) flag. The forced stop will
use SIGKILL, thus is equivalent to first stopping the container with <code>docker kill</code>
and then removing it. The container will be in <code>removing</code> while the container
is in the process of being removed.</p>
<p>After the container is removed it will no longer exist unless there was a problem
with the removal process. For example the container was only partially removed
because resources were kept busy by an external process. Such a “defunct” container
is called a <code>dead</code> container and it cannot be started, restarted, only removed.</p>
<p>You can check the status of the two containers that we were using for
the health check (we called them <code>healthy</code> and <code>unhealthy</code>) as:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb163-1"><a href="6-part2-containerizing-shiny-apps.html#cb163-1" tabindex="-1"></a><span class="ex">docker</span> inspect <span class="at">--format</span> <span class="st">&#39;{{.State.Status}}&#39;</span> healthy</span>
<span id="cb163-2"><a href="6-part2-containerizing-shiny-apps.html#cb163-2" tabindex="-1"></a><span class="co"># running</span></span>
<span id="cb163-3"><a href="6-part2-containerizing-shiny-apps.html#cb163-3" tabindex="-1"></a></span>
<span id="cb163-4"><a href="6-part2-containerizing-shiny-apps.html#cb163-4" tabindex="-1"></a><span class="ex">docker</span> inspect <span class="at">--format</span> <span class="st">&#39;{{.State.Status}}&#39;</span> unhealthy</span>
<span id="cb163-5"><a href="6-part2-containerizing-shiny-apps.html#cb163-5" tabindex="-1"></a><span class="co"># running</span></span></code></pre></div>
<p>The <code>--format</code> instruction tells Docker to give us only the <code>State</code> related
parts of the overall object returned by the <code>docker inspect</code> command.
Within that list, we are interested in the <code>Status</code> property. This is what the
<code>.State.Status</code> notation means.</p>
<p>There are other interesting properties as part of the <code>State</code>. <code>Status</code> and
<code>Health</code> are two properties that we have seen. But there are others:</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb164-1"><a href="6-part2-containerizing-shiny-apps.html#cb164-1" tabindex="-1"></a><span class="ex">docker</span> inspect <span class="at">--format</span> <span class="st">&quot;{{json .State }}&quot;</span> healthy <span class="kw">|</span> <span class="ex">jq</span></span>
<span id="cb164-2"><a href="6-part2-containerizing-shiny-apps.html#cb164-2" tabindex="-1"></a><span class="co"># {</span></span>
<span id="cb164-3"><a href="6-part2-containerizing-shiny-apps.html#cb164-3" tabindex="-1"></a><span class="co">#   &quot;Status&quot;: &quot;running&quot;,</span></span>
<span id="cb164-4"><a href="6-part2-containerizing-shiny-apps.html#cb164-4" tabindex="-1"></a><span class="co">#   &quot;Running&quot;: true,</span></span>
<span id="cb164-5"><a href="6-part2-containerizing-shiny-apps.html#cb164-5" tabindex="-1"></a><span class="co">#   &quot;Paused&quot;: false,</span></span>
<span id="cb164-6"><a href="6-part2-containerizing-shiny-apps.html#cb164-6" tabindex="-1"></a><span class="co">#   &quot;Restarting&quot;: false,</span></span>
<span id="cb164-7"><a href="6-part2-containerizing-shiny-apps.html#cb164-7" tabindex="-1"></a><span class="co">#   &quot;OOMKilled&quot;: false,</span></span>
<span id="cb164-8"><a href="6-part2-containerizing-shiny-apps.html#cb164-8" tabindex="-1"></a><span class="co">#   &quot;Dead&quot;: false,</span></span>
<span id="cb164-9"><a href="6-part2-containerizing-shiny-apps.html#cb164-9" tabindex="-1"></a><span class="co">#   &quot;Pid&quot;: 570,</span></span>
<span id="cb164-10"><a href="6-part2-containerizing-shiny-apps.html#cb164-10" tabindex="-1"></a><span class="co">#   &quot;ExitCode&quot;: 0,</span></span>
<span id="cb164-11"><a href="6-part2-containerizing-shiny-apps.html#cb164-11" tabindex="-1"></a><span class="co">#   &quot;Error&quot;: &quot;&quot;,</span></span>
<span id="cb164-12"><a href="6-part2-containerizing-shiny-apps.html#cb164-12" tabindex="-1"></a><span class="co">#   &quot;StartedAt&quot;: &quot;2024-07-18T10:20:34.182018084Z&quot;,</span></span>
<span id="cb164-13"><a href="6-part2-containerizing-shiny-apps.html#cb164-13" tabindex="-1"></a><span class="co">#   &quot;FinishedAt&quot;: &quot;0001-01-01T00:00:00Z&quot;,</span></span>
<span id="cb164-14"><a href="6-part2-containerizing-shiny-apps.html#cb164-14" tabindex="-1"></a><span class="co">#   &quot;Health&quot;: {</span></span>
<span id="cb164-15"><a href="6-part2-containerizing-shiny-apps.html#cb164-15" tabindex="-1"></a><span class="co">#     &quot;Status&quot;: &quot;healthy&quot;,</span></span>
<span id="cb164-16"><a href="6-part2-containerizing-shiny-apps.html#cb164-16" tabindex="-1"></a><span class="co">#     &quot;FailingStreak&quot;: 0,</span></span>
<span id="cb164-17"><a href="6-part2-containerizing-shiny-apps.html#cb164-17" tabindex="-1"></a><span class="co">#     &quot;Log&quot;: [</span></span>
<span id="cb164-18"><a href="6-part2-containerizing-shiny-apps.html#cb164-18" tabindex="-1"></a><span class="co">#       [...]</span></span>
<span id="cb164-19"><a href="6-part2-containerizing-shiny-apps.html#cb164-19" tabindex="-1"></a><span class="co">#     ]</span></span>
<span id="cb164-20"><a href="6-part2-containerizing-shiny-apps.html#cb164-20" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb164-21"><a href="6-part2-containerizing-shiny-apps.html#cb164-21" tabindex="-1"></a><span class="co"># }</span></span></code></pre></div>
</div>
<div id="part2-containers-managing" class="section level3 hasAnchor" number="6.14.4">
<h3><span class="header-section-number">6.14.4</span> Managing Containers<a href="6-part2-containerizing-shiny-apps.html#part2-containers-managing" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here we summarize the most important commands related to containers.
The <code>docker ps</code> command lists the containers. If you have container
running, you will see those listed with status <code>Up</code> (i.e. <code>running</code>).</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb165-1"><a href="6-part2-containerizing-shiny-apps.html#cb165-1" tabindex="-1"></a><span class="ex">docker</span> ps</span>
<span id="cb165-2"><a href="6-part2-containerizing-shiny-apps.html#cb165-2" tabindex="-1"></a><span class="co"># CONTAINER ID   IMAGE</span></span>
<span id="cb165-3"><a href="6-part2-containerizing-shiny-apps.html#cb165-3" tabindex="-1"></a><span class="co"># c31e8c365534   ghcr.io/h10y/faithful/r-shiny:latest</span></span>
<span id="cb165-4"><a href="6-part2-containerizing-shiny-apps.html#cb165-4" tabindex="-1"></a><span class="co"># c2a7f34d38bc   ghcr.io/h10y/faithful/r-shiny:latest</span></span>
<span id="cb165-5"><a href="6-part2-containerizing-shiny-apps.html#cb165-5" tabindex="-1"></a></span>
<span id="cb165-6"><a href="6-part2-containerizing-shiny-apps.html#cb165-6" tabindex="-1"></a><span class="co"># COMMAND                    CREATED          STATUS</span></span>
<span id="cb165-7"><a href="6-part2-containerizing-shiny-apps.html#cb165-7" tabindex="-1"></a><span class="co"># &quot;R -e &#39;shiny::runApp...&quot;   14 minutes ago   Up 14 minutes (unhealthy)</span></span>
<span id="cb165-8"><a href="6-part2-containerizing-shiny-apps.html#cb165-8" tabindex="-1"></a><span class="co"># &quot;R -e &#39;shiny::runApp...&quot;   14 minutes ago   Up 14 minutes (healthy)</span></span>
<span id="cb165-9"><a href="6-part2-containerizing-shiny-apps.html#cb165-9" tabindex="-1"></a></span>
<span id="cb165-10"><a href="6-part2-containerizing-shiny-apps.html#cb165-10" tabindex="-1"></a><span class="co"># PORTS                    NAMES</span></span>
<span id="cb165-11"><a href="6-part2-containerizing-shiny-apps.html#cb165-11" tabindex="-1"></a><span class="co"># 0.0.0.0:8081-&gt;3838/tcp   unhealthy</span></span>
<span id="cb165-12"><a href="6-part2-containerizing-shiny-apps.html#cb165-12" tabindex="-1"></a><span class="co"># 0.0.0.0:8080-&gt;3838/tcp   healthy</span></span></code></pre></div>
<p><code>docker container stats</code> displays a live stream of the containers’ resource
usage statistics (hit CTRL+C to exit):</p>
<pre><code>CONTAINER ID   NAME        CPU %     MEM USAGE / LIMIT     MEM %
c8c4dad4e371   unhealthy   0.18%     94.35MiB / 7.657GiB   1.20%
3b44c40aadb7   healthy     0.11%     122MiB / 7.657GiB     1.56%</code></pre>
<p>Use <code>docker logs &lt;container-name-or-id&gt;</code> will print (all) the logs for a
given container. Logs are made up of the container’s STDOUT and STDERR.
To print only the tail of the logs use
<code>docker logs -n 10 &lt;container-name-or-id&gt;</code> that will print the last 10 lines.
To follow the logs in real time, use <code>docker logs -f &lt;container-name-or-id&gt;</code>.</p>
<p>The <code>docker exec</code> command executes a command in a running container.
For example <code>docker exec -it healthy sh</code> will start a shell in the <code>healthy</code>
container we still have running. The <code>-it</code> flag stands for the combination of
<code>--interactive</code> (keep standard input, STDIN, open) and <code>--tty</code> (pseudo
“teletypewriter”) so we can use the shell interactively.</p>
<p>Start poking around, try typing a few commands:</p>
<ul>
<li><code>whoami</code> should return <code>app</code> as the user name,</li>
<li><code>pwd</code> should return <code>/home/app</code> as per our Dockerfile instructions,</li>
<li><code>env</code> lists environment variables.</li>
</ul>
<p>Exit the container’s shell with <code>exit</code>.</p>
<p>To evaluate a command in the container, try
<code>docker exec -it healthy sh -c "whoami"</code>.</p>
<p>Let’s stop the containers with <code>docker stop healthy unhealthy</code> (yes, you can
pass an array of container names to <code>docker stop</code>).
You can also stop all running containers with <code>docker stop $(docker ps -q)</code>
and all (running and stopped) containers with <code>docker stop $(docker ps -a -q)</code>.
The <code>$(...)</code> shell expression executes the command within the parentheses and
inserts the output and <code>$(docker ps -q)</code> will print out the container IDs.</p>
<p>If you stopped all the containers, you will not see any running containers listed
with <code>docker ps</code>. To see the stopped but not removed containers,
use the <code>docker ps -a</code> command. We started the <code>healthy</code> and <code>unhealthy</code>
containers with the <code>--rm</code> flag, so those were removed after being stopped.
As a result, not even <code>docker ps -a</code> will list them.</p>
<p>Sometimes you need to be able to manage containers because the kill signal
is not properly relayed to the container when using CTRL+C. This happens when
the <code>CMD</code> instruction is provided in shell form
(i.e. <code>CMD R -e "shiny::runApp()"</code> instead of <code>CMD ["R", "-e", "shiny::runApp()"]</code>).
The shell form runs as a child process of <code>/bin/sh -c</code> (default <code>ENTRYPOINT</code>),
and the executable does not receive Unix signals.
If this happens, you need to find a way to stop the container.</p>
<p>These are the most commonly used commands with containers:</p>
<ul>
<li><code>docker container stop &lt;container-id&gt;</code>: gracefully stop a running container
(wait for the process to stop),</li>
<li><code>docker container start &lt;container-id&gt;</code>: start a stopped container,</li>
<li><code>docker container restart &lt;container-id&gt;</code>: restart a container,</li>
<li><code>docker container rm &lt;container-id&gt;</code>; remove a container,</li>
<li><code>docker container kill &lt;container-id&gt;</code>: kill a container (abruptly terminate
the entry point process).</li>
</ul>
<p><code>docker container rm --force &lt;container-id&gt;</code> will remove running containers too.
You can make sure the container is removed after CTRL+C if you add the <code>--rm</code>
option to the <code>docker run</code> command and it will automatically remove the container
when it exits.</p>
</div>
<div id="part2-docker-compose" class="section level3 hasAnchor" number="6.14.5">
<h3><span class="header-section-number">6.14.5</span> Docker Compose<a href="6-part2-containerizing-shiny-apps.html#part2-docker-compose" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>You have seen how to manage a single container. But in practice, we often
manage multiple containers: multiple replicas of the same app, different
applications, and services that help with sending traffic to the right places,
collect diagnostic information, provide a layer of security etc.</p>
<p>Managing all this complexity with Docker on a single container basis is going
to be a problem. It is not impossible, but it will be difficult and error prone,
and as a result less secure.</p>
<p>Docker Compose is a tool for defining and running multi-container applications.
Docker Compose is declarative in nature, it uses a single, comprehensible YAML
configuration file to define the expected state of your system. The YAML defines
the services, networks, and volumes.</p>
<p>Version 1 of the Docker Compose project stopped receiving updates from July 2023.
Compose Version 2 is included with any new install of Docker Desktop. Version 2
uses BuildKit, and has continued new-feature development.</p>
<p>You might see commands starting with <code>docker-compose</code>. That used to be the
command for Version 1. It is now an alias for <code>docker compose</code> by default.
It is important to be aware of this historical difference because most examples
that you find online might refer to the use of Version 1 and <code>docker-compose</code>.
We will use the recommended Version 2 and <code>docker compose</code> for our examples
to make this distinction clear.</p>
</div>
<div id="part2-compose-file" class="section level3 hasAnchor" number="6.14.6">
<h3><span class="header-section-number">6.14.6</span> The Compose File<a href="6-part2-containerizing-shiny-apps.html#part2-compose-file" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>You will see older tutorials using <code>docker-compose.yml</code> which refers to
Version 1 of Docker Compose. Version 2 still supports this file naming,
but <code>compose.yaml</code> is recommended to make the distinction clear.</p>
<p>Create an empty text file named <code>compose.yaml</code> and copy-pase this into it.</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb167-1"><a href="6-part2-containerizing-shiny-apps.html#cb167-1" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb167-2"><a href="6-part2-containerizing-shiny-apps.html#cb167-2" tabindex="-1"></a><span class="at">  </span><span class="fu">faithful</span><span class="kw">:</span></span>
<span id="cb167-3"><a href="6-part2-containerizing-shiny-apps.html#cb167-3" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;ghcr.io/h10y/faithful/py-shiny:main&quot;</span></span>
<span id="cb167-4"><a href="6-part2-containerizing-shiny-apps.html#cb167-4" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb167-5"><a href="6-part2-containerizing-shiny-apps.html#cb167-5" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;8080:3838&quot;</span></span>
<span id="cb167-6"><a href="6-part2-containerizing-shiny-apps.html#cb167-6" tabindex="-1"></a><span class="at">  </span><span class="fu">bananas</span><span class="kw">:</span></span>
<span id="cb167-7"><a href="6-part2-containerizing-shiny-apps.html#cb167-7" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;ghcr.io/h10y/bananas/r-shiny:main&quot;</span></span>
<span id="cb167-8"><a href="6-part2-containerizing-shiny-apps.html#cb167-8" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb167-9"><a href="6-part2-containerizing-shiny-apps.html#cb167-9" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;8081:3838&quot;</span></span>
<span id="cb167-10"><a href="6-part2-containerizing-shiny-apps.html#cb167-10" tabindex="-1"></a><span class="at">    </span><span class="fu">environment</span><span class="kw">:</span></span>
<span id="cb167-11"><a href="6-part2-containerizing-shiny-apps.html#cb167-11" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> DEBUG=1</span></span></code></pre></div>
<p>FIXME: provide link to the example.</p>
<p>The Compose file specification has several top level elements:</p>
<ul>
<li><code>version</code> is obsolete but can be important for backwards compatibility.</li>
<li><code>name</code> is a value to override the default project name that is derived from
the base name of the project directory.</li>
<li><code>services</code> must be defined, it is the abstract definition of a computing resource
within an application that can be “composed” together and modified
independently from other components.</li>
<li><code>networks</code> defines how the services communicate with each other. By default,
each container for a service joins the default network and is reachable by
other containers.</li>
<li><code>volumes</code> are persistent data stores.</li>
</ul>
<p>In our simple example we only use <code>services</code> and define two Shiny apps.
You will see more complex examples later.
Services are listed by name, each service is followed by their attributes.
Attributes are very similar to the command line options we saw for <code>docker run</code>.
See the <a href="https://docs.docker.com/compose/compose-file/">Compose file specification</a>
for all the details.</p>
<p>The compose file can also define a service via a Dockerfile under the
<code>build</code> attribute. The image will be built and started by Compose.
Similarly, you can define the <code>image</code> attribute for pulling the image from a
registry. The <code>ports</code> attribute should look familiar by now. It is used to
define the port mappings between the host machine (left side of the colon)
and the containers (right side of the colon). Notice the
double quotes in the YAML file. Some characters, like <code>*</code> or <code>:</code> have special
meaning in YAML, thus values containing these should be double quoted.</p>
<p>We defined two services, the Python version of the Faithful example and
the R version of the Bananas app. You see environment variables defined for
the <code>bananas</code> service.</p>
</div>
<div id="part2-compose-cli" class="section level3 hasAnchor" number="6.14.7">
<h3><span class="header-section-number">6.14.7</span> Compose Command Line<a href="6-part2-containerizing-shiny-apps.html#part2-compose-cli" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>You can use Docker Compose through the <code>docker compose</code> command of the
Docker Command Line Interface (CLI), and its subcommands.
Let’s review the most important commands. Change your working directory
so that the <code>compose.yaml</code> file is in the root of that folder.
Start all the services defined in your <code>compose.yaml</code> file as:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb168-1"><a href="6-part2-containerizing-shiny-apps.html#cb168-1" tabindex="-1"></a><span class="ex">docker</span> compose up</span>
<span id="cb168-2"><a href="6-part2-containerizing-shiny-apps.html#cb168-2" tabindex="-1"></a><span class="co"># [+] Running 10/10</span></span>
<span id="cb168-3"><a href="6-part2-containerizing-shiny-apps.html#cb168-3" tabindex="-1"></a><span class="co">#  ✔ bananas Pulled                                        13.8s</span></span>
<span id="cb168-4"><a href="6-part2-containerizing-shiny-apps.html#cb168-4" tabindex="-1"></a><span class="co"># [...]</span></span>
<span id="cb168-5"><a href="6-part2-containerizing-shiny-apps.html#cb168-5" tabindex="-1"></a><span class="co">#  ✔ faithful Pulled                                        1.0s</span></span>
<span id="cb168-6"><a href="6-part2-containerizing-shiny-apps.html#cb168-6" tabindex="-1"></a><span class="co"># [+] Running 3/3</span></span>
<span id="cb168-7"><a href="6-part2-containerizing-shiny-apps.html#cb168-7" tabindex="-1"></a><span class="co">#  ✔ Network 03-compose_default       Created               0.1s</span></span>
<span id="cb168-8"><a href="6-part2-containerizing-shiny-apps.html#cb168-8" tabindex="-1"></a><span class="co">#  ✔ Container 03-compose-faithful-1  Created               0.3s</span></span>
<span id="cb168-9"><a href="6-part2-containerizing-shiny-apps.html#cb168-9" tabindex="-1"></a><span class="co">#  ✔ Container 03-compose-bananas-1   Created               0.3s</span></span>
<span id="cb168-10"><a href="6-part2-containerizing-shiny-apps.html#cb168-10" tabindex="-1"></a><span class="co"># [...]</span></span>
<span id="cb168-11"><a href="6-part2-containerizing-shiny-apps.html#cb168-11" tabindex="-1"></a><span class="co"># bananas-1   | Listening on http://0.0.0.0:3838</span></span>
<span id="cb168-12"><a href="6-part2-containerizing-shiny-apps.html#cb168-12" tabindex="-1"></a><span class="co"># [...]</span></span>
<span id="cb168-13"><a href="6-part2-containerizing-shiny-apps.html#cb168-13" tabindex="-1"></a><span class="co"># faithful-1  | INFO:     Uvicorn running on http://0.0.0.0:3838 [...]</span></span></code></pre></div>
<p>You’ll see logs appearing in your terminal. First about pulling the images if
those are not yet available, or if a newer version can be found.
Visit <code>http://localhost:8080</code> to see the Faithful app and
<code>http://localhost:8081</code> to see the Bananas app.
Hit CTRL+C in the terminal to stop the containers.</p>
<p>Similarly to <code>docker run</code>, we can use the <code>-d</code> (or <code>--detach</code>) flag to start
the containers in the background as <code>docker compose up -d</code>.
You’ll get back your terminal. Use <code>docker compose ls</code> to list currently running
Compose projects:</p>
<p>FIXME: edit the compose project name according to example repo name.</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb169-1"><a href="6-part2-containerizing-shiny-apps.html#cb169-1" tabindex="-1"></a><span class="ex">docker</span> compose ls</span>
<span id="cb169-2"><a href="6-part2-containerizing-shiny-apps.html#cb169-2" tabindex="-1"></a><span class="co"># NAME                STATUS              CONFIG FILES</span></span>
<span id="cb169-3"><a href="6-part2-containerizing-shiny-apps.html#cb169-3" tabindex="-1"></a><span class="co"># 03-compose          running(2)          compose.yaml</span></span></code></pre></div>
<p>Use <code>docker compose ps</code> to list the containers for the current Compose project:</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb170-1"><a href="6-part2-containerizing-shiny-apps.html#cb170-1" tabindex="-1"></a><span class="ex">docker</span> compose ps</span>
<span id="cb170-2"><a href="6-part2-containerizing-shiny-apps.html#cb170-2" tabindex="-1"></a><span class="co"># NAME                    IMAGE</span></span>
<span id="cb170-3"><a href="6-part2-containerizing-shiny-apps.html#cb170-3" tabindex="-1"></a><span class="co"># 03-compose-bananas-1    ghcr.io/h10y/bananas/r-shiny:main</span></span>
<span id="cb170-4"><a href="6-part2-containerizing-shiny-apps.html#cb170-4" tabindex="-1"></a><span class="co"># 03-compose-faithful-1   ghcr.io/h10y/faithful/py-shiny:main</span></span>
<span id="cb170-5"><a href="6-part2-containerizing-shiny-apps.html#cb170-5" tabindex="-1"></a></span>
<span id="cb170-6"><a href="6-part2-containerizing-shiny-apps.html#cb170-6" tabindex="-1"></a><span class="co"># COMMAND                  SERVICE</span></span>
<span id="cb170-7"><a href="6-part2-containerizing-shiny-apps.html#cb170-7" tabindex="-1"></a><span class="co"># &quot;R -e &#39;shiny::runApp…&quot;   bananas</span></span>
<span id="cb170-8"><a href="6-part2-containerizing-shiny-apps.html#cb170-8" tabindex="-1"></a><span class="co"># &quot;uvicorn app:app --h…&quot;   faithful</span></span>
<span id="cb170-9"><a href="6-part2-containerizing-shiny-apps.html#cb170-9" tabindex="-1"></a></span>
<span id="cb170-10"><a href="6-part2-containerizing-shiny-apps.html#cb170-10" tabindex="-1"></a><span class="co"># CREATED          STATUS          PORTS</span></span>
<span id="cb170-11"><a href="6-part2-containerizing-shiny-apps.html#cb170-11" tabindex="-1"></a><span class="co"># 11 minutes ago   Up 17 seconds   0.0.0.0:8081-&gt;3838/tcp</span></span>
<span id="cb170-12"><a href="6-part2-containerizing-shiny-apps.html#cb170-12" tabindex="-1"></a><span class="co"># 11 minutes ago   Up 17 seconds   0.0.0.0:8080-&gt;3838/tcp</span></span></code></pre></div>
<p>Use <code>docker compose logs</code> to get visibility into the logs when containers are
running in detached mode. Logs can grow long. Use the <code>-n</code> option to show the
tail of the logs: <code>docker compose logs -n 10</code> will show the last 10 lines of the
logs; <code>docker compose logs -n 10 bananas</code> will show the last 10 lines of
the logs for the Bananas app, you have to use the service name as defined in the
YAML configuration. If you want to follow the logs in real time, use
<code>docker compose logs -f</code> for all the logs or <code>docker compose logs -f &lt;service-name&gt;</code>
for a given service. Hit CTRL+C to get back into the terminal.</p>
<p>To poke around in the running containers, use <code>docker compose exec</code>.
<code>docker compose exec bananas sh</code> will give you a shell inside the
container. Let’s type the <code>env</code> command to see the environment variable
<code>DEBUG</code> that we defined in the Compose file:</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb171-1"><a href="6-part2-containerizing-shiny-apps.html#cb171-1" tabindex="-1"></a><span class="ex">$</span> env</span>
<span id="cb171-2"><a href="6-part2-containerizing-shiny-apps.html#cb171-2" tabindex="-1"></a><span class="co"># HOSTNAME=4f87a297b85c</span></span>
<span id="cb171-3"><a href="6-part2-containerizing-shiny-apps.html#cb171-3" tabindex="-1"></a><span class="co"># DEBUG=1</span></span>
<span id="cb171-4"><a href="6-part2-containerizing-shiny-apps.html#cb171-4" tabindex="-1"></a><span class="co"># HOME=/home/app</span></span>
<span id="cb171-5"><a href="6-part2-containerizing-shiny-apps.html#cb171-5" tabindex="-1"></a><span class="co"># TERM=xterm</span></span>
<span id="cb171-6"><a href="6-part2-containerizing-shiny-apps.html#cb171-6" tabindex="-1"></a><span class="co"># PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span>
<span id="cb171-7"><a href="6-part2-containerizing-shiny-apps.html#cb171-7" tabindex="-1"></a><span class="co"># LANG=en_US.UTF-8</span></span>
<span id="cb171-8"><a href="6-part2-containerizing-shiny-apps.html#cb171-8" tabindex="-1"></a><span class="co"># DEBIAN_FRONTEND=noninteractive</span></span>
<span id="cb171-9"><a href="6-part2-containerizing-shiny-apps.html#cb171-9" tabindex="-1"></a><span class="co"># LC_ALL=en_US.UTF-8</span></span>
<span id="cb171-10"><a href="6-part2-containerizing-shiny-apps.html#cb171-10" tabindex="-1"></a><span class="co"># PWD=/home/app</span></span>
<span id="cb171-11"><a href="6-part2-containerizing-shiny-apps.html#cb171-11" tabindex="-1"></a><span class="co"># TZ=UTC</span></span></code></pre></div>
<p>Type <code>exit</code> to exit the shell. Now let’s suppose that you want to change
the <code>DEBUG</code> variable to <code>0</code> to turn off the debugging mode of the app.
Edit the <code>config.yaml</code> file and change the value of <code>1</code> to <code>0</code>. Save your
changes. Type <code>docker compose up -d</code> to apply the changes. This will recreate
the Bananas service:</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb172-1"><a href="6-part2-containerizing-shiny-apps.html#cb172-1" tabindex="-1"></a><span class="ex">docker</span> compose up <span class="at">-d</span></span>
<span id="cb172-2"><a href="6-part2-containerizing-shiny-apps.html#cb172-2" tabindex="-1"></a><span class="co"># [+] Running 1/2</span></span>
<span id="cb172-3"><a href="6-part2-containerizing-shiny-apps.html#cb172-3" tabindex="-1"></a><span class="co">#  ✔ Container 03-compose-faithful-1  Running              0.0s </span></span>
<span id="cb172-4"><a href="6-part2-containerizing-shiny-apps.html#cb172-4" tabindex="-1"></a><span class="co">#  ⠏ Container 03-compose-bananas-1   Recreate</span></span>
<span id="cb172-5"><a href="6-part2-containerizing-shiny-apps.html#cb172-5" tabindex="-1"></a></span>
<span id="cb172-6"><a href="6-part2-containerizing-shiny-apps.html#cb172-6" tabindex="-1"></a><span class="co"># Wait for a few seconds ...</span></span>
<span id="cb172-7"><a href="6-part2-containerizing-shiny-apps.html#cb172-7" tabindex="-1"></a></span>
<span id="cb172-8"><a href="6-part2-containerizing-shiny-apps.html#cb172-8" tabindex="-1"></a><span class="co"># [+] Running 2/2</span></span>
<span id="cb172-9"><a href="6-part2-containerizing-shiny-apps.html#cb172-9" tabindex="-1"></a><span class="co">#  ✔ Container 03-compose-faithful-1  Running                0.0s </span></span>
<span id="cb172-10"><a href="6-part2-containerizing-shiny-apps.html#cb172-10" tabindex="-1"></a><span class="co">#  ✔ Container 03-compose-bananas-1   Started               10.5s </span></span></code></pre></div>
<p>Type <code>docker compose exec bananas sh -c "env"</code> to list the environment variables.
You should see the new value <code>DEBUG=0</code>.</p>
<p>Stop the containers with <code>docker compose down</code>:</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb173-1"><a href="6-part2-containerizing-shiny-apps.html#cb173-1" tabindex="-1"></a><span class="ex">docker</span> compose down</span>
<span id="cb173-2"><a href="6-part2-containerizing-shiny-apps.html#cb173-2" tabindex="-1"></a><span class="co"># [+] Running 3/3</span></span>
<span id="cb173-3"><a href="6-part2-containerizing-shiny-apps.html#cb173-3" tabindex="-1"></a><span class="co">#  ✔ Container 03-compose-bananas-1   Removed 10.2s</span></span>
<span id="cb173-4"><a href="6-part2-containerizing-shiny-apps.html#cb173-4" tabindex="-1"></a><span class="co">#  ✔ Container 03-compose-faithful-1  Removed 0.5s</span></span>
<span id="cb173-5"><a href="6-part2-containerizing-shiny-apps.html#cb173-5" tabindex="-1"></a><span class="co">#  ✔ Network 03-compose_default       Removed 0.1s</span></span></code></pre></div>
</div>
<div id="part2-container-orchestration" class="section level3 hasAnchor" number="6.14.8">
<h3><span class="header-section-number">6.14.8</span> Container Orchestration<a href="6-part2-containerizing-shiny-apps.html#part2-container-orchestration" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Complexity does not stop at managing multiple containers. The number of
containers might not stay constant as you might to demand by scaling up and down.
You might also want to roll out new versions by causing minimal disruption in
the system. Even Docker Compose might be insufficient for
use cases at such scale. This is where container orchestration comes in.</p>
<p>Container orchestration makes this complexity manageable for development and
operations (DevOps). Container orchestration automates the provisioning,
deployment, scaling, and management of containerized applications.
It also abstracts away the underlying infrastructure.</p>
<p>Kubernetes is a widely used container orchestration platform.
Running Shiny apps with Kubernetes is an advanced topic, but all that you have
learnt about containerized application development will be useful if you ever
need to use Kubernetes for your production deployment.</p>
</div>
</div>
<div id="part2-best-practices" class="section level2 hasAnchor" number="6.15">
<h2><span class="header-section-number">6.15</span> Best Practices<a href="6-part2-containerizing-shiny-apps.html#part2-best-practices" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>No matter the use case, Docker images start with a parent image. What
parent image you use? How do you add new layers to it? These decisions
will determine how quickly you can iterate while in development, and the
size of the final image you send to production. But it is not only about your
experience, but about possible issues that may arise and security implications
that might matter even more.</p>
<p>Let’s review best practices for Dockerfiles and building images
that apply not only to containerized Shiny app
development but to any containerized application and workflow.
These will all improve the developer experience and the
quality of the final Docker images.</p>
<div id="part2-best-practices-parent-images" class="section level3 hasAnchor" number="6.15.1">
<h3><span class="header-section-number">6.15.1</span> Parent Images<a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-parent-images" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Decide which is the right parent image for the <code>FROM</code> instruction of your image.
The type of the application might dictate this, e.g. R or Python. If you have
fewer dependencies, try using a lean image variant. If you need build time
tools see if a more general and usually larger image is the best starting point.
You might still be able to strip away some fat by leveraging multi-stage builds.</p>
<p>You should also pin the version of your base image. Otherwise, using the
<code>latest</code> image tag might surprise you if you try to rebuild your image
a few years later. Although Linux systems are generally considered very robust,
best practices and the security landscape is evolving constantly. For
example, if you used <code>adduser</code> to create a new non-privileged user in your image
using Ubuntu 22.04 or earlier, it would fail on 24.04 because it has <code>useradd</code>
instead as the recommended function to use. Not a big hurdle, but the
image nevertheless would not build as is because now the <code>latest</code> tag refer to
the latest version.</p>
<p>Pinning the parent image version might also help with other dependencies as well,
e.g. in the Rocker versioned stack of images you’ll have a maximum R package
version also pinned that was available at the time of the R versioned image.</p>
</div>
<div id="part2-best-practices-minimize-deps" class="section level3 hasAnchor" number="6.15.2">
<h3><span class="header-section-number">6.15.2</span> Minimize Dependencies<a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-minimize-deps" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Minimizing dependencies is advantageous for many reasons. It results in a smaller
final image size, but more importantly, it presents smaller attack surface
for malicious actors. Smaller is usually safer. This is especially true
when the image is being used as part of client-facing applications on the
Internet. Internal tools and dev containers are less of a concern because
these cannot be accessed by the public.</p>
<p>Avoid installing “nice to have” packages and do not start from
general-purpose parent images aimed at interactive use. Images for Shiny
apps and other web services benefit from keeping the images as lean as
possible by adding only those R packages and system requirements that are
absolutely necessary. You should also uninstall unnecessary build time libraries.
Multi-stage builds can be helpful to only include artifacts that are needed.</p>
</div>
<div id="part2-best-practices-cache" class="section level3 hasAnchor" number="6.15.3">
<h3><span class="header-section-number">6.15.3</span> Cache and Order Layers<a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-cache" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When building an image, Docker executes each instruction in the order
specified in the <code>Dockerfile</code>. Docker looks for an existing image in its
cache that it can reuse, rather than creating a new (duplicate) image layer.
Only the instructions <code>RUN</code>, <code>COPY</code>, <code>ADD</code> create layers.</p>
<p>For the <code>RUN</code> instructions the command string from the <code>Dockerfile</code> is used to
find a match from an existing image. For the <code>ADD</code> and <code>COPY</code> instructions,
the contents of the file(s) in the image are examined and a checksum is
calculated for each file, however he last-modified and last-accessed times of
the file(s) are not considered in these checksums.</p>
<p>You can chain <code>RUN</code> instructions to create a single layer. This is especially
important when using <code>apt-get update &amp;&amp; apt-get install</code> so that the package
lists will be used to find the most up-to-date candidates to install.
When troubleshooting, use <code>docker run --no-cache &lt;image-name&gt;</code> to disregard the cache.</p>
<p>Caching can be useful is when installing dependencies. Here is a simplified
snippet of a <code>Dockerfile</code> to illustrate cache invalidation:</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb174-1"><a href="6-part2-containerizing-shiny-apps.html#cb174-1" tabindex="-1"></a><span class="co">## Install dependencies</span></span>
<span id="cb174-2"><a href="6-part2-containerizing-shiny-apps.html#cb174-2" tabindex="-1"></a><span class="kw">COPY</span> &lt;dependencies&gt; .</span>
<span id="cb174-3"><a href="6-part2-containerizing-shiny-apps.html#cb174-3" tabindex="-1"></a><span class="kw">RUN</span> <span class="op">&lt;</span>dependency-install-command<span class="op">&gt;</span></span>
<span id="cb174-4"><a href="6-part2-containerizing-shiny-apps.html#cb174-4" tabindex="-1"></a></span>
<span id="cb174-5"><a href="6-part2-containerizing-shiny-apps.html#cb174-5" tabindex="-1"></a><span class="co">## Copy the app</span></span>
<span id="cb174-6"><a href="6-part2-containerizing-shiny-apps.html#cb174-6" tabindex="-1"></a><span class="kw">COPY</span> app .</span></code></pre></div>
<p>What would happen if we switched the two blocks?</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb175-1"><a href="6-part2-containerizing-shiny-apps.html#cb175-1" tabindex="-1"></a><span class="co">## Copy the app and &lt;dependencies&gt;</span></span>
<span id="cb175-2"><a href="6-part2-containerizing-shiny-apps.html#cb175-2" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb175-3"><a href="6-part2-containerizing-shiny-apps.html#cb175-3" tabindex="-1"></a></span>
<span id="cb175-4"><a href="6-part2-containerizing-shiny-apps.html#cb175-4" tabindex="-1"></a><span class="co">## Install dependencies</span></span>
<span id="cb175-5"><a href="6-part2-containerizing-shiny-apps.html#cb175-5" tabindex="-1"></a><span class="kw">RUN</span> <span class="op">&lt;</span>dependency-install-command<span class="op">&gt;</span></span></code></pre></div>
<p>You would have to wait for the build to reinstall all the packages
whenever the app files have changed. This is because once the cache is
invalidated all subsequent <code>Dockerfile</code> commands generate new images
instead of using the cache.</p>
<p>In general, start with the instructions that change less frequently.
Putting your dependencies before the application source code sounds trivial.
But you might have to use parts of your code that define the dependencies
through a lock file, etc. In this case you have to copy the lock file
separately, install dependencies, then copy the rest of the source code
in another <code>COPY</code> instruction.</p>
</div>
<div id="part2-best-practices-user" class="section level3 hasAnchor" number="6.15.4">
<h3><span class="header-section-number">6.15.4</span> Switch to Non-root User<a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-user" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>By default, Docker containers run as the root user. Root privileges allow
unrestricted use which is to be avoided in production. Although you can find
lots of examples on the Internet where the container is run as root <span class="citation">(<a href="#ref-Eng_2021">Eng and Hindle 2021</a>)</span>,
this is generally considered bad practice or a “code smell”.</p>
<p>Some parent images come with a non-root user already defined. For example
some of the Rocker images have a non-privileged <code>docker</code> user that you can use.
Otherwise, create a new group and user with something like this:</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb176-1"><a href="6-part2-containerizing-shiny-apps.html#cb176-1" tabindex="-1"></a>[...]</span>
<span id="cb176-2"><a href="6-part2-containerizing-shiny-apps.html#cb176-2" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">groupadd</span> <span class="op">&lt;</span>group<span class="op">&gt;</span> <span class="kw">&amp;&amp;</span> <span class="ex">useradd</span> <span class="at">-g</span> <span class="op">&lt;</span>group<span class="op">&gt;</span> <span class="op">&lt;</span>user<span class="op">&gt;</span></span>
<span id="cb176-3"><a href="6-part2-containerizing-shiny-apps.html#cb176-3" tabindex="-1"></a><span class="kw">WORKDIR</span> /home/&lt;user&gt;</span>
<span id="cb176-4"><a href="6-part2-containerizing-shiny-apps.html#cb176-4" tabindex="-1"></a><span class="kw">COPY</span> app .</span>
<span id="cb176-5"><a href="6-part2-containerizing-shiny-apps.html#cb176-5" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">chown</span> <span class="op">&lt;</span>user<span class="op">&gt;</span>:<span class="op">&lt;</span>group<span class="op">&gt;</span> -R /home/<span class="op">&lt;</span>user<span class="op">&gt;</span></span>
<span id="cb176-6"><a href="6-part2-containerizing-shiny-apps.html#cb176-6" tabindex="-1"></a><span class="kw">USER</span> &lt;user&gt;</span>
<span id="cb176-7"><a href="6-part2-containerizing-shiny-apps.html#cb176-7" tabindex="-1"></a>[...]</span></code></pre></div>
</div>
<div id="part2-best-practices-secrets" class="section level3 hasAnchor" number="6.15.5">
<h3><span class="header-section-number">6.15.5</span> No Secrets<a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-secrets" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Avoid hard coding sensitive information into the Dockerfile or the image.
Do not set environment variables with <code>ENV</code> that store passwords or tokens.
Set these at run time with environment variables.</p>
<p>Also do not store such sensitive information in files that you copy.
Add such files to <code>.gitignore</code> and <code>.dockerignore</code> to help prevent
leaking secrets. Here is an example <code>.dockerignore</code> file that will exclude
common files used for storing secrets:</p>
<pre class="dockerignore"><code>**/.env
**/.aws
**/.ssh</code></pre>
</div>
<div id="part2-best-practices-syntax" class="section level3 hasAnchor" number="6.15.6">
<h3><span class="header-section-number">6.15.6</span> Shell vs. Exec Syntax<a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-syntax" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Use the exec array syntax for <code>CMD</code> and <code>ENTRYPOINT</code> instructions,
e.g. <code>CMD ["R", "-e", "shiny::runApp()"]</code>. This will ensure that when you
hit CTRL+C to stop the container process it will actually be signalled
properly and you won’t have to abruptly kill the container.
Use the shell syntax only for <code>RUN</code> instructions, e.g. 
<code>RUN R -e "install.packages('shiny')"</code>.</p>
</div>
<div id="part2-best-practices-log" class="section level3 hasAnchor" number="6.15.7">
<h3><span class="header-section-number">6.15.7</span> Log to STDOUT and STDERR<a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-log" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Your apps should writ logs to standard output (STDOUT) and standard error (STDERR)
instead of writing these messages to a file. This way you will be able to
use standard Docker tools for reding and collecting the logs later.</p>
</div>
<div id="part2-best-practices-healthcheck" class="section level3 hasAnchor" number="6.15.8">
<h3><span class="header-section-number">6.15.8</span> Include HEALTHCHECK<a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-healthcheck" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Use the <code>HEALTHCHECK</code> instruction to determine if the process running in your
container is “healthy” and not just up and running.</p>
</div>
<div id="part2-best-practices-version" class="section level3 hasAnchor" number="6.15.9">
<h3><span class="header-section-number">6.15.9</span> Version Your Images<a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-version" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Use timestamps, Git commit hashes, or semantic versioning for your image tags,
or a combination of these. You can avoid overwriting existing images and will
be able to roll back changes when you send some bugs into production.
You can automate this using GitHub actions as you’ll see later.</p>
</div>
<div id="part2-best-practices-readability" class="section level3 hasAnchor" number="6.15.10">
<h3><span class="header-section-number">6.15.10</span> Readability<a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-readability" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Chain commands in your <code>RUN</code> instructions and sort multiline arguments using <code>\</code>.
This will also help in updating your Dockerfile and track the changes with Git.
The difference will be only a line instead of the whole statement.</p>
</div>
<div id="part2-best-practices-tips" class="section level3 hasAnchor" number="6.15.11">
<h3><span class="header-section-number">6.15.11</span> More Tips<a href="6-part2-containerizing-shiny-apps.html#part2-best-practices-tips" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Linters, like Hadolint use many more rules for Dockerfiles that are worth consulting
as an extension of this best practices list. Hadolint is also available as a
VS Code extension. Here are some other resources that are worth checking out
to improve your Dockerfiles and Docker images, and to secure your containerized
applications:</p>
<ul>
<li><a href="https://docs.docker.com/build/building/best-practices/">Building best practices by Docker</a></li>
<li><a href="https://github.com/hadolint/hadolint#rules">Hadolint rules</a></li>
</ul>
</div>
</div>
<div id="summary-5" class="section level2 hasAnchor" number="6.16">
<h2><span class="header-section-number">6.16</span> Summary<a href="6-part2-containerizing-shiny-apps.html#summary-5" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The use of Docker with other open source software such as R nd Python has been
transformative over the past decade <span class="citation">(<a href="#ref-rocker">Boettiger and Eddelbuettel 2017</a>; <a href="#ref-Rockerverse">Nüst et al. 2020</a>; <a href="#ref-Eng_2021">Eng and Hindle 2021</a>)</span>.
You can find examples for almost anything ranging from interactive data science
to asychronous APIs in Kubernetes.</p>
<p>With the newfound ability to wrap any Shiny app in a Docker container,
you’ll be able to deploy these images to many different hosting
platforms. Of course, there is a lot more to learn, e.g. about handling
dependencies, persisting data across sessions and containers, and so on.
We’ll cover these use cases in due time. Until then, celebrate this
milestone, check out further readings, and try to containerize some of
your own Shiny apps.</p>
<p>You can also share Docker images with others. This, however, will require the
recipient of your app to have Docker installed and be able to run it locally.</p>
<p>In the next Part, we’ll cover options for hosting your app, so that others
will only need a browser to be able to access it. No R, Python, or Docker
runtime environment is needed on the user’s part. Hosting the app for your
users will also be the preferred option in case you do not want to share
the source code or the Docker image with the users.</p>
<p>Further reading:</p>
<ul>
<li><a href="https://docs.docker.com/glossary/">Docker glossary</a></li>
<li><a href="https://docs.docker.com/reference/">Docker reference</a></li>
<li><a href="https://docs.docker.com/compose/">Docker Compose</a></li>
</ul>

</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-rocker" class="csl-entry">
Boettiger, Carl, and Dirk Eddelbuettel. 2017. <span>“<span class="nocase">An Introduction to Rocker: Docker Containers for R</span>.”</span> <em><span>The R Journal</span></em> 9 (2): 527–36. <a href="https://doi.org/10.32614/RJ-2017-065">https://doi.org/10.32614/RJ-2017-065</a>.
</div>
<div id="ref-R-pak" class="csl-entry">
Csárdi, Gábor, and Jim Hester. 2024. <em>Pak: Another Approach to Package Installation</em>. <a href="https://CRAN.R-project.org/package=pak">https://CRAN.R-project.org/package=pak</a>.
</div>
<div id="ref-R-remotes" class="csl-entry">
Csárdi, Gábor, Jim Hester, Hadley Wickham, Winston Chang, Martin Morgan, and Dan Tenenbaum. 2024. <em>Remotes: R Package Installation from Remote Repositories, Including ’GitHub’</em>. <a href="https://CRAN.R-project.org/package=remotes">https://CRAN.R-project.org/package=remotes</a>.
</div>
<div id="ref-R-littler" class="csl-entry">
Eddelbuettel, Dirk, and Jeff Horner. 2024. <em>Littler: R at the Command-Line via ’r’</em>. <a href="https://CRAN.R-project.org/package=littler">https://CRAN.R-project.org/package=littler</a>.
</div>
<div id="ref-Eng_2021" class="csl-entry">
Eng, Kalvin, and Abram Hindle. 2021. <span>“Revisiting Dockerfiles in Open Source Software over Time.”</span> In <em>2021 IEEE/ACM 18th International Conference on Mining Software Repositories (MSR)</em>, 449–59. <a href="https://doi.org/10.1109/MSR52588.2021.00057">https://doi.org/10.1109/MSR52588.2021.00057</a>.
</div>
<div id="ref-Rockerverse" class="csl-entry">
Nüst, Daniel, Dirk Eddelbuettel, Dom Bennett, Robrecht Cannoodt, Dav Clark, Gergely Daróczi, Mark Edmondson, et al. 2020. <span>“<span class="nocase">The Rockerverse: Packages and Applications for Containerisation with R</span>.”</span> <em><span>The R Journal</span></em> 12 (1): 437–61. <a href="https://doi.org/10.32614/RJ-2020-007">https://doi.org/10.32614/RJ-2020-007</a>.
</div>
<div id="ref-R-curl" class="csl-entry">
Ooms, Jeroen. 2024. <em>Curl: A Modern and Flexible Web Client for r</em>. <a href="https://CRAN.R-project.org/package=curl">https://CRAN.R-project.org/package=curl</a>.
</div>
<div id="ref-Rodrigues2023" class="csl-entry">
Rodrigues, Bruno. 2023. <em>Building Reproducible Analytical Pipelines with <span>R</span></em>. <a href="https://raps-with-r.dev/">https://raps-with-r.dev/</a>.
</div>
<div id="ref-R-deps" class="csl-entry">
Sólymos, Péter. 2024. <em>Deps: Dependency Management with ’Roxygen’-Style Comments</em>. <a href="https://hub.analythium.io/deps/">https://hub.analythium.io/deps/</a>.
</div>
<div id="ref-R-Cairo" class="csl-entry">
Urbanek, Simon, and Jeffrey Horner. 2023. <em>Cairo: R Graphics Device Using Cairo Graphics Library for Creating High-Quality Bitmap (PNG, JPEG, TIFF), Vector (PDF, SVG, PostScript) and Display (X11 and Win32) Output</em>. <a href="https://CRAN.R-project.org/package=Cairo">https://CRAN.R-project.org/package=Cairo</a>.
</div>
<div id="ref-R-renv" class="csl-entry">
Ushey, Kevin, and Hadley Wickham. 2024. <em>Renv: Project Environments</em>. <a href="https://CRAN.R-project.org/package=renv">https://CRAN.R-project.org/package=renv</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="5-part2-developing-shiny-apps.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/analythium/hosting-shiny-book/edit/main/02-02-a-containerizing-shiny.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

</body>

</html>
